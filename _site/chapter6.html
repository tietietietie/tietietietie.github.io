<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>社区论坛：ElasticSearch</title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="社区论坛：ElasticSearch" />
<meta name="author" content="tie" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chapter 6 Elasticsearch入门 简介 分布式，Restful风格（对http协议进行格式规定） 对各种类型的数据都可以检索 速度快，实时（搜索过程：提交数据 —&gt; 搜索引擎建立索引 —&gt; 搜索）（能在前两步实时） 便于扩展，PB级（因为是分布式） 术语 ES可以看成特殊的数据库，因为ES里面要保存一份数据，所以有：索引（数据库database），类型（表table），文档（行row），字段（列column）等术语。在ES6.0以后，废弃类型，索引逐渐对应一张表 集群，节点，分片（一个索引（表）的进一步划分，并发能力提高），副本（对分片的备份） 安装/使用 ES，最好安装和Spring Boot一致的版本号 中文分词插件，在elasticsearch下的plugin文件新建ik文件夹，在此解压缩，想要新增分词，可以在config目录下的对应配置文件。 postman能够存数据/搜索数据，而不用自己写很长的一串命令 启动ES 在Bin里面点击相应bat文件即可 Spring整合ES 引入依赖 配置文件 使用Spring的API，ElasticsearchTemplate或者ElasticsearchRepository（接口方式）。 引入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt; &lt;/dependency&gt; 配置文件 #ElasticsearchProperties spring.data.elasticsearch.cluster-name=nowcoder spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300 演示ElasticsearchRepository 1，对需要搜索的数据（文档）注释 @Document(indexName = &quot;discusspost&quot;, type = &quot;_doc&quot;, shards = 6, replicas = 3) public class DiscussPost { @Id private int id; @Field(type = FieldType.Integer) private int userId; //互联网招聘 尽可能地拆分更多关键词，从而增加搜索范围 @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String title; @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String content; @Field(type = FieldType.Integer) private int type; @Field(type = FieldType.Integer) private int status; @Field(type = FieldType.Date) private Date createTime; @Field(type = FieldType.Integer) private int commentCount; @Field(type = FieldType.Double) private double score; 2.在DAO数据层从定义接口 @Repository public interface DiscussPostRepository extends ElasticsearchRepository&lt;DiscussPost, Integer&gt; { } 3.演示如何使用repository和template来插入数据，搜素数据 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ElasticsearchTest { //数据来源是Mysql @Autowired private DiscussPostMapper discussMapper; @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; //往ES中添加数据 @Test public void testInsert() { discussRepository.save(discussMapper.selectDiscussPostById(241)); discussRepository.save(discussMapper.selectDiscussPostById(242)); discussRepository.save(discussMapper.selectDiscussPostById(243)); } //插入多条数据 @Test public void testInsertList() { discussRepository.saveAll(discussMapper.selectDiscussPosts(101, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(102, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(103, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(111, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(112, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(131, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(132, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(133, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(134, 0, 100)); } //数据修改 @Test public void testUpdate() { DiscussPost post = discussMapper.selectDiscussPostById(231); post.setContent(&quot;我是新人，哈哈哈哈哈哈哈&quot;); discussRepository.save(post); } //数据删除 //略 //搜索 @Test public void testSearchByRepository() { //排序，分页，高亮显示 //文本显示在网页的时候，需要加样式 SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); //两份数据，底层获取到了高亮显示的值，但是没有处理 //所以没有高亮数据 //所以不如直接template Page&lt;DiscussPost&gt; page = discussRepository.search(searchQuery); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } //template搜素（repository底层起始就是调用template，但是不能返回带标签的结果，需要我们自己来定义一个SearchResultMapper @Test public void testSearchByTemplate() { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } } 开发搜索功能 分为以下三个功能 搜索服务 保存帖子/删除帖子/搜索帖子 发布事件 发布帖子时，异步的将帖子移交到ES服务器 增加评论时，异步的将帖子移交到ES服务器 在消费组件增加一个方法，消费帖子 显示结果 服务层 使用之前discussRepository的代码,实现帖子的增加/删除/搜索 @Service public class ElasticsearchService { @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; public void saveDiscussPost(DiscussPost post) { discussRepository.save(post); } public void deleteDiscussPost(int id) { discussRepository.deleteById(id); } public Page&lt;DiscussPost&gt; searchDiscussPost(String keyword, int current, int limit) { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(keyword, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(current, limit)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); return page; } } 控制层 在commentController和discussPostController中激活事务，在eventConsumer中统一的更新ES数据库的帖子数据。 //消费发帖事件 @KafkaListener(topics = {TOPIC_PUBLISH}) public void handlePublishMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId()); elasticsearchService.saveDiscussPost(post); } 新建searchController，对搜索到的帖子进行封装 //路径后面带问号传 @RequestMapping(path = &quot;/search&quot;, method = RequestMethod.GET) public String search(String keyword, Page page, Model model) { //搜索帖子 org.springframework.data.domain.Page&lt;DiscussPost&gt; searchResults = elasticsearchService.searchDiscussPost(keyword, page.getCurrent() - 1, page.getLimit()); //聚合数据 List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); if (searchResults != null) { for (DiscussPost post : searchResults) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); map.put(&quot;user&quot;, userService.findUserById(post.getUserId())); map.put(&quot;likeCount&quot;, likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId())); discussPosts.add(map); } } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;keyword&quot;, keyword); //实现分页 page.setPath(&quot;/search?keyword=&quot; + keyword); page.setRows(searchResults == null ? 0 : (int) searchResults.getTotalElements()); return &quot;/site/search&quot;; } }" />
<meta property="og:description" content="Chapter 6 Elasticsearch入门 简介 分布式，Restful风格（对http协议进行格式规定） 对各种类型的数据都可以检索 速度快，实时（搜索过程：提交数据 —&gt; 搜索引擎建立索引 —&gt; 搜索）（能在前两步实时） 便于扩展，PB级（因为是分布式） 术语 ES可以看成特殊的数据库，因为ES里面要保存一份数据，所以有：索引（数据库database），类型（表table），文档（行row），字段（列column）等术语。在ES6.0以后，废弃类型，索引逐渐对应一张表 集群，节点，分片（一个索引（表）的进一步划分，并发能力提高），副本（对分片的备份） 安装/使用 ES，最好安装和Spring Boot一致的版本号 中文分词插件，在elasticsearch下的plugin文件新建ik文件夹，在此解压缩，想要新增分词，可以在config目录下的对应配置文件。 postman能够存数据/搜索数据，而不用自己写很长的一串命令 启动ES 在Bin里面点击相应bat文件即可 Spring整合ES 引入依赖 配置文件 使用Spring的API，ElasticsearchTemplate或者ElasticsearchRepository（接口方式）。 引入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt; &lt;/dependency&gt; 配置文件 #ElasticsearchProperties spring.data.elasticsearch.cluster-name=nowcoder spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300 演示ElasticsearchRepository 1，对需要搜索的数据（文档）注释 @Document(indexName = &quot;discusspost&quot;, type = &quot;_doc&quot;, shards = 6, replicas = 3) public class DiscussPost { @Id private int id; @Field(type = FieldType.Integer) private int userId; //互联网招聘 尽可能地拆分更多关键词，从而增加搜索范围 @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String title; @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String content; @Field(type = FieldType.Integer) private int type; @Field(type = FieldType.Integer) private int status; @Field(type = FieldType.Date) private Date createTime; @Field(type = FieldType.Integer) private int commentCount; @Field(type = FieldType.Double) private double score; 2.在DAO数据层从定义接口 @Repository public interface DiscussPostRepository extends ElasticsearchRepository&lt;DiscussPost, Integer&gt; { } 3.演示如何使用repository和template来插入数据，搜素数据 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ElasticsearchTest { //数据来源是Mysql @Autowired private DiscussPostMapper discussMapper; @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; //往ES中添加数据 @Test public void testInsert() { discussRepository.save(discussMapper.selectDiscussPostById(241)); discussRepository.save(discussMapper.selectDiscussPostById(242)); discussRepository.save(discussMapper.selectDiscussPostById(243)); } //插入多条数据 @Test public void testInsertList() { discussRepository.saveAll(discussMapper.selectDiscussPosts(101, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(102, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(103, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(111, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(112, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(131, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(132, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(133, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(134, 0, 100)); } //数据修改 @Test public void testUpdate() { DiscussPost post = discussMapper.selectDiscussPostById(231); post.setContent(&quot;我是新人，哈哈哈哈哈哈哈&quot;); discussRepository.save(post); } //数据删除 //略 //搜索 @Test public void testSearchByRepository() { //排序，分页，高亮显示 //文本显示在网页的时候，需要加样式 SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); //两份数据，底层获取到了高亮显示的值，但是没有处理 //所以没有高亮数据 //所以不如直接template Page&lt;DiscussPost&gt; page = discussRepository.search(searchQuery); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } //template搜素（repository底层起始就是调用template，但是不能返回带标签的结果，需要我们自己来定义一个SearchResultMapper @Test public void testSearchByTemplate() { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } } 开发搜索功能 分为以下三个功能 搜索服务 保存帖子/删除帖子/搜索帖子 发布事件 发布帖子时，异步的将帖子移交到ES服务器 增加评论时，异步的将帖子移交到ES服务器 在消费组件增加一个方法，消费帖子 显示结果 服务层 使用之前discussRepository的代码,实现帖子的增加/删除/搜索 @Service public class ElasticsearchService { @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; public void saveDiscussPost(DiscussPost post) { discussRepository.save(post); } public void deleteDiscussPost(int id) { discussRepository.deleteById(id); } public Page&lt;DiscussPost&gt; searchDiscussPost(String keyword, int current, int limit) { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(keyword, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(current, limit)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); return page; } } 控制层 在commentController和discussPostController中激活事务，在eventConsumer中统一的更新ES数据库的帖子数据。 //消费发帖事件 @KafkaListener(topics = {TOPIC_PUBLISH}) public void handlePublishMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId()); elasticsearchService.saveDiscussPost(post); } 新建searchController，对搜索到的帖子进行封装 //路径后面带问号传 @RequestMapping(path = &quot;/search&quot;, method = RequestMethod.GET) public String search(String keyword, Page page, Model model) { //搜索帖子 org.springframework.data.domain.Page&lt;DiscussPost&gt; searchResults = elasticsearchService.searchDiscussPost(keyword, page.getCurrent() - 1, page.getLimit()); //聚合数据 List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); if (searchResults != null) { for (DiscussPost post : searchResults) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); map.put(&quot;user&quot;, userService.findUserById(post.getUserId())); map.put(&quot;likeCount&quot;, likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId())); discussPosts.add(map); } } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;keyword&quot;, keyword); //实现分页 page.setPath(&quot;/search?keyword=&quot; + keyword); page.setRows(searchResults == null ? 0 : (int) searchResults.getTotalElements()); return &quot;/site/search&quot;; } }" />
<link rel="canonical" href="https://github.com/tietietietie/tietietietie.github.io/chapter6.html" />
<meta property="og:url" content="https://github.com/tietietietie/tietietietie.github.io/chapter6.html" />
<meta property="og:site_name" content="tie’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-07T06:51:00+08:00" />
<script type="application/ld+json">
{"url":"https://github.com/tietietietie/tietietietie.github.io/chapter6.html","headline":"社区论坛：ElasticSearch","dateModified":"2020-07-07T06:51:00+08:00","datePublished":"2020-07-07T06:51:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/tietietietie/tietietietie.github.io/chapter6.html"},"author":{"@type":"Person","name":"tie"},"description":"Chapter 6 Elasticsearch入门 简介 分布式，Restful风格（对http协议进行格式规定） 对各种类型的数据都可以检索 速度快，实时（搜索过程：提交数据 —&gt; 搜索引擎建立索引 —&gt; 搜索）（能在前两步实时） 便于扩展，PB级（因为是分布式） 术语 ES可以看成特殊的数据库，因为ES里面要保存一份数据，所以有：索引（数据库database），类型（表table），文档（行row），字段（列column）等术语。在ES6.0以后，废弃类型，索引逐渐对应一张表 集群，节点，分片（一个索引（表）的进一步划分，并发能力提高），副本（对分片的备份） 安装/使用 ES，最好安装和Spring Boot一致的版本号 中文分词插件，在elasticsearch下的plugin文件新建ik文件夹，在此解压缩，想要新增分词，可以在config目录下的对应配置文件。 postman能够存数据/搜索数据，而不用自己写很长的一串命令 启动ES 在Bin里面点击相应bat文件即可 Spring整合ES 引入依赖 配置文件 使用Spring的API，ElasticsearchTemplate或者ElasticsearchRepository（接口方式）。 引入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt; &lt;/dependency&gt; 配置文件 #ElasticsearchProperties spring.data.elasticsearch.cluster-name=nowcoder spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300 演示ElasticsearchRepository 1，对需要搜索的数据（文档）注释 @Document(indexName = &quot;discusspost&quot;, type = &quot;_doc&quot;, shards = 6, replicas = 3) public class DiscussPost { @Id private int id; @Field(type = FieldType.Integer) private int userId; //互联网招聘 尽可能地拆分更多关键词，从而增加搜索范围 @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String title; @Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;) private String content; @Field(type = FieldType.Integer) private int type; @Field(type = FieldType.Integer) private int status; @Field(type = FieldType.Date) private Date createTime; @Field(type = FieldType.Integer) private int commentCount; @Field(type = FieldType.Double) private double score; 2.在DAO数据层从定义接口 @Repository public interface DiscussPostRepository extends ElasticsearchRepository&lt;DiscussPost, Integer&gt; { } 3.演示如何使用repository和template来插入数据，搜素数据 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ElasticsearchTest { //数据来源是Mysql @Autowired private DiscussPostMapper discussMapper; @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; //往ES中添加数据 @Test public void testInsert() { discussRepository.save(discussMapper.selectDiscussPostById(241)); discussRepository.save(discussMapper.selectDiscussPostById(242)); discussRepository.save(discussMapper.selectDiscussPostById(243)); } //插入多条数据 @Test public void testInsertList() { discussRepository.saveAll(discussMapper.selectDiscussPosts(101, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(102, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(103, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(111, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(112, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(131, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(132, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(133, 0, 100)); discussRepository.saveAll(discussMapper.selectDiscussPosts(134, 0, 100)); } //数据修改 @Test public void testUpdate() { DiscussPost post = discussMapper.selectDiscussPostById(231); post.setContent(&quot;我是新人，哈哈哈哈哈哈哈&quot;); discussRepository.save(post); } //数据删除 //略 //搜索 @Test public void testSearchByRepository() { //排序，分页，高亮显示 //文本显示在网页的时候，需要加样式 SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); //两份数据，底层获取到了高亮显示的值，但是没有处理 //所以没有高亮数据 //所以不如直接template Page&lt;DiscussPost&gt; page = discussRepository.search(searchQuery); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } //template搜素（repository底层起始就是调用template，但是不能返回带标签的结果，需要我们自己来定义一个SearchResultMapper @Test public void testSearchByTemplate() { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(&quot;互联网寒冬&quot;, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(0, 10)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); System.out.println(page.getTotalElements()); System.out.println(page.getTotalPages()); System.out.println(page.getNumber()); System.out.println(page.getSize()); for (DiscussPost post : page) { System.out.println(post); } } } 开发搜索功能 分为以下三个功能 搜索服务 保存帖子/删除帖子/搜索帖子 发布事件 发布帖子时，异步的将帖子移交到ES服务器 增加评论时，异步的将帖子移交到ES服务器 在消费组件增加一个方法，消费帖子 显示结果 服务层 使用之前discussRepository的代码,实现帖子的增加/删除/搜索 @Service public class ElasticsearchService { @Autowired private DiscussPostRepository discussRepository; @Autowired private ElasticsearchTemplate elasticTemplate; public void saveDiscussPost(DiscussPost post) { discussRepository.save(post); } public void deleteDiscussPost(int id) { discussRepository.deleteById(id); } public Page&lt;DiscussPost&gt; searchDiscussPost(String keyword, int current, int limit) { SearchQuery searchQuery = new NativeSearchQueryBuilder() .withQuery(QueryBuilders.multiMatchQuery(keyword, &quot;title&quot;, &quot;content&quot;)) .withSort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC)) .withSort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC)) .withPageable(PageRequest.of(current, limit)) .withHighlightFields( new HighlightBuilder.Field(&quot;title&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;), new HighlightBuilder.Field(&quot;content&quot;).preTags(&quot;&lt;em&gt;&quot;).postTags(&quot;&lt;/em&gt;&quot;) ).build(); Page&lt;DiscussPost&gt; page = elasticTemplate.queryForPage(searchQuery, DiscussPost.class, new SearchResultMapper() { @Override public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable) { SearchHits hits = response.getHits(); if (hits.getTotalHits() &lt;= 0) { return null; } List&lt;DiscussPost&gt; list = new ArrayList&lt;&gt;(); for (SearchHit hit : hits) { DiscussPost post = new DiscussPost(); String id = hit.getSourceAsMap().get(&quot;id&quot;).toString(); post.setId(Integer.valueOf(id)); String userId = hit.getSourceAsMap().get(&quot;userId&quot;).toString(); post.setUserId(Integer.valueOf(userId)); String title = hit.getSourceAsMap().get(&quot;title&quot;).toString(); post.setTitle(title); String content = hit.getSourceAsMap().get(&quot;content&quot;).toString(); post.setContent(content); String status = hit.getSourceAsMap().get(&quot;status&quot;).toString(); post.setStatus(Integer.valueOf(status)); String createTime = hit.getSourceAsMap().get(&quot;createTime&quot;).toString(); post.setCreateTime(new Date(Long.valueOf(createTime))); String commentCount = hit.getSourceAsMap().get(&quot;commentCount&quot;).toString(); post.setCommentCount(Integer.valueOf(commentCount)); // 处理高亮显示的结果,返回的只是匹配到的一小段 HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;); if (titleField != null) { post.setTitle(titleField.getFragments()[0].toString()); } HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;); if (contentField != null) { post.setContent(contentField.getFragments()[0].toString()); } list.add(post); } return new AggregatedPageImpl(list, pageable, hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore()) { }; } @Override public &lt;T&gt; T mapSearchHit(SearchHit searchHit, Class&lt;T&gt; aClass) { return null; } }); return page; } } 控制层 在commentController和discussPostController中激活事务，在eventConsumer中统一的更新ES数据库的帖子数据。 //消费发帖事件 @KafkaListener(topics = {TOPIC_PUBLISH}) public void handlePublishMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId()); elasticsearchService.saveDiscussPost(post); } 新建searchController，对搜索到的帖子进行封装 //路径后面带问号传 @RequestMapping(path = &quot;/search&quot;, method = RequestMethod.GET) public String search(String keyword, Page page, Model model) { //搜索帖子 org.springframework.data.domain.Page&lt;DiscussPost&gt; searchResults = elasticsearchService.searchDiscussPost(keyword, page.getCurrent() - 1, page.getLimit()); //聚合数据 List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); if (searchResults != null) { for (DiscussPost post : searchResults) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); map.put(&quot;user&quot;, userService.findUserById(post.getUserId())); map.put(&quot;likeCount&quot;, likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId())); discussPosts.add(map); } } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;keyword&quot;, keyword); //实现分页 page.setPath(&quot;/search?keyword=&quot; + keyword); page.setRows(searchResults == null ? 0 : (int) searchResults.getTotalElements()); return &quot;/site/search&quot;; } }","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://github.com/tietietietie/tietietietie.github.io/feed.xml" title="tie's blog" />

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a>

<article>
  <p class="post-meta">
    <time datetime="2020-07-07 06:51:00 +0800">2020-07-07</time>
  </p>
  
  <h1>社区论坛：ElasticSearch</h1>

  <h1 id="chapter-6">Chapter 6</h1>

<h2 id="elasticsearch入门">Elasticsearch入门</h2>

<h3 id="简介">简介</h3>

<ul>
  <li>分布式，Restful风格（对http协议进行格式规定）</li>
  <li>对各种类型的数据都可以检索</li>
  <li>速度快，实时（搜索过程：提交数据 —&gt; 搜索引擎建立索引 —&gt; 搜索）（能在前两步实时）</li>
  <li>便于扩展，PB级（因为是分布式）</li>
</ul>

<h3 id="术语">术语</h3>

<ul>
  <li>ES可以看成特殊的数据库，因为ES里面要保存一份数据，所以有：索引（数据库database），类型（表table），文档（行row），字段（列column）等术语。在ES6.0以后，废弃类型，索引逐渐对应一张表</li>
  <li>集群，节点，分片（一个索引（表）的进一步划分，并发能力提高），副本（对分片的备份）</li>
</ul>

<h3 id="安装使用">安装/使用</h3>

<ul>
  <li>
    <p>ES，最好安装和Spring Boot一致的版本号</p>
  </li>
  <li>
    <p>中文分词插件，在elasticsearch下的plugin文件新建ik文件夹，在此解压缩，想要新增分词，可以在config目录下的对应配置文件。</p>
  </li>
  <li>
    <p>postman能够存数据/搜索数据，而不用自己写很长的一串命令</p>
  </li>
</ul>

<h4 id="启动es">启动ES</h4>

<p>在Bin里面点击相应bat文件即可</p>

<h2 id="spring整合es">Spring整合ES</h2>

<ul>
  <li>引入依赖</li>
  <li>配置文件</li>
  <li>使用Spring的API，ElasticsearchTemplate或者ElasticsearchRepository（接口方式）。</li>
</ul>

<h3 id="引入依赖">引入依赖</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h3 id="配置文件">配置文件</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#ElasticsearchProperties
spring.data.elasticsearch.cluster-name=nowcoder
spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300
</code></pre></div></div>

<h3 id="演示elasticsearchrepository">演示ElasticsearchRepository</h3>

<p>1，对需要搜索的数据（文档）注释</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Document</span><span class="o">(</span><span class="n">indexName</span> <span class="o">=</span> <span class="s">"discusspost"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">"_doc"</span><span class="o">,</span> <span class="n">shards</span> <span class="o">=</span> <span class="mi">6</span><span class="o">,</span> <span class="n">replicas</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DiscussPost</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Integer</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">;</span>
    <span class="c1">//互联网招聘  尽可能地拆分更多关键词，从而增加搜索范围</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="n">analyzer</span> <span class="o">=</span> <span class="s">"ik_max_word"</span><span class="o">,</span> <span class="n">searchAnalyzer</span> <span class="o">=</span> <span class="s">"ik_smart"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Text</span><span class="o">,</span> <span class="n">analyzer</span> <span class="o">=</span> <span class="s">"ik_max_word"</span><span class="o">,</span> <span class="n">searchAnalyzer</span> <span class="o">=</span> <span class="s">"ik_smart"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Integer</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">type</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Integer</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Date</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Integer</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">commentCount</span><span class="o">;</span>
    <span class="nd">@Field</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FieldType</span><span class="o">.</span><span class="na">Double</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">score</span><span class="o">;</span>
</code></pre></div></div>

<p>2.在DAO数据层从定义接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DiscussPostRepository</span> <span class="kd">extends</span> <span class="nc">ElasticsearchRepository</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3.演示如何使用repository和template来插入数据，搜素数据</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">CommunityApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticsearchTest</span> <span class="o">{</span>
    <span class="c1">//数据来源是Mysql</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DiscussPostMapper</span> <span class="n">discussMapper</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DiscussPostRepository</span> <span class="n">discussRepository</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ElasticsearchTemplate</span> <span class="n">elasticTemplate</span><span class="o">;</span>

    <span class="c1">//往ES中添加数据</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInsert</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPostById</span><span class="o">(</span><span class="mi">241</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPostById</span><span class="o">(</span><span class="mi">242</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPostById</span><span class="o">(</span><span class="mi">243</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">//插入多条数据</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInsertList</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">103</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">111</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">112</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">131</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">132</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">133</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">134</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">//数据修改</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUpdate</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="n">discussMapper</span><span class="o">.</span><span class="na">selectDiscussPostById</span><span class="o">(</span><span class="mi">231</span><span class="o">);</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"我是新人，哈哈哈哈哈哈哈"</span><span class="o">);</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//数据删除</span>
    <span class="c1">//略</span>

    <span class="c1">//搜索</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSearchByRepository</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//排序，分页，高亮显示</span>
        <span class="c1">//文本显示在网页的时候，需要加样式</span>
        <span class="nc">SearchQuery</span> <span class="n">searchQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NativeSearchQueryBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="nc">QueryBuilders</span><span class="o">.</span><span class="na">multiMatchQuery</span><span class="o">(</span><span class="s">"互联网寒冬"</span><span class="o">,</span> <span class="s">"title"</span><span class="o">,</span> <span class="s">"content"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"score"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"createTime"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withPageable</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withHighlightFields</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">)</span>
                <span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="c1">//两份数据，底层获取到了高亮显示的值，但是没有处理</span>
        <span class="c1">//所以没有高亮数据</span>
        <span class="c1">//所以不如直接template</span>
        <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">discussRepository</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchQuery</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getNumber</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getSize</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">:</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
	<span class="c1">//template搜素（repository底层起始就是调用template，但是不能返回带标签的结果，需要我们自己来定义一个SearchResultMapper</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSearchByTemplate</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SearchQuery</span> <span class="n">searchQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NativeSearchQueryBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="nc">QueryBuilders</span><span class="o">.</span><span class="na">multiMatchQuery</span><span class="o">(</span><span class="s">"互联网寒冬"</span><span class="o">,</span> <span class="s">"title"</span><span class="o">,</span> <span class="s">"content"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"score"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"createTime"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withPageable</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withHighlightFields</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">)</span>
                <span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">elasticTemplate</span><span class="o">.</span><span class="na">queryForPage</span><span class="o">(</span><span class="n">searchQuery</span><span class="o">,</span> <span class="nc">DiscussPost</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SearchResultMapper</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">AggregatedPage</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">mapResults</span><span class="o">(</span><span class="nc">SearchResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">aClass</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">SearchHits</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">hits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>

                    <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"userId"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>

                    <span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>

                    <span class="nc">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">status</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">createTime</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"createTime"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">createTime</span><span class="o">)));</span>

                    <span class="nc">String</span> <span class="n">commentCount</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"commentCount"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setCommentCount</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">commentCount</span><span class="o">));</span>

                    <span class="c1">// 处理高亮显示的结果,返回的只是匹配到的一小段</span>
                    <span class="nc">HighlightField</span> <span class="n">titleField</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">titleField</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">titleField</span><span class="o">.</span><span class="na">getFragments</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nc">HighlightField</span> <span class="n">contentField</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"content"</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">contentField</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">contentField</span><span class="o">.</span><span class="na">getFragments</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="k">new</span> <span class="nf">AggregatedPageImpl</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">hits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">(),</span> <span class="n">hits</span><span class="o">.</span><span class="na">getMaxScore</span><span class="o">())</span> <span class="o">{</span>
                <span class="o">};</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">mapSearchHit</span><span class="o">(</span><span class="nc">SearchHit</span> <span class="n">searchHit</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getNumber</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getSize</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">:</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="开发搜索功能">开发搜索功能</h2>

<p>分为以下三个功能</p>

<ul>
  <li>搜索服务
    <ul>
      <li>保存帖子/删除帖子/搜索帖子</li>
    </ul>
  </li>
  <li>发布事件
    <ul>
      <li>发布帖子时，异步的将帖子移交到ES服务器</li>
      <li>增加评论时，异步的将帖子移交到ES服务器</li>
      <li>在消费组件增加一个方法，消费帖子</li>
    </ul>
  </li>
  <li>显示结果</li>
</ul>

<h3 id="服务层">服务层</h3>

<p>使用之前discussRepository的代码,实现帖子的增加/删除/搜索</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticsearchService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DiscussPostRepository</span> <span class="n">discussRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ElasticsearchTemplate</span> <span class="n">elasticTemplate</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveDiscussPost</span><span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteDiscussPost</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">discussRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="nf">searchDiscussPost</span><span class="o">(</span><span class="nc">String</span> <span class="n">keyword</span><span class="o">,</span> <span class="kt">int</span> <span class="n">current</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SearchQuery</span> <span class="n">searchQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NativeSearchQueryBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withQuery</span><span class="o">(</span><span class="nc">QueryBuilders</span><span class="o">.</span><span class="na">multiMatchQuery</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="s">"title"</span><span class="o">,</span> <span class="s">"content"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"score"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withSort</span><span class="o">(</span><span class="nc">SortBuilders</span><span class="o">.</span><span class="na">fieldSort</span><span class="o">(</span><span class="s">"createTime"</span><span class="o">).</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withPageable</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">limit</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withHighlightFields</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">),</span>
                        <span class="k">new</span> <span class="nc">HighlightBuilder</span><span class="o">.</span><span class="na">Field</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">preTags</span><span class="o">(</span><span class="s">"&lt;em&gt;"</span><span class="o">).</span><span class="na">postTags</span><span class="o">(</span><span class="s">"&lt;/em&gt;"</span><span class="o">)</span>
                <span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">elasticTemplate</span><span class="o">.</span><span class="na">queryForPage</span><span class="o">(</span><span class="n">searchQuery</span><span class="o">,</span> <span class="nc">DiscussPost</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SearchResultMapper</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">AggregatedPage</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">mapResults</span><span class="o">(</span><span class="nc">SearchResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">aClass</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">SearchHits</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">hits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>

                    <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"userId"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>

                    <span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>

                    <span class="nc">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">status</span><span class="o">));</span>

                    <span class="nc">String</span> <span class="n">createTime</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"createTime"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">createTime</span><span class="o">)));</span>

                    <span class="nc">String</span> <span class="n">commentCount</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"commentCount"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
                    <span class="n">post</span><span class="o">.</span><span class="na">setCommentCount</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">commentCount</span><span class="o">));</span>

                    <span class="c1">// 处理高亮显示的结果,返回的只是匹配到的一小段</span>
                    <span class="nc">HighlightField</span> <span class="n">titleField</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"title"</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">titleField</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">titleField</span><span class="o">.</span><span class="na">getFragments</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nc">HighlightField</span> <span class="n">contentField</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"content"</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">contentField</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">contentField</span><span class="o">.</span><span class="na">getFragments</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="k">new</span> <span class="nf">AggregatedPageImpl</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">hits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">(),</span> <span class="n">hits</span><span class="o">.</span><span class="na">getMaxScore</span><span class="o">())</span> <span class="o">{</span>
                <span class="o">};</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">mapSearchHit</span><span class="o">(</span><span class="nc">SearchHit</span> <span class="n">searchHit</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="控制层">控制层</h3>

<p>在commentController和discussPostController中激活事务，在eventConsumer中统一的更新ES数据库的帖子数据。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//消费发帖事件</span>
<span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="o">{</span><span class="no">TOPIC_PUBLISH</span><span class="o">})</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlePublishMessage</span><span class="o">(</span><span class="nc">ConsumerRecord</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息内容为空"</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Event</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息格式错误"</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPostById</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getEntityId</span><span class="o">());</span>
    <span class="n">elasticsearchService</span><span class="o">.</span><span class="na">saveDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>新建searchController，对搜索到的帖子进行封装</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//路径后面带问号传</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/search"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">search</span><span class="o">(</span><span class="nc">String</span> <span class="n">keyword</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//搜索帖子</span>
        <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">Page</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">searchResults</span> <span class="o">=</span> <span class="n">elasticsearchService</span><span class="o">.</span><span class="na">searchDiscussPost</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="n">page</span><span class="o">.</span><span class="na">getCurrent</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">());</span>
        <span class="c1">//聚合数据</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">discussPosts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchResults</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">:</span> <span class="n">searchResults</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()));</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"likeCount"</span><span class="o">,</span> <span class="n">likeService</span><span class="o">.</span><span class="na">findEntityLikeCount</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
                <span class="n">discussPosts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"discussPosts"</span><span class="o">,</span> <span class="n">discussPosts</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"keyword"</span><span class="o">,</span> <span class="n">keyword</span><span class="o">);</span>

        <span class="c1">//实现分页</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/search?keyword="</span> <span class="o">+</span> <span class="n">keyword</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">searchResults</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">searchResults</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"/site/search"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

</article>
      </div>
    </main>

    
  </body>
</html>