<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>社区论坛：帖子评论私信等模块，处理日志和异常</title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="社区论坛：帖子评论私信等模块，处理日志和异常" />
<meta name="author" content="tie" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="第三章：开发社区核心功能 过滤敏感词 前缀树数据结构定义 初始化前缀树 编写过滤敏感词方法 @Component public class SensitiveFilter { private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class); private static final String REPLACEMENT = &quot;***&quot;; private TrieNode rootNode = new TrieNode(); @PostConstruct public void init() { //类路径加载资源 try ( //获得缓冲字节流 InputStream is = this.getClass().getClassLoader().getResourceAsStream(&quot;sensitive-words.txt&quot;); BufferedReader reader = new BufferedReader(new InputStreamReader(is)); ) { String keyword; while ((keyword = reader.readLine()) != null) { //添加到前缀树 this.addKeyWord(keyword); } } catch (IOException e) { logger.error(&quot;加载敏感词失败&quot; + e.getMessage()); } } private void addKeyWord(String keyword) { TrieNode tempNode = rootNode; for (int i = 0; i &lt; keyword.length(); i++) { char c = keyword.charAt(i); TrieNode child = tempNode.getChild(c); if (child == null) { child = new TrieNode(); tempNode.addChild(c, child); } tempNode = child; } tempNode.setKeywordEnd(true); } private class TrieNode { //关键词标识 private boolean isKeywordEnd = false; //子节点 private Map&lt;Character, TrieNode&gt; children = new HashMap&lt;&gt;(); public boolean isKeywordEnd() { return isKeywordEnd; } public void setKeywordEnd(boolean keywordEnd) { isKeywordEnd = keywordEnd; } //添加子节点 public void addChild(Character c, TrieNode node) { children.put(c, node); } //获取子节点 public TrieNode getChild(Character c) { return children.get(c); } } //过滤敏感词 public String filter(String text) { if (StringUtils.isBlank(text)) { return null; } TrieNode tempNode = rootNode; int len = text.length(); StringBuilder ans = new StringBuilder(); int start = 0, end = 0; while (end &lt; len) { char c = text.charAt(end); if (isSymbol(c)) { if (tempNode == rootNode) { ans.append(c); start++; } end++; continue; } tempNode = tempNode.getChild(c); if (tempNode == null) { ans.append(text.charAt(start)); start++; end = start; tempNode = rootNode; } else if (tempNode.isKeywordEnd()) { ans.append(REPLACEMENT); start = end + 1; end = start; tempNode = rootNode; } else { end++; } } ans.append(text.substring(start)); return ans.toString(); } //判断是否为符号 private boolean isSymbol(Character c) { return !CharUtils.isAsciiAlphanumeric(c) &amp;&amp; (c &lt; 0x2E80 || c &gt; 0x9FFF); } } 发布帖子 异步请求：当前网页不刷新，访问服务器，服务器返回一些结果（不是网页），通过这个结果，给网页局部的刷新。 实现技术：AJAX：异步的JavaScript和XML，不是新技术。目前一般不使用XML，而是使用JSON，便于解析。 功能：网页能够增量更新呈现在网页上，而不是刷新整个页面。 手册：Mozilla/AJAX jQuery发送AJAX的示例 处理JSON字符串：引入fastjson 写一个简单的静态页面，使用JQuery来发送数据，并接收来自服务器的JSON数据 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;ajax&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; &lt;input type=&quot;button&quot; value=&quot;发送&quot; onclick=&quot;send();&quot;&gt; &lt;/p&gt; &lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.min.js&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt; &lt;script&gt; function send(){ $.post( &quot;/community/alpha/ajax&quot;, {&quot;name&quot;:&quot;张三&quot;,&quot;age&quot;:23}, function(data){ console.log(typeof(data)); console.log(data); data = $.parseJSON(data); console.log(typeof(data)); console.log(data.code); console.log(data.msg); } ); } &lt;/script&gt; 服务端控制层代码如下： @RequestMapping(path = &quot;/ajax&quot;, method = RequestMethod.POST) @ResponseBody public String testAjax(String name, int age) { System.out.println(name); System.out.println(age); return CommunityUtil.getJSONString(0, &quot;操作成功&quot;); } 转换成JSON的小工具： //整合发送给浏览器的json数据 public static String getJSONString(int code, String msg, Map&lt;String, Object&gt; map) { JSONObject json = new JSONObject(); json.put(&quot;code&quot;, code); json.put(&quot;msg&quot;, msg); if (map != null) { for (String key : map.keySet()) { json.put(key, map.get(key)); } } return json.toJSONString(); } 利用发布帖子功能 还是按照数据访问层—&gt;服务层—&gt;控制层的顺序编写代码, 数据访问层 在dao中的接口定义插入函数,然后再相应的mapper.xml中实现,将帖子插入数据库 &lt;sql id=&quot;insertFields&quot;&gt; user_id, title, content, type, status, create_time, comment_count, score &lt;/sql&gt; &lt;insert id=&quot;insertDiscussPost&quot; parameterType=&quot;DiscussPost&quot;&gt; insert into discuss_post(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score}) &lt;/insert&gt; 业务层 将帖子插入数据库,过滤敏感词,转义html标签 public int addDiscussPost(DiscussPost post) { if (post == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //转义HTML标记 post.setTitle(HtmlUtils.htmlEscape(post.getTitle())); post.setContent(HtmlUtils.htmlEscape(post.getContent())); //过滤敏感词 post.setTitle(sensitiveFilter.filter(post.getTitle())); post.setContent(sensitiveFilter.filter(post.getContent())); return discussPostMapper.insertDiscussPost(post); } 控制层 获得服务器传来的数据,返回JSON字符串 @RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST) @ResponseBody public String addDiscussPost(String title, String content) { User user = hostHolder.getUser(); if (user == null) { return CommunityUtil.getJSONString(403, &quot;你还没有登录&quot;); } DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(title); post.setContent(content); post.setCreateTime(new Date()); discussPostService.addDiscussPost(post); //程序如果报错，将来会统一处理 return CommunityUtil.getJSONString(0, &quot;发布成功！&quot;); } 更改Index文件,写js代码,处理异步消息 $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 最终效果如下: 显示帖子详情 利用之前所学的内容，就能实现： 1,数据访问层：查寻帖子 2，业务层：查看帖子 3，控制层：处理查询请求 Index.html：处理详情帖子的链接 discuss-detail.html：显示帖子 开发三层代码 数据访问层： &lt;select id=&quot;selectDiscussPostById&quot; resultType=&quot;DiscussPost&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from discuss_post where id = #{id} &lt;/select&gt; 用户层： public DiscussPost findDiscussPostById(int id) { return discussPostMapper.selectDiscussPostById(id); } 控制层 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); return &quot;/site/discuss-detail&quot;; } HTML模板代码 修改index.html的链接 &lt;a th:href=&quot;@{|/discuss/detail/${map.post.id}|}&quot; th:utext=&quot;${map.post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/a&gt; 修改discuss-detail.html的内容 &lt;span th:utext=&quot;${post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/span&gt; &lt;img th:src=&quot;${user.headerUrl}&quot; &lt;div class=&quot;mt-0 text-warning&quot; th:utext=&quot;${user.username}&quot;&gt;寒江雪&lt;/div&gt; &lt;b th:text=&quot;${#dates.format(post.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;&gt;2019-04-15 15:32:18&lt;/b&gt; &lt;div class=&quot;mt-4 mb-3 content&quot; th:utext=&quot;${post.content}&quot;&gt; 事务管理 概念回顾 什么是事务：N步数据库操作序列，要么全部执行，要么全部放弃执行（以业务为单元，判断此次操作是否有效） 特性：原子性/一致性/隔离性/持久性 隔离性：针对并发而言，每个线程执行的事务互不干扰。 如果在多线程环境下，没有做多线程隔离（每一个浏览器访问服务器，多会创建一个线程）（多个用户同时访问同一份事务）（需要隔离性处理） 常见并发异常：1，更新。2，脏读。 分层级解决并发异常：串行化：最高级别，加锁，能解决所有问题，但是会造成性能下降。 一般选择：读取已提交数据/可重复读 这两种级别 常见并发异常的含义： 第一类丢失更新：某一个事务的回滚，导致了另外一个事务已更新的数据丢失了。 第二类丢失更新：某一个事务的提交，导致另一个事务已更新的数据丢失了 脏读：某一个事务读取了另一个事务未提交的数据， 不可重复读：某一个事务，对同一数据前后读取结果不一致 幻读：某一事务，对同一个表，查询到的行数不一致 越不安全效率越高。 事务隔离级别与并发异常表格： 实现机制： 悲观锁（数据库）包括共享锁和排他锁 乐观锁（自定义）：更新数据前，需要检查版本号是否变化，如果版本号变了，就取消本次更新 Spring事务管理： Spring引以为豪的技术点，无论底层是什么数据（库），Spring对其事务管理API都是统一的，非常方便。 在XML或者注解，加上配置就行 也可以编程式事务，通过Transaction Template管理事务（自由度高，对某一步数据库操作进行管理） Spring事务管理示例 可以使用注解，代码如下：最终执行结果，数据库中不会出现新的用户和帖子 //新增用户+自动发一个新人贴 //传播机制解释：两个事务交叉在一起，如何管理 //REQUIRED：支持当前事务（支持外部事务） //REQUIRES_NEW //NESTED:如果当前存在事务（外部事务），则嵌套在该事务中执行 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public Object save1() { //新建用户 User user = new User(); user.setUsername(&quot;aplha&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;Alpha@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/99t.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴&quot;); post.setContent(&quot;新人报到，多多指教&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } 也可以使用TransactionTemplate实现 public Object save2() { transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED); transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); return transactionTemplate.execute(new TransactionCallback&lt;Object&gt;() { @Override public Object doInTransaction(TransactionStatus transactionStatus) { //新建用户 User user = new User(); user.setUsername(&quot;beta&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;beta@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/999.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴,我叫beta&quot;); post.setContent(&quot;新人报到，多多指教~&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } }); } 显示评论 还是分成三层进行开发 数据层 查询一页的评论，需要明确数据表中每个字段的含义： entity_type:表示评论的对象类型：可以评论帖子，可以评论题目等等，本项目评论对象为帖子 entity_id：表示帖子的Id target_id：表示这条评论是指向哪个用户的。 @Mapper public interface CommentMapper { //查询某一页数据/一共多少条数据 List&lt;Comment&gt; selectCommentByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); int selectCountByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId); } &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.CommentMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, user_id, entity_type, entity_id, target_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectCommentByEntity&quot; resultType=&quot;Comment&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} order by create_time asc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectCountByEntity&quot; resultType=&quot;int&quot;&gt; select count(id) from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} &lt;/select&gt; &lt;/mapper&gt; 服务层 根据评论类型，评论对象，以及页码的一些数据，可以找到所需评论 @Service public class CommentService { @Autowired private CommentMapper commentMapper; //查询某一页数据 public List&lt;Comment&gt; findCommentsByEntity(int entityType, int entityId, int offset, int limit) { return commentMapper.selectCommentByEntity(entityType, entityId, offset, limit); } public int findCommentCount(int entityType, int entityId) { return commentMapper.selectCountByEntity(entityType, entityId); } } 控制层 需要将查找到的评论装入一个commentVoList，然后装入Model //SpringMVC每次会把参数中的bean(Page)都自动放在Model里面 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model, Page page) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); //评论分页信息 page.setLimit(5); page.setPath(&quot;/discuss/detail/&quot; + discussPostId); page.setRows(post.getCommentCount()); //评论：帖子的评论 //回复：评论的评论 //评论的列表 List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit()); //评论的VO列表 List&lt;Map&lt;String, Object&gt;&gt; commentVoList = new ArrayList&lt;&gt;(); if (commentList != null) { for (Comment comment : commentList) { //一个评论的VO Map&lt;String, Object&gt; commentVo = new HashMap&lt;&gt;(); //往VO添加评论 commentVo.put(&quot;comment&quot;, comment); //往VO添加作者 commentVo.put(&quot;user&quot;, userService.findUserById(comment.getUserId())); //添加回复 List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE); //回复的VO列表 List&lt;Map&lt;String, Object&gt;&gt; replyVoList = new ArrayList&lt;&gt;(); if (replyList != null) { for (Comment reply : replyList) { Map&lt;String, Object&gt; replyVo = new HashMap&lt;&gt;(); replyVo.put(&quot;reply&quot;, reply); replyVo.put(&quot;user&quot;, userService.findUserById(reply.getUserId())); //回复目标 if (reply.getTargetId() != 0) { replyVo.put(&quot;target&quot;, userService.findUserById(reply.getTargetId())); } else replyVo.put(&quot;target&quot;, null); replyVoList.add(replyVo); } } commentVo.put(&quot;replys&quot;, replyVoList); commentVo.put(&quot;replyCount&quot;, commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId())); commentVoList.add(commentVo); } } model.addAttribute(&quot;comments&quot;, commentVoList); return &quot;/site/discuss-detail&quot;; } 添加评论 增加评论的同时，需要更新帖子表中的评论数量，还是按照三层结构开发。 开发数据层 增加评论 &lt;insert id=&quot;insertComment&quot; parameterType=&quot;Comment&quot;&gt; insert into comment(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime}) &lt;/insert&gt; 更新帖子评论数 &lt;update id=&quot;updateCommentCount&quot;&gt; update discuss_post set comment_count = #{commentCount} where id = #{id} &lt;/update&gt; 开发服务层 添加评论 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public int addComment(Comment comment) { if (comment == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //添加完评论后，需要更新评论数量 comment.setContent(HtmlUtils.htmlEscape(comment.getContent())); comment.setContent(sensitiveFilter.filter(comment.getContent())); int rows = commentMapper.insertComment(comment); //如果更新的是帖子 if (comment.getEntityType() == ENTITY_TYPE_POST) { int count = commentMapper.selectCountByEntity(ENTITY_TYPE_POST, comment.getEntityId()); discussPostService.updateCommentCount(comment.getEntityId(), count); } return rows; } 更新帖子数量 public int updateCommentCount(int id, int commentCount) { return discussPostMapper.updateCommentCount(id, commentCount); } 开发控制层 @RequestMapping(path = &quot;/add/{discussPostId}&quot;, method = RequestMethod.POST) public String addComment(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Comment comment) { //统一的异常处理（如果空） //统一权限认证 comment.setUserId(hostHolder.getUser().getId()); comment.setStatus(0); comment.setCreateTime(new Date()); commentService.addComment(comment); return &quot;redirect:/discuss/detail/&quot; + discussPostId; } 私信列表 指的是朋友私信： 会话是指和某个用户的多条私信，私信列表是会话列表。会话列表只会显示最新的一条私信，而会话详情会包括和某个用户的全部私信。 还需要显示总的会话消息量。 会话ID，小的ID在前面大的ID在后面，为了查询会话数据时，筛选方便。 新建实体类：Message public class Message { private int id; private int fromId; private int toId; private String conversationId; private String content; private int status; private Date createTime; public int getId() { return id; } public void setId(int id) { this.id = id; } public int getFromId() { return fromId; } public void setFromId(int fromId) { this.fromId = fromId; } public int getToId() { return toId; } public void setToId(int toId) { this.toId = toId; } public String getConversationId() { return conversationId; } public void setConversationId(String conversationId) { this.conversationId = conversationId; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public int getStatus() { return status; } public void setStatus(int status) { this.status = status; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } @Override public String toString() { return &quot;Message{&quot; + &quot;id=&quot; + id + &quot;, fromId=&quot; + fromId + &quot;, toId=&quot; + toId + &quot;, conversationId=&#39;&quot; + conversationId + &#39;\&#39;&#39; + &quot;, content=&#39;&quot; + content + &#39;\&#39;&#39; + &quot;, status=&quot; + status + &quot;, createTime=&quot; + createTime + &#39;}&#39;; } } 数据层 数据库中一共只有14个会话，返回对话列表时，需要找到每个会话的最新数据 @Mapper public interface MessageMapper { //查询会话列表一页数据，每个会话，只返回一条最新的私信 List&lt;Message&gt; selectConversations(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询会话列表总行数 int selectConversationCount(@Param(&quot;userId&quot;) int userId); //查询详情的总消息数 List&lt;Message&gt; selectLetters(@Param(&quot;conversationId&quot;) String conversationId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询详情的当前页面消息 int selectLetterCount(@Param(&quot;conversationId&quot;) String conversationId); //查询未读消息数量 int selectLetterUnreadCount(@Param(&quot;userId&quot;) int userId, @Param(&quot;conversationId&quot;) String conversationId); } 配置文件如下： &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.MessageMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, from_id, to_id, conversation_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectConversations&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where id in( select max(id) from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectConversationCount&quot; resultType=&quot;int&quot;&gt; select count(m.maxid) from( select max(id) as maxid from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) as m &lt;/select&gt; &lt;select id=&quot;selectLetters&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectLetterCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} &lt;/select&gt; &lt;select id=&quot;selectLetterUnreadCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status = 0 and from_id != 1 and to_id = #{userId} &lt;if test=&quot;conversationId != null&quot;&gt; and conversation_id = #{conversationId} &lt;/if&gt; &lt;/select&gt; &lt;/mapper&gt; 服务层 @Service public class MessageService { @Autowired private MessageMapper messageMapper; public List&lt;Message&gt; findConversations(int userId, int offset, int limit) { return messageMapper.selectConversations(userId, offset, limit); } public int fingConversationCount(int userId) { return messageMapper.selectConversationCount(userId); } public List&lt;Message&gt; findLetters(String conversationId, int offset, int limit) { return messageMapper.selectLetters(conversationId, offset, limit); } public int findLetterCount(String conversationId) { return messageMapper.selectLetterCount(conversationId); } public int findUnreadCount(int userId, String conversationId) { return messageMapper.selectLetterUnreadCount(userId, conversationId); } } 控制层 @Controller public class MessageController { @Autowired private MessageService messageService; @Autowired private HostHolder hostHolder; @Autowired private UserService userService; //处理私信列表 @RequestMapping(path = &quot;/letter/list&quot;, method = RequestMethod.GET) public String getLetterList(Model model, Page page) { User user = hostHolder.getUser(); //设置分页信息 page.setLimit(5); page.setPath(&quot;/letter/list&quot;); page.setRows(messageService.fingConversationCount(user.getId())); //会话列表 List&lt;Message&gt; messages = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit()); List&lt;Map&lt;String, Object&gt;&gt; conversations = new ArrayList&lt;&gt;(); if (messages != null) { for (Message message : messages) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;conversation&quot;, message); map.put(&quot;unreadCount&quot;, messageService.findUnreadCount(user.getId(), message.getConversationId())); map.put(&quot;letterCount&quot;, messageService.findLetterCount(message.getConversationId())); int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId(); map.put(&quot;target&quot;, userService.findUserById(targetId)); conversations.add(map); } } model.addAttribute(&quot;conversations&quot;, conversations); //查询当前用户未读消息数量 int letterUnreadCount = messageService.findUnreadCount(user.getId(), null); model.addAttribute(&quot;letterUnreadCount&quot;, letterUnreadCount); return &quot;/site/letter&quot;; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } 模板处理略。 发送私信 在私信列表/私信详情内发私信 进入私信详情中，未读消息需要变为已读 数据层 添加增加私信的功能和修改私信状态的功能 //新增消息 int insertMessage(Message message); //修改状态 int updateStatus(@Param(&quot;ids&quot;) List&lt;Integer&gt; ids, @Param(&quot;status&quot;) int status); &lt;insert id=&quot;insertMessage&quot; parameterType=&quot;Message&quot; keyProperty=&quot;id&quot;&gt; insert into message(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime}) &lt;/insert&gt; &lt;update id=&quot;updateStatus&quot;&gt; update message set status = #{status} where id in &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; #{id} &lt;/foreach&gt; &lt;/update&gt; 服务层 public int addMessage(Message message) { message.setContent(HtmlUtils.htmlEscape(message.getContent())); message.setContent(sensitiveFilter.filter(message.getContent())); return messageMapper.insertMessage(message); } public int readMessage(List&lt;Integer&gt; ids) { return messageMapper.updateStatus(ids, 1); } 控制层 private List&lt;Integer&gt; getLetterIds(List&lt;Message&gt; letterList) { List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { if (hostHolder.getUser().getId() == letter.getToId() &amp;&amp; letter.getStatus() == 0) { ids.add(letter.getId()); } } } return ids; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); List&lt;Integer&gt; ids = getLetterIds(letterList); if (!ids.isEmpty()) { messageService.readMessage(ids); } return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } @RequestMapping(path = &quot;/letter/send&quot;, method = RequestMethod.POST) //因为是异步请求 @ResponseBody public String sendLetter(String toName, String content) { User target = userService.findUserByName(toName); if (target == null) { return CommunityUtil.getJSONString(1, &quot;目标用户不存在&quot;); } Message message = new Message(); message.setFromId(hostHolder.getUser().getId()); message.setToId(target.getId()); if (message.getFromId() &lt;= message.getToId()) { message.setConversationId(message.getFromId() + &quot;_&quot; + message.getToId()); } else { message.setConversationId(message.getToId() + &quot;_&quot; + message.getFromId()); } message.setContent(content); message.setCreateTime(new Date()); messageService.addMessage(message); //统一解决异常 return CommunityUtil.getJSONString(0); } 前端模板代码略 统一处理异常 服务器分为三层，如果数据层出异常了，会把异常抛给业务层，最后抛给表现层。 所以所有的异常都会汇聚到表现层，我们统一的处理表现层异常即可。 SpringBoot提供的方案：在项目的某一个路径下，加上对应错误页面，自动跳转到这个页面即可。 Spring Boot处理异常演示 首先需要把错误页面文件夹error移动到templates目录下，发生错误自动跳转 Spring统一处理异常 注解：@ControllerAdvice 对controller全局统一配置，对任意controller发生异常，都可以全局统一处理，可以使用以下三种配置 @ModelAttribute绑定数据：controller中有很多请求，都需要使用某一个参数，可以使用此注解，对model中统一绑定一个参数 @DataBinder:SpringMVC有很多转换器，将页面发来的数据转换成服务器的数据类型，当内置的转换器不够用，可以使用此配置，自定义转换 @ExceptionHandler：统一捕获异常 在Controller中新建advice包，并实现统一处理异步请求和普通请求的异常，如下： @ControllerAdvice(annotations = Controller.class) public class ExceptionAdvice { private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class); @ExceptionHandler({Exception.class}) public void handleException(Exception e, HttpServletRequest request, HttpServletResponse response) throws IOException { logger.error(&quot;服务器发生异常&quot; + e.getMessage()); for (StackTraceElement element : e.getStackTrace()) { logger.error(element.toString()); } String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain;charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(1, &quot;服务器异常&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/error&quot;); } } } 统一记录日志 记录日志的代码封装到一个组件，在不同的service中调用，但是这样会把系统需求和业务需求耦合在一起。 把系统需求单独实现：AOP（面向切面编程）（对OOP的补充）（提高编程效率） AOP 每个业务模块都有相同的系统需求，只需要单独的定义系统组件，包含各种业务组件。 常见术语： 一批业务组件（目标）：target（有很多地方可以织入代码） 代码单独封装在一个组件，称为方面组件，编程针对于方面（切面） 将方面组件代码织入（weaving)到目标中，有多种织入方式 编译时织入 装载时织入 运载时织入 目标代码上，有可能织入的位置，称为连接点（Joinpoint） Pointcut：声明具体织入到哪些对象的哪些位置（方面组件中） Advice：解决具体织入逻辑（调用前？调用后？返回后？异常时？）（方面组件中） 如何实现：常见有AspectJ和Spring AOP，其中AspectJ是新的语言，能解决所有AOP问题，在编译时织入代码，支持所有连接点。 SpringAOP纯JAVA实现，运行时织入代码（通过代理），只支持方法类型的织入点（局限），支持对AspectJ的集合。 代理：在某个对象生成代理对象，调用时只调用代理对象。 SpringAOP默认使用JDK动态代理，在运行时创建接口的代理实例，通过接口的代理实例织入代码，CGLib动态代理：底层字节码技术，通过子类实现代理。 AOP统一处理Service @Component @Aspect public class ServiceAspect { public static final Logger logger = LoggerFactory.getLogger(ServiceAspect.class); @Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;) public void pointcut() { } @Before(&quot;pointcut()&quot;) public void before(JoinPoint joinPoint) { //用户（ip)在某一时间，访问了什么方法（service） ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = attributes.getRequest(); String ip = request.getRemoteHost(); String now = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()); String target = joinPoint.getSignature().getDeclaringTypeName() + &quot;.&quot; + joinPoint.getSignature().getName(); logger.info(String.format(&quot;用户[%s],在[%s]，访问了[%s].&quot;, ip, now, target)); } } 注意如何获得当前请求的ip地址，当前接入点的方法名。" />
<meta property="og:description" content="第三章：开发社区核心功能 过滤敏感词 前缀树数据结构定义 初始化前缀树 编写过滤敏感词方法 @Component public class SensitiveFilter { private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class); private static final String REPLACEMENT = &quot;***&quot;; private TrieNode rootNode = new TrieNode(); @PostConstruct public void init() { //类路径加载资源 try ( //获得缓冲字节流 InputStream is = this.getClass().getClassLoader().getResourceAsStream(&quot;sensitive-words.txt&quot;); BufferedReader reader = new BufferedReader(new InputStreamReader(is)); ) { String keyword; while ((keyword = reader.readLine()) != null) { //添加到前缀树 this.addKeyWord(keyword); } } catch (IOException e) { logger.error(&quot;加载敏感词失败&quot; + e.getMessage()); } } private void addKeyWord(String keyword) { TrieNode tempNode = rootNode; for (int i = 0; i &lt; keyword.length(); i++) { char c = keyword.charAt(i); TrieNode child = tempNode.getChild(c); if (child == null) { child = new TrieNode(); tempNode.addChild(c, child); } tempNode = child; } tempNode.setKeywordEnd(true); } private class TrieNode { //关键词标识 private boolean isKeywordEnd = false; //子节点 private Map&lt;Character, TrieNode&gt; children = new HashMap&lt;&gt;(); public boolean isKeywordEnd() { return isKeywordEnd; } public void setKeywordEnd(boolean keywordEnd) { isKeywordEnd = keywordEnd; } //添加子节点 public void addChild(Character c, TrieNode node) { children.put(c, node); } //获取子节点 public TrieNode getChild(Character c) { return children.get(c); } } //过滤敏感词 public String filter(String text) { if (StringUtils.isBlank(text)) { return null; } TrieNode tempNode = rootNode; int len = text.length(); StringBuilder ans = new StringBuilder(); int start = 0, end = 0; while (end &lt; len) { char c = text.charAt(end); if (isSymbol(c)) { if (tempNode == rootNode) { ans.append(c); start++; } end++; continue; } tempNode = tempNode.getChild(c); if (tempNode == null) { ans.append(text.charAt(start)); start++; end = start; tempNode = rootNode; } else if (tempNode.isKeywordEnd()) { ans.append(REPLACEMENT); start = end + 1; end = start; tempNode = rootNode; } else { end++; } } ans.append(text.substring(start)); return ans.toString(); } //判断是否为符号 private boolean isSymbol(Character c) { return !CharUtils.isAsciiAlphanumeric(c) &amp;&amp; (c &lt; 0x2E80 || c &gt; 0x9FFF); } } 发布帖子 异步请求：当前网页不刷新，访问服务器，服务器返回一些结果（不是网页），通过这个结果，给网页局部的刷新。 实现技术：AJAX：异步的JavaScript和XML，不是新技术。目前一般不使用XML，而是使用JSON，便于解析。 功能：网页能够增量更新呈现在网页上，而不是刷新整个页面。 手册：Mozilla/AJAX jQuery发送AJAX的示例 处理JSON字符串：引入fastjson 写一个简单的静态页面，使用JQuery来发送数据，并接收来自服务器的JSON数据 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;ajax&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; &lt;input type=&quot;button&quot; value=&quot;发送&quot; onclick=&quot;send();&quot;&gt; &lt;/p&gt; &lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.min.js&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt; &lt;script&gt; function send(){ $.post( &quot;/community/alpha/ajax&quot;, {&quot;name&quot;:&quot;张三&quot;,&quot;age&quot;:23}, function(data){ console.log(typeof(data)); console.log(data); data = $.parseJSON(data); console.log(typeof(data)); console.log(data.code); console.log(data.msg); } ); } &lt;/script&gt; 服务端控制层代码如下： @RequestMapping(path = &quot;/ajax&quot;, method = RequestMethod.POST) @ResponseBody public String testAjax(String name, int age) { System.out.println(name); System.out.println(age); return CommunityUtil.getJSONString(0, &quot;操作成功&quot;); } 转换成JSON的小工具： //整合发送给浏览器的json数据 public static String getJSONString(int code, String msg, Map&lt;String, Object&gt; map) { JSONObject json = new JSONObject(); json.put(&quot;code&quot;, code); json.put(&quot;msg&quot;, msg); if (map != null) { for (String key : map.keySet()) { json.put(key, map.get(key)); } } return json.toJSONString(); } 利用发布帖子功能 还是按照数据访问层—&gt;服务层—&gt;控制层的顺序编写代码, 数据访问层 在dao中的接口定义插入函数,然后再相应的mapper.xml中实现,将帖子插入数据库 &lt;sql id=&quot;insertFields&quot;&gt; user_id, title, content, type, status, create_time, comment_count, score &lt;/sql&gt; &lt;insert id=&quot;insertDiscussPost&quot; parameterType=&quot;DiscussPost&quot;&gt; insert into discuss_post(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score}) &lt;/insert&gt; 业务层 将帖子插入数据库,过滤敏感词,转义html标签 public int addDiscussPost(DiscussPost post) { if (post == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //转义HTML标记 post.setTitle(HtmlUtils.htmlEscape(post.getTitle())); post.setContent(HtmlUtils.htmlEscape(post.getContent())); //过滤敏感词 post.setTitle(sensitiveFilter.filter(post.getTitle())); post.setContent(sensitiveFilter.filter(post.getContent())); return discussPostMapper.insertDiscussPost(post); } 控制层 获得服务器传来的数据,返回JSON字符串 @RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST) @ResponseBody public String addDiscussPost(String title, String content) { User user = hostHolder.getUser(); if (user == null) { return CommunityUtil.getJSONString(403, &quot;你还没有登录&quot;); } DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(title); post.setContent(content); post.setCreateTime(new Date()); discussPostService.addDiscussPost(post); //程序如果报错，将来会统一处理 return CommunityUtil.getJSONString(0, &quot;发布成功！&quot;); } 更改Index文件,写js代码,处理异步消息 $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 最终效果如下: 显示帖子详情 利用之前所学的内容，就能实现： 1,数据访问层：查寻帖子 2，业务层：查看帖子 3，控制层：处理查询请求 Index.html：处理详情帖子的链接 discuss-detail.html：显示帖子 开发三层代码 数据访问层： &lt;select id=&quot;selectDiscussPostById&quot; resultType=&quot;DiscussPost&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from discuss_post where id = #{id} &lt;/select&gt; 用户层： public DiscussPost findDiscussPostById(int id) { return discussPostMapper.selectDiscussPostById(id); } 控制层 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); return &quot;/site/discuss-detail&quot;; } HTML模板代码 修改index.html的链接 &lt;a th:href=&quot;@{|/discuss/detail/${map.post.id}|}&quot; th:utext=&quot;${map.post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/a&gt; 修改discuss-detail.html的内容 &lt;span th:utext=&quot;${post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/span&gt; &lt;img th:src=&quot;${user.headerUrl}&quot; &lt;div class=&quot;mt-0 text-warning&quot; th:utext=&quot;${user.username}&quot;&gt;寒江雪&lt;/div&gt; &lt;b th:text=&quot;${#dates.format(post.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;&gt;2019-04-15 15:32:18&lt;/b&gt; &lt;div class=&quot;mt-4 mb-3 content&quot; th:utext=&quot;${post.content}&quot;&gt; 事务管理 概念回顾 什么是事务：N步数据库操作序列，要么全部执行，要么全部放弃执行（以业务为单元，判断此次操作是否有效） 特性：原子性/一致性/隔离性/持久性 隔离性：针对并发而言，每个线程执行的事务互不干扰。 如果在多线程环境下，没有做多线程隔离（每一个浏览器访问服务器，多会创建一个线程）（多个用户同时访问同一份事务）（需要隔离性处理） 常见并发异常：1，更新。2，脏读。 分层级解决并发异常：串行化：最高级别，加锁，能解决所有问题，但是会造成性能下降。 一般选择：读取已提交数据/可重复读 这两种级别 常见并发异常的含义： 第一类丢失更新：某一个事务的回滚，导致了另外一个事务已更新的数据丢失了。 第二类丢失更新：某一个事务的提交，导致另一个事务已更新的数据丢失了 脏读：某一个事务读取了另一个事务未提交的数据， 不可重复读：某一个事务，对同一数据前后读取结果不一致 幻读：某一事务，对同一个表，查询到的行数不一致 越不安全效率越高。 事务隔离级别与并发异常表格： 实现机制： 悲观锁（数据库）包括共享锁和排他锁 乐观锁（自定义）：更新数据前，需要检查版本号是否变化，如果版本号变了，就取消本次更新 Spring事务管理： Spring引以为豪的技术点，无论底层是什么数据（库），Spring对其事务管理API都是统一的，非常方便。 在XML或者注解，加上配置就行 也可以编程式事务，通过Transaction Template管理事务（自由度高，对某一步数据库操作进行管理） Spring事务管理示例 可以使用注解，代码如下：最终执行结果，数据库中不会出现新的用户和帖子 //新增用户+自动发一个新人贴 //传播机制解释：两个事务交叉在一起，如何管理 //REQUIRED：支持当前事务（支持外部事务） //REQUIRES_NEW //NESTED:如果当前存在事务（外部事务），则嵌套在该事务中执行 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public Object save1() { //新建用户 User user = new User(); user.setUsername(&quot;aplha&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;Alpha@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/99t.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴&quot;); post.setContent(&quot;新人报到，多多指教&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } 也可以使用TransactionTemplate实现 public Object save2() { transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED); transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); return transactionTemplate.execute(new TransactionCallback&lt;Object&gt;() { @Override public Object doInTransaction(TransactionStatus transactionStatus) { //新建用户 User user = new User(); user.setUsername(&quot;beta&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;beta@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/999.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴,我叫beta&quot;); post.setContent(&quot;新人报到，多多指教~&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } }); } 显示评论 还是分成三层进行开发 数据层 查询一页的评论，需要明确数据表中每个字段的含义： entity_type:表示评论的对象类型：可以评论帖子，可以评论题目等等，本项目评论对象为帖子 entity_id：表示帖子的Id target_id：表示这条评论是指向哪个用户的。 @Mapper public interface CommentMapper { //查询某一页数据/一共多少条数据 List&lt;Comment&gt; selectCommentByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); int selectCountByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId); } &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.CommentMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, user_id, entity_type, entity_id, target_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectCommentByEntity&quot; resultType=&quot;Comment&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} order by create_time asc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectCountByEntity&quot; resultType=&quot;int&quot;&gt; select count(id) from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} &lt;/select&gt; &lt;/mapper&gt; 服务层 根据评论类型，评论对象，以及页码的一些数据，可以找到所需评论 @Service public class CommentService { @Autowired private CommentMapper commentMapper; //查询某一页数据 public List&lt;Comment&gt; findCommentsByEntity(int entityType, int entityId, int offset, int limit) { return commentMapper.selectCommentByEntity(entityType, entityId, offset, limit); } public int findCommentCount(int entityType, int entityId) { return commentMapper.selectCountByEntity(entityType, entityId); } } 控制层 需要将查找到的评论装入一个commentVoList，然后装入Model //SpringMVC每次会把参数中的bean(Page)都自动放在Model里面 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model, Page page) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); //评论分页信息 page.setLimit(5); page.setPath(&quot;/discuss/detail/&quot; + discussPostId); page.setRows(post.getCommentCount()); //评论：帖子的评论 //回复：评论的评论 //评论的列表 List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit()); //评论的VO列表 List&lt;Map&lt;String, Object&gt;&gt; commentVoList = new ArrayList&lt;&gt;(); if (commentList != null) { for (Comment comment : commentList) { //一个评论的VO Map&lt;String, Object&gt; commentVo = new HashMap&lt;&gt;(); //往VO添加评论 commentVo.put(&quot;comment&quot;, comment); //往VO添加作者 commentVo.put(&quot;user&quot;, userService.findUserById(comment.getUserId())); //添加回复 List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE); //回复的VO列表 List&lt;Map&lt;String, Object&gt;&gt; replyVoList = new ArrayList&lt;&gt;(); if (replyList != null) { for (Comment reply : replyList) { Map&lt;String, Object&gt; replyVo = new HashMap&lt;&gt;(); replyVo.put(&quot;reply&quot;, reply); replyVo.put(&quot;user&quot;, userService.findUserById(reply.getUserId())); //回复目标 if (reply.getTargetId() != 0) { replyVo.put(&quot;target&quot;, userService.findUserById(reply.getTargetId())); } else replyVo.put(&quot;target&quot;, null); replyVoList.add(replyVo); } } commentVo.put(&quot;replys&quot;, replyVoList); commentVo.put(&quot;replyCount&quot;, commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId())); commentVoList.add(commentVo); } } model.addAttribute(&quot;comments&quot;, commentVoList); return &quot;/site/discuss-detail&quot;; } 添加评论 增加评论的同时，需要更新帖子表中的评论数量，还是按照三层结构开发。 开发数据层 增加评论 &lt;insert id=&quot;insertComment&quot; parameterType=&quot;Comment&quot;&gt; insert into comment(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime}) &lt;/insert&gt; 更新帖子评论数 &lt;update id=&quot;updateCommentCount&quot;&gt; update discuss_post set comment_count = #{commentCount} where id = #{id} &lt;/update&gt; 开发服务层 添加评论 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public int addComment(Comment comment) { if (comment == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //添加完评论后，需要更新评论数量 comment.setContent(HtmlUtils.htmlEscape(comment.getContent())); comment.setContent(sensitiveFilter.filter(comment.getContent())); int rows = commentMapper.insertComment(comment); //如果更新的是帖子 if (comment.getEntityType() == ENTITY_TYPE_POST) { int count = commentMapper.selectCountByEntity(ENTITY_TYPE_POST, comment.getEntityId()); discussPostService.updateCommentCount(comment.getEntityId(), count); } return rows; } 更新帖子数量 public int updateCommentCount(int id, int commentCount) { return discussPostMapper.updateCommentCount(id, commentCount); } 开发控制层 @RequestMapping(path = &quot;/add/{discussPostId}&quot;, method = RequestMethod.POST) public String addComment(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Comment comment) { //统一的异常处理（如果空） //统一权限认证 comment.setUserId(hostHolder.getUser().getId()); comment.setStatus(0); comment.setCreateTime(new Date()); commentService.addComment(comment); return &quot;redirect:/discuss/detail/&quot; + discussPostId; } 私信列表 指的是朋友私信： 会话是指和某个用户的多条私信，私信列表是会话列表。会话列表只会显示最新的一条私信，而会话详情会包括和某个用户的全部私信。 还需要显示总的会话消息量。 会话ID，小的ID在前面大的ID在后面，为了查询会话数据时，筛选方便。 新建实体类：Message public class Message { private int id; private int fromId; private int toId; private String conversationId; private String content; private int status; private Date createTime; public int getId() { return id; } public void setId(int id) { this.id = id; } public int getFromId() { return fromId; } public void setFromId(int fromId) { this.fromId = fromId; } public int getToId() { return toId; } public void setToId(int toId) { this.toId = toId; } public String getConversationId() { return conversationId; } public void setConversationId(String conversationId) { this.conversationId = conversationId; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public int getStatus() { return status; } public void setStatus(int status) { this.status = status; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } @Override public String toString() { return &quot;Message{&quot; + &quot;id=&quot; + id + &quot;, fromId=&quot; + fromId + &quot;, toId=&quot; + toId + &quot;, conversationId=&#39;&quot; + conversationId + &#39;\&#39;&#39; + &quot;, content=&#39;&quot; + content + &#39;\&#39;&#39; + &quot;, status=&quot; + status + &quot;, createTime=&quot; + createTime + &#39;}&#39;; } } 数据层 数据库中一共只有14个会话，返回对话列表时，需要找到每个会话的最新数据 @Mapper public interface MessageMapper { //查询会话列表一页数据，每个会话，只返回一条最新的私信 List&lt;Message&gt; selectConversations(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询会话列表总行数 int selectConversationCount(@Param(&quot;userId&quot;) int userId); //查询详情的总消息数 List&lt;Message&gt; selectLetters(@Param(&quot;conversationId&quot;) String conversationId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询详情的当前页面消息 int selectLetterCount(@Param(&quot;conversationId&quot;) String conversationId); //查询未读消息数量 int selectLetterUnreadCount(@Param(&quot;userId&quot;) int userId, @Param(&quot;conversationId&quot;) String conversationId); } 配置文件如下： &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.MessageMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, from_id, to_id, conversation_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectConversations&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where id in( select max(id) from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectConversationCount&quot; resultType=&quot;int&quot;&gt; select count(m.maxid) from( select max(id) as maxid from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) as m &lt;/select&gt; &lt;select id=&quot;selectLetters&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectLetterCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} &lt;/select&gt; &lt;select id=&quot;selectLetterUnreadCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status = 0 and from_id != 1 and to_id = #{userId} &lt;if test=&quot;conversationId != null&quot;&gt; and conversation_id = #{conversationId} &lt;/if&gt; &lt;/select&gt; &lt;/mapper&gt; 服务层 @Service public class MessageService { @Autowired private MessageMapper messageMapper; public List&lt;Message&gt; findConversations(int userId, int offset, int limit) { return messageMapper.selectConversations(userId, offset, limit); } public int fingConversationCount(int userId) { return messageMapper.selectConversationCount(userId); } public List&lt;Message&gt; findLetters(String conversationId, int offset, int limit) { return messageMapper.selectLetters(conversationId, offset, limit); } public int findLetterCount(String conversationId) { return messageMapper.selectLetterCount(conversationId); } public int findUnreadCount(int userId, String conversationId) { return messageMapper.selectLetterUnreadCount(userId, conversationId); } } 控制层 @Controller public class MessageController { @Autowired private MessageService messageService; @Autowired private HostHolder hostHolder; @Autowired private UserService userService; //处理私信列表 @RequestMapping(path = &quot;/letter/list&quot;, method = RequestMethod.GET) public String getLetterList(Model model, Page page) { User user = hostHolder.getUser(); //设置分页信息 page.setLimit(5); page.setPath(&quot;/letter/list&quot;); page.setRows(messageService.fingConversationCount(user.getId())); //会话列表 List&lt;Message&gt; messages = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit()); List&lt;Map&lt;String, Object&gt;&gt; conversations = new ArrayList&lt;&gt;(); if (messages != null) { for (Message message : messages) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;conversation&quot;, message); map.put(&quot;unreadCount&quot;, messageService.findUnreadCount(user.getId(), message.getConversationId())); map.put(&quot;letterCount&quot;, messageService.findLetterCount(message.getConversationId())); int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId(); map.put(&quot;target&quot;, userService.findUserById(targetId)); conversations.add(map); } } model.addAttribute(&quot;conversations&quot;, conversations); //查询当前用户未读消息数量 int letterUnreadCount = messageService.findUnreadCount(user.getId(), null); model.addAttribute(&quot;letterUnreadCount&quot;, letterUnreadCount); return &quot;/site/letter&quot;; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } 模板处理略。 发送私信 在私信列表/私信详情内发私信 进入私信详情中，未读消息需要变为已读 数据层 添加增加私信的功能和修改私信状态的功能 //新增消息 int insertMessage(Message message); //修改状态 int updateStatus(@Param(&quot;ids&quot;) List&lt;Integer&gt; ids, @Param(&quot;status&quot;) int status); &lt;insert id=&quot;insertMessage&quot; parameterType=&quot;Message&quot; keyProperty=&quot;id&quot;&gt; insert into message(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime}) &lt;/insert&gt; &lt;update id=&quot;updateStatus&quot;&gt; update message set status = #{status} where id in &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; #{id} &lt;/foreach&gt; &lt;/update&gt; 服务层 public int addMessage(Message message) { message.setContent(HtmlUtils.htmlEscape(message.getContent())); message.setContent(sensitiveFilter.filter(message.getContent())); return messageMapper.insertMessage(message); } public int readMessage(List&lt;Integer&gt; ids) { return messageMapper.updateStatus(ids, 1); } 控制层 private List&lt;Integer&gt; getLetterIds(List&lt;Message&gt; letterList) { List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { if (hostHolder.getUser().getId() == letter.getToId() &amp;&amp; letter.getStatus() == 0) { ids.add(letter.getId()); } } } return ids; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); List&lt;Integer&gt; ids = getLetterIds(letterList); if (!ids.isEmpty()) { messageService.readMessage(ids); } return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } @RequestMapping(path = &quot;/letter/send&quot;, method = RequestMethod.POST) //因为是异步请求 @ResponseBody public String sendLetter(String toName, String content) { User target = userService.findUserByName(toName); if (target == null) { return CommunityUtil.getJSONString(1, &quot;目标用户不存在&quot;); } Message message = new Message(); message.setFromId(hostHolder.getUser().getId()); message.setToId(target.getId()); if (message.getFromId() &lt;= message.getToId()) { message.setConversationId(message.getFromId() + &quot;_&quot; + message.getToId()); } else { message.setConversationId(message.getToId() + &quot;_&quot; + message.getFromId()); } message.setContent(content); message.setCreateTime(new Date()); messageService.addMessage(message); //统一解决异常 return CommunityUtil.getJSONString(0); } 前端模板代码略 统一处理异常 服务器分为三层，如果数据层出异常了，会把异常抛给业务层，最后抛给表现层。 所以所有的异常都会汇聚到表现层，我们统一的处理表现层异常即可。 SpringBoot提供的方案：在项目的某一个路径下，加上对应错误页面，自动跳转到这个页面即可。 Spring Boot处理异常演示 首先需要把错误页面文件夹error移动到templates目录下，发生错误自动跳转 Spring统一处理异常 注解：@ControllerAdvice 对controller全局统一配置，对任意controller发生异常，都可以全局统一处理，可以使用以下三种配置 @ModelAttribute绑定数据：controller中有很多请求，都需要使用某一个参数，可以使用此注解，对model中统一绑定一个参数 @DataBinder:SpringMVC有很多转换器，将页面发来的数据转换成服务器的数据类型，当内置的转换器不够用，可以使用此配置，自定义转换 @ExceptionHandler：统一捕获异常 在Controller中新建advice包，并实现统一处理异步请求和普通请求的异常，如下： @ControllerAdvice(annotations = Controller.class) public class ExceptionAdvice { private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class); @ExceptionHandler({Exception.class}) public void handleException(Exception e, HttpServletRequest request, HttpServletResponse response) throws IOException { logger.error(&quot;服务器发生异常&quot; + e.getMessage()); for (StackTraceElement element : e.getStackTrace()) { logger.error(element.toString()); } String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain;charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(1, &quot;服务器异常&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/error&quot;); } } } 统一记录日志 记录日志的代码封装到一个组件，在不同的service中调用，但是这样会把系统需求和业务需求耦合在一起。 把系统需求单独实现：AOP（面向切面编程）（对OOP的补充）（提高编程效率） AOP 每个业务模块都有相同的系统需求，只需要单独的定义系统组件，包含各种业务组件。 常见术语： 一批业务组件（目标）：target（有很多地方可以织入代码） 代码单独封装在一个组件，称为方面组件，编程针对于方面（切面） 将方面组件代码织入（weaving)到目标中，有多种织入方式 编译时织入 装载时织入 运载时织入 目标代码上，有可能织入的位置，称为连接点（Joinpoint） Pointcut：声明具体织入到哪些对象的哪些位置（方面组件中） Advice：解决具体织入逻辑（调用前？调用后？返回后？异常时？）（方面组件中） 如何实现：常见有AspectJ和Spring AOP，其中AspectJ是新的语言，能解决所有AOP问题，在编译时织入代码，支持所有连接点。 SpringAOP纯JAVA实现，运行时织入代码（通过代理），只支持方法类型的织入点（局限），支持对AspectJ的集合。 代理：在某个对象生成代理对象，调用时只调用代理对象。 SpringAOP默认使用JDK动态代理，在运行时创建接口的代理实例，通过接口的代理实例织入代码，CGLib动态代理：底层字节码技术，通过子类实现代理。 AOP统一处理Service @Component @Aspect public class ServiceAspect { public static final Logger logger = LoggerFactory.getLogger(ServiceAspect.class); @Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;) public void pointcut() { } @Before(&quot;pointcut()&quot;) public void before(JoinPoint joinPoint) { //用户（ip)在某一时间，访问了什么方法（service） ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = attributes.getRequest(); String ip = request.getRemoteHost(); String now = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()); String target = joinPoint.getSignature().getDeclaringTypeName() + &quot;.&quot; + joinPoint.getSignature().getName(); logger.info(String.format(&quot;用户[%s],在[%s]，访问了[%s].&quot;, ip, now, target)); } } 注意如何获得当前请求的ip地址，当前接入点的方法名。" />
<link rel="canonical" href="https://github.com/tietietietie/tietietietie.github.io/chapter3.html" />
<meta property="og:url" content="https://github.com/tietietietie/tietietietie.github.io/chapter3.html" />
<meta property="og:site_name" content="tie’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-26T07:37:00+08:00" />
<script type="application/ld+json">
{"url":"https://github.com/tietietietie/tietietietie.github.io/chapter3.html","headline":"社区论坛：帖子评论私信等模块，处理日志和异常","dateModified":"2020-05-26T07:37:00+08:00","datePublished":"2020-05-26T07:37:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/tietietietie/tietietietie.github.io/chapter3.html"},"author":{"@type":"Person","name":"tie"},"description":"第三章：开发社区核心功能 过滤敏感词 前缀树数据结构定义 初始化前缀树 编写过滤敏感词方法 @Component public class SensitiveFilter { private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class); private static final String REPLACEMENT = &quot;***&quot;; private TrieNode rootNode = new TrieNode(); @PostConstruct public void init() { //类路径加载资源 try ( //获得缓冲字节流 InputStream is = this.getClass().getClassLoader().getResourceAsStream(&quot;sensitive-words.txt&quot;); BufferedReader reader = new BufferedReader(new InputStreamReader(is)); ) { String keyword; while ((keyword = reader.readLine()) != null) { //添加到前缀树 this.addKeyWord(keyword); } } catch (IOException e) { logger.error(&quot;加载敏感词失败&quot; + e.getMessage()); } } private void addKeyWord(String keyword) { TrieNode tempNode = rootNode; for (int i = 0; i &lt; keyword.length(); i++) { char c = keyword.charAt(i); TrieNode child = tempNode.getChild(c); if (child == null) { child = new TrieNode(); tempNode.addChild(c, child); } tempNode = child; } tempNode.setKeywordEnd(true); } private class TrieNode { //关键词标识 private boolean isKeywordEnd = false; //子节点 private Map&lt;Character, TrieNode&gt; children = new HashMap&lt;&gt;(); public boolean isKeywordEnd() { return isKeywordEnd; } public void setKeywordEnd(boolean keywordEnd) { isKeywordEnd = keywordEnd; } //添加子节点 public void addChild(Character c, TrieNode node) { children.put(c, node); } //获取子节点 public TrieNode getChild(Character c) { return children.get(c); } } //过滤敏感词 public String filter(String text) { if (StringUtils.isBlank(text)) { return null; } TrieNode tempNode = rootNode; int len = text.length(); StringBuilder ans = new StringBuilder(); int start = 0, end = 0; while (end &lt; len) { char c = text.charAt(end); if (isSymbol(c)) { if (tempNode == rootNode) { ans.append(c); start++; } end++; continue; } tempNode = tempNode.getChild(c); if (tempNode == null) { ans.append(text.charAt(start)); start++; end = start; tempNode = rootNode; } else if (tempNode.isKeywordEnd()) { ans.append(REPLACEMENT); start = end + 1; end = start; tempNode = rootNode; } else { end++; } } ans.append(text.substring(start)); return ans.toString(); } //判断是否为符号 private boolean isSymbol(Character c) { return !CharUtils.isAsciiAlphanumeric(c) &amp;&amp; (c &lt; 0x2E80 || c &gt; 0x9FFF); } } 发布帖子 异步请求：当前网页不刷新，访问服务器，服务器返回一些结果（不是网页），通过这个结果，给网页局部的刷新。 实现技术：AJAX：异步的JavaScript和XML，不是新技术。目前一般不使用XML，而是使用JSON，便于解析。 功能：网页能够增量更新呈现在网页上，而不是刷新整个页面。 手册：Mozilla/AJAX jQuery发送AJAX的示例 处理JSON字符串：引入fastjson 写一个简单的静态页面，使用JQuery来发送数据，并接收来自服务器的JSON数据 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;ajax&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; &lt;input type=&quot;button&quot; value=&quot;发送&quot; onclick=&quot;send();&quot;&gt; &lt;/p&gt; &lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.min.js&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt; &lt;script&gt; function send(){ $.post( &quot;/community/alpha/ajax&quot;, {&quot;name&quot;:&quot;张三&quot;,&quot;age&quot;:23}, function(data){ console.log(typeof(data)); console.log(data); data = $.parseJSON(data); console.log(typeof(data)); console.log(data.code); console.log(data.msg); } ); } &lt;/script&gt; 服务端控制层代码如下： @RequestMapping(path = &quot;/ajax&quot;, method = RequestMethod.POST) @ResponseBody public String testAjax(String name, int age) { System.out.println(name); System.out.println(age); return CommunityUtil.getJSONString(0, &quot;操作成功&quot;); } 转换成JSON的小工具： //整合发送给浏览器的json数据 public static String getJSONString(int code, String msg, Map&lt;String, Object&gt; map) { JSONObject json = new JSONObject(); json.put(&quot;code&quot;, code); json.put(&quot;msg&quot;, msg); if (map != null) { for (String key : map.keySet()) { json.put(key, map.get(key)); } } return json.toJSONString(); } 利用发布帖子功能 还是按照数据访问层—&gt;服务层—&gt;控制层的顺序编写代码, 数据访问层 在dao中的接口定义插入函数,然后再相应的mapper.xml中实现,将帖子插入数据库 &lt;sql id=&quot;insertFields&quot;&gt; user_id, title, content, type, status, create_time, comment_count, score &lt;/sql&gt; &lt;insert id=&quot;insertDiscussPost&quot; parameterType=&quot;DiscussPost&quot;&gt; insert into discuss_post(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score}) &lt;/insert&gt; 业务层 将帖子插入数据库,过滤敏感词,转义html标签 public int addDiscussPost(DiscussPost post) { if (post == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //转义HTML标记 post.setTitle(HtmlUtils.htmlEscape(post.getTitle())); post.setContent(HtmlUtils.htmlEscape(post.getContent())); //过滤敏感词 post.setTitle(sensitiveFilter.filter(post.getTitle())); post.setContent(sensitiveFilter.filter(post.getContent())); return discussPostMapper.insertDiscussPost(post); } 控制层 获得服务器传来的数据,返回JSON字符串 @RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST) @ResponseBody public String addDiscussPost(String title, String content) { User user = hostHolder.getUser(); if (user == null) { return CommunityUtil.getJSONString(403, &quot;你还没有登录&quot;); } DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(title); post.setContent(content); post.setCreateTime(new Date()); discussPostService.addDiscussPost(post); //程序如果报错，将来会统一处理 return CommunityUtil.getJSONString(0, &quot;发布成功！&quot;); } 更改Index文件,写js代码,处理异步消息 $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 最终效果如下: 显示帖子详情 利用之前所学的内容，就能实现： 1,数据访问层：查寻帖子 2，业务层：查看帖子 3，控制层：处理查询请求 Index.html：处理详情帖子的链接 discuss-detail.html：显示帖子 开发三层代码 数据访问层： &lt;select id=&quot;selectDiscussPostById&quot; resultType=&quot;DiscussPost&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from discuss_post where id = #{id} &lt;/select&gt; 用户层： public DiscussPost findDiscussPostById(int id) { return discussPostMapper.selectDiscussPostById(id); } 控制层 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); return &quot;/site/discuss-detail&quot;; } HTML模板代码 修改index.html的链接 &lt;a th:href=&quot;@{|/discuss/detail/${map.post.id}|}&quot; th:utext=&quot;${map.post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/a&gt; 修改discuss-detail.html的内容 &lt;span th:utext=&quot;${post.title}&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/span&gt; &lt;img th:src=&quot;${user.headerUrl}&quot; &lt;div class=&quot;mt-0 text-warning&quot; th:utext=&quot;${user.username}&quot;&gt;寒江雪&lt;/div&gt; &lt;b th:text=&quot;${#dates.format(post.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;&gt;2019-04-15 15:32:18&lt;/b&gt; &lt;div class=&quot;mt-4 mb-3 content&quot; th:utext=&quot;${post.content}&quot;&gt; 事务管理 概念回顾 什么是事务：N步数据库操作序列，要么全部执行，要么全部放弃执行（以业务为单元，判断此次操作是否有效） 特性：原子性/一致性/隔离性/持久性 隔离性：针对并发而言，每个线程执行的事务互不干扰。 如果在多线程环境下，没有做多线程隔离（每一个浏览器访问服务器，多会创建一个线程）（多个用户同时访问同一份事务）（需要隔离性处理） 常见并发异常：1，更新。2，脏读。 分层级解决并发异常：串行化：最高级别，加锁，能解决所有问题，但是会造成性能下降。 一般选择：读取已提交数据/可重复读 这两种级别 常见并发异常的含义： 第一类丢失更新：某一个事务的回滚，导致了另外一个事务已更新的数据丢失了。 第二类丢失更新：某一个事务的提交，导致另一个事务已更新的数据丢失了 脏读：某一个事务读取了另一个事务未提交的数据， 不可重复读：某一个事务，对同一数据前后读取结果不一致 幻读：某一事务，对同一个表，查询到的行数不一致 越不安全效率越高。 事务隔离级别与并发异常表格： 实现机制： 悲观锁（数据库）包括共享锁和排他锁 乐观锁（自定义）：更新数据前，需要检查版本号是否变化，如果版本号变了，就取消本次更新 Spring事务管理： Spring引以为豪的技术点，无论底层是什么数据（库），Spring对其事务管理API都是统一的，非常方便。 在XML或者注解，加上配置就行 也可以编程式事务，通过Transaction Template管理事务（自由度高，对某一步数据库操作进行管理） Spring事务管理示例 可以使用注解，代码如下：最终执行结果，数据库中不会出现新的用户和帖子 //新增用户+自动发一个新人贴 //传播机制解释：两个事务交叉在一起，如何管理 //REQUIRED：支持当前事务（支持外部事务） //REQUIRES_NEW //NESTED:如果当前存在事务（外部事务），则嵌套在该事务中执行 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public Object save1() { //新建用户 User user = new User(); user.setUsername(&quot;aplha&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;Alpha@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/99t.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴&quot;); post.setContent(&quot;新人报到，多多指教&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } 也可以使用TransactionTemplate实现 public Object save2() { transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED); transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); return transactionTemplate.execute(new TransactionCallback&lt;Object&gt;() { @Override public Object doInTransaction(TransactionStatus transactionStatus) { //新建用户 User user = new User(); user.setUsername(&quot;beta&quot;); user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); user.setPassword(CommunityUtil.md5(&quot;123&quot; + user.getSalt())); user.setEmail(&quot;beta@qq.com&quot;); user.setHeaderUrl(&quot;http://image/nowcoder.com/head/999.png&quot;); user.setCreatTime(new Date()); userMapper.insertUser(user); //新建帖子 DiscussPost post = new DiscussPost(); post.setUserId(user.getId()); post.setTitle(&quot;新人贴,我叫beta&quot;); post.setContent(&quot;新人报到，多多指教~&quot;); post.setCreateTime(new Date()); discussPostMapper.insertDiscussPost(post); //报错前会把数据插入吗？ Integer.valueOf(&quot;abc&quot;); return &quot;ok&quot;; } }); } 显示评论 还是分成三层进行开发 数据层 查询一页的评论，需要明确数据表中每个字段的含义： entity_type:表示评论的对象类型：可以评论帖子，可以评论题目等等，本项目评论对象为帖子 entity_id：表示帖子的Id target_id：表示这条评论是指向哪个用户的。 @Mapper public interface CommentMapper { //查询某一页数据/一共多少条数据 List&lt;Comment&gt; selectCommentByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); int selectCountByEntity(@Param(&quot;entityType&quot;) int entityType, @Param(&quot;entityId&quot;) int entityId); } &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.CommentMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, user_id, entity_type, entity_id, target_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectCommentByEntity&quot; resultType=&quot;Comment&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} order by create_time asc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectCountByEntity&quot; resultType=&quot;int&quot;&gt; select count(id) from comment where status = 0 and entity_type = #{entityType} and entity_id = #{entityId} &lt;/select&gt; &lt;/mapper&gt; 服务层 根据评论类型，评论对象，以及页码的一些数据，可以找到所需评论 @Service public class CommentService { @Autowired private CommentMapper commentMapper; //查询某一页数据 public List&lt;Comment&gt; findCommentsByEntity(int entityType, int entityId, int offset, int limit) { return commentMapper.selectCommentByEntity(entityType, entityId, offset, limit); } public int findCommentCount(int entityType, int entityId) { return commentMapper.selectCountByEntity(entityType, entityId); } } 控制层 需要将查找到的评论装入一个commentVoList，然后装入Model //SpringMVC每次会把参数中的bean(Page)都自动放在Model里面 @RequestMapping(path = &quot;/detail/{discussPostId}&quot;, method = RequestMethod.GET) public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Model model, Page page) { //查询帖子 DiscussPost post = discussPostService.findDiscussPostById(discussPostId); model.addAttribute(&quot;post&quot;, post); //需要显示用户信息，而不是id //两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点 //但是之后可以用redies提高速度 User user = userService.findUserById(post.getUserId()); model.addAttribute(&quot;user&quot;, user); //评论分页信息 page.setLimit(5); page.setPath(&quot;/discuss/detail/&quot; + discussPostId); page.setRows(post.getCommentCount()); //评论：帖子的评论 //回复：评论的评论 //评论的列表 List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit()); //评论的VO列表 List&lt;Map&lt;String, Object&gt;&gt; commentVoList = new ArrayList&lt;&gt;(); if (commentList != null) { for (Comment comment : commentList) { //一个评论的VO Map&lt;String, Object&gt; commentVo = new HashMap&lt;&gt;(); //往VO添加评论 commentVo.put(&quot;comment&quot;, comment); //往VO添加作者 commentVo.put(&quot;user&quot;, userService.findUserById(comment.getUserId())); //添加回复 List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE); //回复的VO列表 List&lt;Map&lt;String, Object&gt;&gt; replyVoList = new ArrayList&lt;&gt;(); if (replyList != null) { for (Comment reply : replyList) { Map&lt;String, Object&gt; replyVo = new HashMap&lt;&gt;(); replyVo.put(&quot;reply&quot;, reply); replyVo.put(&quot;user&quot;, userService.findUserById(reply.getUserId())); //回复目标 if (reply.getTargetId() != 0) { replyVo.put(&quot;target&quot;, userService.findUserById(reply.getTargetId())); } else replyVo.put(&quot;target&quot;, null); replyVoList.add(replyVo); } } commentVo.put(&quot;replys&quot;, replyVoList); commentVo.put(&quot;replyCount&quot;, commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId())); commentVoList.add(commentVo); } } model.addAttribute(&quot;comments&quot;, commentVoList); return &quot;/site/discuss-detail&quot;; } 添加评论 增加评论的同时，需要更新帖子表中的评论数量，还是按照三层结构开发。 开发数据层 增加评论 &lt;insert id=&quot;insertComment&quot; parameterType=&quot;Comment&quot;&gt; insert into comment(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime}) &lt;/insert&gt; 更新帖子评论数 &lt;update id=&quot;updateCommentCount&quot;&gt; update discuss_post set comment_count = #{commentCount} where id = #{id} &lt;/update&gt; 开发服务层 添加评论 @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED) public int addComment(Comment comment) { if (comment == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //添加完评论后，需要更新评论数量 comment.setContent(HtmlUtils.htmlEscape(comment.getContent())); comment.setContent(sensitiveFilter.filter(comment.getContent())); int rows = commentMapper.insertComment(comment); //如果更新的是帖子 if (comment.getEntityType() == ENTITY_TYPE_POST) { int count = commentMapper.selectCountByEntity(ENTITY_TYPE_POST, comment.getEntityId()); discussPostService.updateCommentCount(comment.getEntityId(), count); } return rows; } 更新帖子数量 public int updateCommentCount(int id, int commentCount) { return discussPostMapper.updateCommentCount(id, commentCount); } 开发控制层 @RequestMapping(path = &quot;/add/{discussPostId}&quot;, method = RequestMethod.POST) public String addComment(@PathVariable(&quot;discussPostId&quot;) int discussPostId, Comment comment) { //统一的异常处理（如果空） //统一权限认证 comment.setUserId(hostHolder.getUser().getId()); comment.setStatus(0); comment.setCreateTime(new Date()); commentService.addComment(comment); return &quot;redirect:/discuss/detail/&quot; + discussPostId; } 私信列表 指的是朋友私信： 会话是指和某个用户的多条私信，私信列表是会话列表。会话列表只会显示最新的一条私信，而会话详情会包括和某个用户的全部私信。 还需要显示总的会话消息量。 会话ID，小的ID在前面大的ID在后面，为了查询会话数据时，筛选方便。 新建实体类：Message public class Message { private int id; private int fromId; private int toId; private String conversationId; private String content; private int status; private Date createTime; public int getId() { return id; } public void setId(int id) { this.id = id; } public int getFromId() { return fromId; } public void setFromId(int fromId) { this.fromId = fromId; } public int getToId() { return toId; } public void setToId(int toId) { this.toId = toId; } public String getConversationId() { return conversationId; } public void setConversationId(String conversationId) { this.conversationId = conversationId; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public int getStatus() { return status; } public void setStatus(int status) { this.status = status; } public Date getCreateTime() { return createTime; } public void setCreateTime(Date createTime) { this.createTime = createTime; } @Override public String toString() { return &quot;Message{&quot; + &quot;id=&quot; + id + &quot;, fromId=&quot; + fromId + &quot;, toId=&quot; + toId + &quot;, conversationId=&#39;&quot; + conversationId + &#39;\\&#39;&#39; + &quot;, content=&#39;&quot; + content + &#39;\\&#39;&#39; + &quot;, status=&quot; + status + &quot;, createTime=&quot; + createTime + &#39;}&#39;; } } 数据层 数据库中一共只有14个会话，返回对话列表时，需要找到每个会话的最新数据 @Mapper public interface MessageMapper { //查询会话列表一页数据，每个会话，只返回一条最新的私信 List&lt;Message&gt; selectConversations(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询会话列表总行数 int selectConversationCount(@Param(&quot;userId&quot;) int userId); //查询详情的总消息数 List&lt;Message&gt; selectLetters(@Param(&quot;conversationId&quot;) String conversationId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit); //查询详情的当前页面消息 int selectLetterCount(@Param(&quot;conversationId&quot;) String conversationId); //查询未读消息数量 int selectLetterUnreadCount(@Param(&quot;userId&quot;) int userId, @Param(&quot;conversationId&quot;) String conversationId); } 配置文件如下： &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; &lt;mapper namespace=&quot;com.nowcoder.community.dao.MessageMapper&quot;&gt; &lt;sql id=&quot;selectFields&quot;&gt; id, from_id, to_id, conversation_id, content, status, create_time &lt;/sql&gt; &lt;select id=&quot;selectConversations&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where id in( select max(id) from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectConversationCount&quot; resultType=&quot;int&quot;&gt; select count(m.maxid) from( select max(id) as maxid from message where status != 2 and from_id != 1 and (from_id = #{userId} or to_id = #{userId}) group by conversation_id ) as m &lt;/select&gt; &lt;select id=&quot;selectLetters&quot; resultType=&quot;Message&quot;&gt; select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} order by id desc limit #{offset}, #{limit} &lt;/select&gt; &lt;select id=&quot;selectLetterCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status != 2 and from_id != 1 and conversation_id = #{conversationId} &lt;/select&gt; &lt;select id=&quot;selectLetterUnreadCount&quot; resultType=&quot;int&quot;&gt; select count(id) from message where status = 0 and from_id != 1 and to_id = #{userId} &lt;if test=&quot;conversationId != null&quot;&gt; and conversation_id = #{conversationId} &lt;/if&gt; &lt;/select&gt; &lt;/mapper&gt; 服务层 @Service public class MessageService { @Autowired private MessageMapper messageMapper; public List&lt;Message&gt; findConversations(int userId, int offset, int limit) { return messageMapper.selectConversations(userId, offset, limit); } public int fingConversationCount(int userId) { return messageMapper.selectConversationCount(userId); } public List&lt;Message&gt; findLetters(String conversationId, int offset, int limit) { return messageMapper.selectLetters(conversationId, offset, limit); } public int findLetterCount(String conversationId) { return messageMapper.selectLetterCount(conversationId); } public int findUnreadCount(int userId, String conversationId) { return messageMapper.selectLetterUnreadCount(userId, conversationId); } } 控制层 @Controller public class MessageController { @Autowired private MessageService messageService; @Autowired private HostHolder hostHolder; @Autowired private UserService userService; //处理私信列表 @RequestMapping(path = &quot;/letter/list&quot;, method = RequestMethod.GET) public String getLetterList(Model model, Page page) { User user = hostHolder.getUser(); //设置分页信息 page.setLimit(5); page.setPath(&quot;/letter/list&quot;); page.setRows(messageService.fingConversationCount(user.getId())); //会话列表 List&lt;Message&gt; messages = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit()); List&lt;Map&lt;String, Object&gt;&gt; conversations = new ArrayList&lt;&gt;(); if (messages != null) { for (Message message : messages) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;conversation&quot;, message); map.put(&quot;unreadCount&quot;, messageService.findUnreadCount(user.getId(), message.getConversationId())); map.put(&quot;letterCount&quot;, messageService.findLetterCount(message.getConversationId())); int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId(); map.put(&quot;target&quot;, userService.findUserById(targetId)); conversations.add(map); } } model.addAttribute(&quot;conversations&quot;, conversations); //查询当前用户未读消息数量 int letterUnreadCount = messageService.findUnreadCount(user.getId(), null); model.addAttribute(&quot;letterUnreadCount&quot;, letterUnreadCount); return &quot;/site/letter&quot;; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } 模板处理略。 发送私信 在私信列表/私信详情内发私信 进入私信详情中，未读消息需要变为已读 数据层 添加增加私信的功能和修改私信状态的功能 //新增消息 int insertMessage(Message message); //修改状态 int updateStatus(@Param(&quot;ids&quot;) List&lt;Integer&gt; ids, @Param(&quot;status&quot;) int status); &lt;insert id=&quot;insertMessage&quot; parameterType=&quot;Message&quot; keyProperty=&quot;id&quot;&gt; insert into message(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;) values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime}) &lt;/insert&gt; &lt;update id=&quot;updateStatus&quot;&gt; update message set status = #{status} where id in &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; #{id} &lt;/foreach&gt; &lt;/update&gt; 服务层 public int addMessage(Message message) { message.setContent(HtmlUtils.htmlEscape(message.getContent())); message.setContent(sensitiveFilter.filter(message.getContent())); return messageMapper.insertMessage(message); } public int readMessage(List&lt;Integer&gt; ids) { return messageMapper.updateStatus(ids, 1); } 控制层 private List&lt;Integer&gt; getLetterIds(List&lt;Message&gt; letterList) { List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { if (hostHolder.getUser().getId() == letter.getToId() &amp;&amp; letter.getStatus() == 0) { ids.add(letter.getId()); } } } return ids; } @RequestMapping(path = &quot;/letter/detail/{conversationId}&quot;, method = RequestMethod.GET) public String getLetterDetail(@PathVariable(&quot;conversationId&quot;) String conversationId, Page page, Model model) { //分页信息 page.setLimit(5); page.setPath(&quot;/letter/detail/&quot; + conversationId); page.setRows(messageService.findLetterCount(conversationId)); //得到了会话的所有私信 List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit()); //只需要显示from_user、 List&lt;Map&lt;String, Object&gt;&gt; letters = new ArrayList&lt;&gt;(); if (letterList != null) { for (Message letter : letterList) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;letter&quot;, letter); map.put(&quot;fromUser&quot;, userService.findUserById(letter.getFromId())); letters.add(map); } } model.addAttribute(&quot;letters&quot;, letters); User target = getLetterTarget(conversationId); model.addAttribute(&quot;target&quot;, target); List&lt;Integer&gt; ids = getLetterIds(letterList); if (!ids.isEmpty()) { messageService.readMessage(ids); } return &quot;/site/letter-detail&quot;; } private User getLetterTarget(String conversationId) { String[] ids = conversationId.split(&quot;_&quot;); int id0 = Integer.parseInt(ids[0]); int id1 = Integer.parseInt(ids[1]); if (id0 == hostHolder.getUser().getId()) return userService.findUserById(id1); return userService.findUserById(id0); } @RequestMapping(path = &quot;/letter/send&quot;, method = RequestMethod.POST) //因为是异步请求 @ResponseBody public String sendLetter(String toName, String content) { User target = userService.findUserByName(toName); if (target == null) { return CommunityUtil.getJSONString(1, &quot;目标用户不存在&quot;); } Message message = new Message(); message.setFromId(hostHolder.getUser().getId()); message.setToId(target.getId()); if (message.getFromId() &lt;= message.getToId()) { message.setConversationId(message.getFromId() + &quot;_&quot; + message.getToId()); } else { message.setConversationId(message.getToId() + &quot;_&quot; + message.getFromId()); } message.setContent(content); message.setCreateTime(new Date()); messageService.addMessage(message); //统一解决异常 return CommunityUtil.getJSONString(0); } 前端模板代码略 统一处理异常 服务器分为三层，如果数据层出异常了，会把异常抛给业务层，最后抛给表现层。 所以所有的异常都会汇聚到表现层，我们统一的处理表现层异常即可。 SpringBoot提供的方案：在项目的某一个路径下，加上对应错误页面，自动跳转到这个页面即可。 Spring Boot处理异常演示 首先需要把错误页面文件夹error移动到templates目录下，发生错误自动跳转 Spring统一处理异常 注解：@ControllerAdvice 对controller全局统一配置，对任意controller发生异常，都可以全局统一处理，可以使用以下三种配置 @ModelAttribute绑定数据：controller中有很多请求，都需要使用某一个参数，可以使用此注解，对model中统一绑定一个参数 @DataBinder:SpringMVC有很多转换器，将页面发来的数据转换成服务器的数据类型，当内置的转换器不够用，可以使用此配置，自定义转换 @ExceptionHandler：统一捕获异常 在Controller中新建advice包，并实现统一处理异步请求和普通请求的异常，如下： @ControllerAdvice(annotations = Controller.class) public class ExceptionAdvice { private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class); @ExceptionHandler({Exception.class}) public void handleException(Exception e, HttpServletRequest request, HttpServletResponse response) throws IOException { logger.error(&quot;服务器发生异常&quot; + e.getMessage()); for (StackTraceElement element : e.getStackTrace()) { logger.error(element.toString()); } String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain;charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(1, &quot;服务器异常&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/error&quot;); } } } 统一记录日志 记录日志的代码封装到一个组件，在不同的service中调用，但是这样会把系统需求和业务需求耦合在一起。 把系统需求单独实现：AOP（面向切面编程）（对OOP的补充）（提高编程效率） AOP 每个业务模块都有相同的系统需求，只需要单独的定义系统组件，包含各种业务组件。 常见术语： 一批业务组件（目标）：target（有很多地方可以织入代码） 代码单独封装在一个组件，称为方面组件，编程针对于方面（切面） 将方面组件代码织入（weaving)到目标中，有多种织入方式 编译时织入 装载时织入 运载时织入 目标代码上，有可能织入的位置，称为连接点（Joinpoint） Pointcut：声明具体织入到哪些对象的哪些位置（方面组件中） Advice：解决具体织入逻辑（调用前？调用后？返回后？异常时？）（方面组件中） 如何实现：常见有AspectJ和Spring AOP，其中AspectJ是新的语言，能解决所有AOP问题，在编译时织入代码，支持所有连接点。 SpringAOP纯JAVA实现，运行时织入代码（通过代理），只支持方法类型的织入点（局限），支持对AspectJ的集合。 代理：在某个对象生成代理对象，调用时只调用代理对象。 SpringAOP默认使用JDK动态代理，在运行时创建接口的代理实例，通过接口的代理实例织入代码，CGLib动态代理：底层字节码技术，通过子类实现代理。 AOP统一处理Service @Component @Aspect public class ServiceAspect { public static final Logger logger = LoggerFactory.getLogger(ServiceAspect.class); @Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;) public void pointcut() { } @Before(&quot;pointcut()&quot;) public void before(JoinPoint joinPoint) { //用户（ip)在某一时间，访问了什么方法（service） ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = attributes.getRequest(); String ip = request.getRemoteHost(); String now = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()); String target = joinPoint.getSignature().getDeclaringTypeName() + &quot;.&quot; + joinPoint.getSignature().getName(); logger.info(String.format(&quot;用户[%s],在[%s]，访问了[%s].&quot;, ip, now, target)); } } 注意如何获得当前请求的ip地址，当前接入点的方法名。","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://github.com/tietietietie/tietietietie.github.io/feed.xml" title="tie's blog" />

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a>

<article>
  <p class="post-meta">
    <time datetime="2020-05-26 07:37:00 +0800">2020-05-26</time>
  </p>
  
  <h1>社区论坛：帖子评论私信等模块，处理日志和异常</h1>

  <h1 id="第三章开发社区核心功能">第三章：开发社区核心功能</h1>

<h2 id="过滤敏感词">过滤敏感词</h2>

<h3 id="前缀树数据结构定义">前缀树数据结构定义</h3>

<h3 id="初始化前缀树">初始化前缀树</h3>

<h3 id="编写过滤敏感词方法">编写过滤敏感词方法</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SensitiveFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">SensitiveFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REPLACEMENT</span> <span class="o">=</span> <span class="s">"***"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">TrieNode</span> <span class="n">rootNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrieNode</span><span class="o">();</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//类路径加载资源</span>
        <span class="k">try</span> <span class="o">(</span>
                <span class="c1">//获得缓冲字节流</span>
                <span class="nc">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"sensitive-words.txt"</span><span class="o">);</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">is</span><span class="o">));</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">keyword</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//添加到前缀树</span>
                <span class="k">this</span><span class="o">.</span><span class="na">addKeyWord</span><span class="o">(</span><span class="n">keyword</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"加载敏感词失败"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addKeyWord</span><span class="o">(</span><span class="nc">String</span> <span class="n">keyword</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TrieNode</span> <span class="n">tempNode</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">keyword</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="nc">TrieNode</span> <span class="n">child</span> <span class="o">=</span> <span class="n">tempNode</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">child</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrieNode</span><span class="o">();</span>
                <span class="n">tempNode</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">child</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">tempNode</span> <span class="o">=</span> <span class="n">child</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">tempNode</span><span class="o">.</span><span class="na">setKeywordEnd</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">TrieNode</span> <span class="o">{</span>
        <span class="c1">//关键词标识</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isKeywordEnd</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">//子节点</span>
        <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Character</span><span class="o">,</span> <span class="nc">TrieNode</span><span class="o">&gt;</span> <span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isKeywordEnd</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">isKeywordEnd</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKeywordEnd</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">keywordEnd</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isKeywordEnd</span> <span class="o">=</span> <span class="n">keywordEnd</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//添加子节点</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addChild</span><span class="o">(</span><span class="nc">Character</span> <span class="n">c</span><span class="o">,</span> <span class="nc">TrieNode</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">children</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">//获取子节点</span>
        <span class="kd">public</span> <span class="nc">TrieNode</span> <span class="nf">getChild</span><span class="o">(</span><span class="nc">Character</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">children</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//过滤敏感词</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">filter</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">text</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">TrieNode</span> <span class="n">tempNode</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="nc">StringBuilder</span> <span class="n">ans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">end</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isSymbol</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">tempNode</span> <span class="o">==</span> <span class="n">rootNode</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ans</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
                    <span class="n">start</span><span class="o">++;</span>
                <span class="o">}</span>
                <span class="n">end</span><span class="o">++;</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">tempNode</span> <span class="o">=</span> <span class="n">tempNode</span><span class="o">.</span><span class="na">getChild</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tempNode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ans</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">start</span><span class="o">));</span>
                <span class="n">start</span><span class="o">++;</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
                <span class="n">tempNode</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tempNode</span><span class="o">.</span><span class="na">isKeywordEnd</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">ans</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">REPLACEMENT</span><span class="o">);</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
                <span class="n">tempNode</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">end</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">ans</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">ans</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//判断是否为符号</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isSymbol</span><span class="o">(</span><span class="nc">Character</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nc">CharUtils</span><span class="o">.</span><span class="na">isAsciiAlphanumeric</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x2E80</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mh">0x9FFF</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="发布帖子">发布帖子</h2>

<p>异步请求：当前网页不刷新，访问服务器，服务器返回一些结果（不是网页），通过这个结果，给网页局部的刷新。</p>

<p>实现技术：AJAX：异步的JavaScript和XML，不是新技术。目前一般不使用XML，而是使用JSON，便于解析。</p>

<p>功能：网页能够增量更新呈现在网页上，而不是刷新整个页面。</p>

<p>手册：Mozilla/AJAX</p>

<h3 id="jquery发送ajax的示例">jQuery发送AJAX的示例</h3>

<p>处理JSON字符串：引入fastjson</p>

<p>写一个简单的静态页面，使用JQuery来发送数据，并接收来自服务器的JSON数据</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>ajax<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"发送"</span> <span class="na">onclick=</span><span class="s">"send();"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://code.jquery.com/jquery-3.3.1.min.js"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
       <span class="kd">function</span> <span class="nx">send</span><span class="p">(){</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
                <span class="dl">"</span><span class="s2">/community/alpha/ajax</span><span class="dl">"</span><span class="p">,</span>
                <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">张三</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">age</span><span class="dl">"</span><span class="p">:</span><span class="mi">23</span><span class="p">},</span>
                <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

                    <span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">);</span>
       <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>服务端控制层代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/ajax"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">testAjax</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">age</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">"操作成功"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>转换成JSON的小工具：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//整合发送给浏览器的json数据</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getJSONString</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">JSONObject</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONObject</span><span class="o">();</span>
    <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
    <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="利用发布帖子功能">利用发布帖子功能</h3>

<p>还是按照数据访问层—&gt;服务层—&gt;控制层的顺序编写代码,</p>

<h4 id="数据访问层">数据访问层</h4>

<p>在dao中的接口定义插入函数,然后再相应的mapper.xml中实现,将帖子插入数据库</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">"insertFields"</span><span class="nt">&gt;</span>
    user_id, title, content, type, status, create_time, comment_count, score
<span class="nt">&lt;/sql&gt;</span>
<span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insertDiscussPost"</span> <span class="na">parameterType=</span><span class="s">"DiscussPost"</span><span class="nt">&gt;</span>
    insert into discuss_post(<span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"insertFields"</span><span class="nt">&gt;&lt;/include&gt;</span>)
    values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score})
<span class="nt">&lt;/insert&gt;</span>
</code></pre></div></div>

<h4 id="业务层">业务层</h4>

<p>将帖子插入数据库,过滤敏感词,转义html标签</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addDiscussPost</span><span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">post</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数不能为空"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//转义HTML标记</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="nc">HtmlUtils</span><span class="o">.</span><span class="na">htmlEscape</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()));</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="nc">HtmlUtils</span><span class="o">.</span><span class="na">htmlEscape</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
    <span class="c1">//过滤敏感词</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">sensitiveFilter</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()));</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">sensitiveFilter</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
    <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">insertDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="控制层">控制层</h4>

<p>获得服务器传来的数据,返回JSON字符串</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/add"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">addDiscussPost</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">403</span><span class="o">,</span> <span class="s">"你还没有登录"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="n">discussPostService</span><span class="o">.</span><span class="na">addDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="c1">//程序如果报错，将来会统一处理</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">"发布成功！"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>更改Index文件,写js代码,处理异步消息</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	<span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#publishBtn</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">publish</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">publish</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#publishModal</span><span class="dl">"</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="dl">"</span><span class="s2">hide</span><span class="dl">"</span><span class="p">);</span>
	<span class="c1">//先返回结果再显示</span>
    <span class="c1">//获取标题/内容</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#recipient-name</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#message-text</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="c1">//发送异步请求</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">/community/discuss/add</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">},</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="c1">//提示框显示返回消息</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#hintBody</span><span class="dl">"</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="c1">//显示提示框/两秒后自动隐藏</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#hintModal</span><span class="dl">"</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#hintModal</span><span class="dl">"</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="dl">"</span><span class="s2">hide</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最终效果如下:</p>

<p><a href="https://imgchr.com/i/yhogHg"><img src="https://s3.ax1x.com/2021/02/19/yhogHg.png" alt="yhogHg.png" /></a></p>

<h2 id="显示帖子详情">显示帖子详情</h2>

<p>利用之前所学的内容，就能实现：</p>

<p>1,数据访问层：查寻帖子</p>

<p>2，业务层：查看帖子</p>

<p>3，控制层：处理查询请求</p>

<p>Index.html：处理详情帖子的链接</p>

<p>discuss-detail.html：显示帖子</p>

<h3 id="开发三层代码">开发三层代码</h3>

<p>数据访问层：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectDiscussPostById"</span> <span class="na">resultType=</span><span class="s">"DiscussPost"</span><span class="nt">&gt;</span>
    select
    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"selectFields"</span><span class="nt">&gt;&lt;/include&gt;</span>
    from discuss_post
    where id = #{id}
<span class="nt">&lt;/select&gt;</span>
</code></pre></div></div>

<p>用户层：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">DiscussPost</span> <span class="nf">findDiscussPostById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPostById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>控制层</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/detail/{discussPostId}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDiscussPost</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"discussPostId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">discussPostId</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//查询帖子</span>
    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPostById</span><span class="o">(</span><span class="n">discussPostId</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
    <span class="c1">//需要显示用户信息，而不是id</span>
    <span class="c1">//两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点</span>
    <span class="c1">//但是之后可以用redies提高速度</span>
    <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"/site/discuss-detail"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="html模板代码">HTML模板代码</h3>

<p>修改index.html的链接</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/discuss/detail/${map.post.id}|}"</span> <span class="na">th:utext=</span><span class="s">"${map.post.title}"</span><span class="nt">&gt;</span>备战春招，面试刷题跟他复习，一个月全搞定！<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>修改discuss-detail.html的内容</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;span</span> <span class="na">th:utext=</span><span class="s">"${post.title}"</span><span class="nt">&gt;</span>备战春招，面试刷题跟他复习，一个月全搞定！<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;img</span> <span class="na">th:src=</span><span class="s">"${user.headerUrl}"</span>
<span class="err">&lt;</span><span class="na">div</span> <span class="na">class=</span><span class="s">"mt-0 text-warning"</span> <span class="na">th:utext=</span><span class="s">"${user.username}"</span><span class="nt">&gt;</span>寒江雪<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;b</span> <span class="na">th:text=</span><span class="s">"${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}"</span><span class="nt">&gt;</span>2019-04-15 15:32:18<span class="nt">&lt;/b&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mt-4 mb-3 content"</span> <span class="na">th:utext=</span><span class="s">"${post.content}"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h2 id="事务管理">事务管理</h2>

<h3 id="概念回顾">概念回顾</h3>

<p>什么是事务：N步数据库操作序列，要么全部执行，要么全部放弃执行（以业务为单元，判断此次操作是否有效）</p>

<p>特性：原子性/一致性/隔离性/持久性</p>

<p>隔离性：针对并发而言，每个线程执行的事务互不干扰。</p>

<p>如果在多线程环境下，没有做多线程隔离（每一个浏览器访问服务器，多会创建一个线程）（多个用户同时访问同一份事务）（需要隔离性处理）</p>

<p>常见并发异常：1，更新。2，脏读。</p>

<p>分层级解决并发异常：串行化：最高级别，加锁，能解决所有问题，但是会造成性能下降。</p>

<p>一般选择：读取已提交数据/可重复读 这两种级别</p>

<p>常见并发异常的含义：</p>

<ol>
  <li>第一类丢失更新：某一个事务的回滚，导致了另外一个事务已更新的数据丢失了。</li>
  <li>第二类丢失更新：某一个事务的提交，导致另一个事务已更新的数据丢失了</li>
  <li>脏读：某一个事务读取了另一个事务未提交的数据，</li>
  <li>不可重复读：某一个事务，对同一数据前后读取结果不一致</li>
  <li>幻读：某一事务，对同一个表，查询到的行数不一致</li>
</ol>

<p>越不安全效率越高。</p>

<p>事务隔离级别与并发异常表格：</p>

<p>实现机制：</p>

<p>悲观锁（数据库）包括共享锁和排他锁</p>

<p>乐观锁（自定义）：更新数据前，需要检查版本号是否变化，如果版本号变了，就取消本次更新</p>

<p>Spring事务管理：</p>

<p>Spring引以为豪的技术点，无论底层是什么数据（库），Spring对其事务管理API都是统一的，非常方便。</p>

<ul>
  <li>在XML或者注解，加上配置就行</li>
  <li>也可以编程式事务，通过Transaction Template管理事务（自由度高，对某一步数据库操作进行管理）</li>
</ul>

<h3 id="spring事务管理示例">Spring事务管理示例</h3>

<p>可以使用注解，代码如下：最终执行结果，数据库中不会出现新的用户和帖子</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//新增用户+自动发一个新人贴</span>
<span class="c1">//传播机制解释：两个事务交叉在一起，如何管理</span>
<span class="c1">//REQUIRED：支持当前事务（支持外部事务）</span>
<span class="c1">//REQUIRES_NEW</span>
<span class="c1">//NESTED:如果当前存在事务（外部事务），则嵌套在该事务中执行</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">,</span> <span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">save1</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//新建用户</span>
    <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"aplha"</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setSalt</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">generateUUID</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">));</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="s">"123"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()));</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="s">"Alpha@qq.com"</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setHeaderUrl</span><span class="o">(</span><span class="s">"http://image/nowcoder.com/head/99t.png"</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setCreatTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="n">userMapper</span><span class="o">.</span><span class="na">insertUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="c1">//新建帖子</span>
    <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"新人贴"</span><span class="o">);</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"新人报到，多多指教"</span><span class="o">);</span>
    <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">insertDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="c1">//报错前会把数据插入吗？</span>
    <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"abc"</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"ok"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>也可以使用TransactionTemplate实现</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">save2</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">setIsolationLevel</span><span class="o">(</span><span class="nc">TransactionDefinition</span><span class="o">.</span><span class="na">ISOLATION_READ_COMMITTED</span><span class="o">);</span>
    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">setPropagationBehavior</span><span class="o">(</span><span class="nc">TransactionDefinition</span><span class="o">.</span><span class="na">PROPAGATION_REQUIRED</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">TransactionCallback</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doInTransaction</span><span class="o">(</span><span class="nc">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//新建用户</span>
            <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"beta"</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setSalt</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">generateUUID</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">));</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="s">"123"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()));</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="s">"beta@qq.com"</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setHeaderUrl</span><span class="o">(</span><span class="s">"http://image/nowcoder.com/head/999.png"</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setCreatTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="n">userMapper</span><span class="o">.</span><span class="na">insertUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
            <span class="c1">//新建帖子</span>
            <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"新人贴,我叫beta"</span><span class="o">);</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"新人报到，多多指教~"</span><span class="o">);</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">insertDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
            <span class="c1">//报错前会把数据插入吗？</span>
            <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"abc"</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"ok"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="显示评论">显示评论</h2>

<p>还是分成三层进行开发</p>

<h3 id="数据层">数据层</h3>

<p>查询一页的评论，需要明确数据表中每个字段的含义：
entity_type:表示评论的对象类型：可以评论帖子，可以评论题目等等，本项目评论对象为帖子</p>

<p>entity_id：表示帖子的Id</p>

<p>target_id：表示这条评论是指向哪个用户的。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CommentMapper</span> <span class="o">{</span>
    <span class="c1">//查询某一页数据/一共多少条数据</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="nf">selectCommentByEntity</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"entityType"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">entityType</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"entityId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">entityId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">selectCountByEntity</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"entityType"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">entityType</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"entityId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">entityId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.nowcoder.community.dao.CommentMapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">"selectFields"</span><span class="nt">&gt;</span>
        id, user_id, entity_type, entity_id, target_id, content, status, create_time
    <span class="nt">&lt;/sql&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectCommentByEntity"</span> <span class="na">resultType=</span><span class="s">"Comment"</span><span class="nt">&gt;</span>
        select
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"selectFields"</span><span class="nt">&gt;&lt;/include&gt;</span>
        from comment
        where status = 0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
        order by create_time asc
        limit #{offset}, #{limit}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectCountByEntity"</span> <span class="na">resultType=</span><span class="s">"int"</span><span class="nt">&gt;</span>
        select count(id)
        from comment
        where status = 0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div></div>

<h3 id="服务层">服务层</h3>

<p>根据评论类型，评论对象，以及页码的一些数据，可以找到所需评论</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommentService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">CommentMapper</span> <span class="n">commentMapper</span><span class="o">;</span>

    <span class="c1">//查询某一页数据</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="nf">findCommentsByEntity</span><span class="o">(</span><span class="kt">int</span> <span class="n">entityType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">entityId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">commentMapper</span><span class="o">.</span><span class="na">selectCommentByEntity</span><span class="o">(</span><span class="n">entityType</span><span class="o">,</span> <span class="n">entityId</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findCommentCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">entityType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">entityId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">commentMapper</span><span class="o">.</span><span class="na">selectCountByEntity</span><span class="o">(</span><span class="n">entityType</span><span class="o">,</span> <span class="n">entityId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="控制层-1">控制层</h3>

<p>需要将查找到的评论装入一个commentVoList，然后装入Model</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//SpringMVC每次会把参数中的bean(Page)都自动放在Model里面</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/detail/{discussPostId}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDiscussPost</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"discussPostId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">discussPostId</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//查询帖子</span>
        <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPostById</span><span class="o">(</span><span class="n">discussPostId</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
        <span class="c1">//需要显示用户信息，而不是id</span>
        <span class="c1">//两种办法，在mapper中关联查询，也可以在controller中查userService，获得用户信息,这样效率会低一点</span>
        <span class="c1">//但是之后可以用redies提高速度</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="c1">//评论分页信息</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/discuss/detail/"</span> <span class="o">+</span> <span class="n">discussPostId</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getCommentCount</span><span class="o">());</span>
        <span class="c1">//评论：帖子的评论</span>
        <span class="c1">//回复：评论的评论</span>
        <span class="c1">//评论的列表</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">commentList</span> <span class="o">=</span>
                <span class="n">commentService</span><span class="o">.</span><span class="na">findCommentsByEntity</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">());</span>
        <span class="c1">//评论的VO列表</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">commentVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">commentList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Comment</span> <span class="n">comment</span> <span class="o">:</span> <span class="n">commentList</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//一个评论的VO</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">commentVo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
                <span class="c1">//往VO添加评论</span>
                <span class="n">commentVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"comment"</span><span class="o">,</span> <span class="n">comment</span><span class="o">);</span>
                <span class="c1">//往VO添加作者</span>
                <span class="n">commentVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">comment</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()));</span>
                <span class="c1">//添加回复</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">replyList</span> <span class="o">=</span>
                        <span class="n">commentService</span><span class="o">.</span><span class="na">findCommentsByEntity</span><span class="o">(</span><span class="no">ENTITY_TYPE_COMMENT</span><span class="o">,</span> <span class="n">comment</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
                <span class="c1">//回复的VO列表</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">replyVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">replyList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">Comment</span> <span class="n">reply</span> <span class="o">:</span> <span class="n">replyList</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">replyVo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
                        <span class="n">replyVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"reply"</span><span class="o">,</span> <span class="n">reply</span><span class="o">);</span>
                        <span class="n">replyVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()));</span>
                        <span class="c1">//回复目标</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getTargetId</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">replyVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"target"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">reply</span><span class="o">.</span><span class="na">getTargetId</span><span class="o">()));</span>
                        <span class="o">}</span> <span class="k">else</span>
                            <span class="n">replyVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"target"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                        <span class="n">replyVoList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">replyVo</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">commentVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"replys"</span><span class="o">,</span> <span class="n">replyVoList</span><span class="o">);</span>
                <span class="n">commentVo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"replyCount"</span><span class="o">,</span> <span class="n">commentService</span><span class="o">.</span><span class="na">findCommentCount</span><span class="o">(</span><span class="no">ENTITY_TYPE_COMMENT</span><span class="o">,</span> <span class="n">comment</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
                <span class="n">commentVoList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">commentVo</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"comments"</span><span class="o">,</span> <span class="n">commentVoList</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"/site/discuss-detail"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="添加评论">添加评论</h2>

<p>增加评论的同时，需要更新帖子表中的评论数量，还是按照三层结构开发。</p>

<h3 id="开发数据层">开发数据层</h3>

<ul>
  <li>增加评论</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insertComment"</span> <span class="na">parameterType=</span><span class="s">"Comment"</span><span class="nt">&gt;</span>
    insert into comment(<span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"insertFields"</span><span class="nt">&gt;&lt;/include&gt;</span>)
    values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime})
<span class="nt">&lt;/insert&gt;</span>
</code></pre></div></div>

<ul>
  <li>更新帖子评论数</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">"updateCommentCount"</span><span class="nt">&gt;</span>
    update discuss_post set comment_count = #{commentCount} where id = #{id}
<span class="nt">&lt;/update&gt;</span>
</code></pre></div></div>

<h3 id="开发服务层">开发服务层</h3>

<ul>
  <li>添加评论</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">,</span> <span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addComment</span><span class="o">(</span><span class="nc">Comment</span> <span class="n">comment</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">comment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数不能为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//添加完评论后，需要更新评论数量</span>
        <span class="n">comment</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="nc">HtmlUtils</span><span class="o">.</span><span class="na">htmlEscape</span><span class="o">(</span><span class="n">comment</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
        <span class="n">comment</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">sensitiveFilter</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">comment</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
        <span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">commentMapper</span><span class="o">.</span><span class="na">insertComment</span><span class="o">(</span><span class="n">comment</span><span class="o">);</span>
        <span class="c1">//如果更新的是帖子</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">comment</span><span class="o">.</span><span class="na">getEntityType</span><span class="o">()</span> <span class="o">==</span> <span class="no">ENTITY_TYPE_POST</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">commentMapper</span><span class="o">.</span><span class="na">selectCountByEntity</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">,</span> <span class="n">comment</span><span class="o">.</span><span class="na">getEntityId</span><span class="o">());</span>
            <span class="n">discussPostService</span><span class="o">.</span><span class="na">updateCommentCount</span><span class="o">(</span><span class="n">comment</span><span class="o">.</span><span class="na">getEntityId</span><span class="o">(),</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rows</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>更新帖子数量</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateCommentCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">commentCount</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">updateCommentCount</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">commentCount</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="开发控制层">开发控制层</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/add/{discussPostId}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">addComment</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"discussPostId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">discussPostId</span><span class="o">,</span> <span class="nc">Comment</span> <span class="n">comment</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//统一的异常处理（如果空）</span>
    <span class="c1">//统一权限认证</span>
    <span class="n">comment</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">comment</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">comment</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="n">commentService</span><span class="o">.</span><span class="na">addComment</span><span class="o">(</span><span class="n">comment</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"redirect:/discuss/detail/"</span> <span class="o">+</span> <span class="n">discussPostId</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="私信列表">私信列表</h2>

<p>指的是朋友私信：</p>

<p>会话是指和某个用户的多条私信，私信列表是会话列表。会话列表只会显示最新的一条私信，而会话详情会包括和某个用户的全部私信。</p>

<p>还需要显示总的会话消息量。</p>

<p>会话ID，小的ID在前面大的ID在后面，为了查询会话数据时，筛选方便。</p>

<p>新建实体类：Message</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">fromId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">toId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">createTime</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getFromId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fromId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFromId</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fromId</span> <span class="o">=</span> <span class="n">fromId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getToId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">toId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setToId</span><span class="o">(</span><span class="kt">int</span> <span class="n">toId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">toId</span> <span class="o">=</span> <span class="n">toId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getConversationId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">conversationId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConversationId</span><span class="o">(</span><span class="nc">String</span> <span class="n">conversationId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">conversationId</span> <span class="o">=</span> <span class="n">conversationId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContent</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getStatus</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">status</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStatus</span><span class="o">(</span><span class="kt">int</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getCreateTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreateTime</span><span class="o">(</span><span class="nc">Date</span> <span class="n">createTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createTime</span> <span class="o">=</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Message{"</span> <span class="o">+</span>
                <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">", fromId="</span> <span class="o">+</span> <span class="n">fromId</span> <span class="o">+</span>
                <span class="s">", toId="</span> <span class="o">+</span> <span class="n">toId</span> <span class="o">+</span>
                <span class="s">", conversationId='"</span> <span class="o">+</span> <span class="n">conversationId</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="s">", content='"</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="s">", status="</span> <span class="o">+</span> <span class="n">status</span> <span class="o">+</span>
                <span class="s">", createTime="</span> <span class="o">+</span> <span class="n">createTime</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="数据层-1">数据层</h3>

<p>数据库中一共只有14个会话，返回对话列表时，需要找到每个会话的最新数据</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageMapper</span> <span class="o">{</span>
    <span class="c1">//查询会话列表一页数据，每个会话，只返回一条最新的私信</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">selectConversations</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>

    <span class="c1">//查询会话列表总行数</span>
    <span class="kt">int</span> <span class="nf">selectConversationCount</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">);</span>

    <span class="c1">//查询详情的总消息数</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">selectLetters</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"conversationId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>

    <span class="c1">//查询详情的当前页面消息</span>
    <span class="kt">int</span> <span class="nf">selectLetterCount</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"conversationId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">);</span>

    <span class="c1">//查询未读消息数量</span>
    <span class="kt">int</span> <span class="nf">selectLetterUnreadCount</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"conversationId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>配置文件如下：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.nowcoder.community.dao.MessageMapper"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">"selectFields"</span><span class="nt">&gt;</span>
        id, from_id, to_id, conversation_id, content, status, create_time
    <span class="nt">&lt;/sql&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectConversations"</span> <span class="na">resultType=</span><span class="s">"Message"</span><span class="nt">&gt;</span>
        select
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"selectFields"</span><span class="nt">&gt;&lt;/include&gt;</span>
        from message where id in(
        select max(id) from message
        where status != 2
        and from_id != 1
        and (from_id = #{userId} or to_id = #{userId})
        group by conversation_id
        )
        order by id desc
        limit #{offset}, #{limit}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectConversationCount"</span> <span class="na">resultType=</span><span class="s">"int"</span><span class="nt">&gt;</span>
        select count(m.maxid) from(
        select max(id) as maxid from message
        where status != 2
        and from_id != 1
        and (from_id = #{userId} or to_id = #{userId})
        group by conversation_id
        ) as m
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectLetters"</span> <span class="na">resultType=</span><span class="s">"Message"</span><span class="nt">&gt;</span>
        select
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"selectFields"</span><span class="nt">&gt;&lt;/include&gt;</span>
        from message
        where status != 2
        and from_id != 1
        and conversation_id = #{conversationId}
        order by id desc
        limit #{offset}, #{limit}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectLetterCount"</span> <span class="na">resultType=</span><span class="s">"int"</span><span class="nt">&gt;</span>
        select count(id)
        from message
        where status != 2
        and from_id != 1
        and conversation_id = #{conversationId}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectLetterUnreadCount"</span> <span class="na">resultType=</span><span class="s">"int"</span><span class="nt">&gt;</span>
        select count(id)
        from message
        where status = 0
        and from_id != 1
        and to_id = #{userId}
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">"conversationId != null"</span><span class="nt">&gt;</span>
            and conversation_id = #{conversationId}
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>

</code></pre></div></div>

<h3 id="服务层-1">服务层</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MessageMapper</span> <span class="n">messageMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">findConversations</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">selectConversations</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">fingConversationCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">selectConversationCount</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">findLetters</span><span class="o">(</span><span class="nc">String</span> <span class="n">conversationId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">selectLetters</span><span class="o">(</span><span class="n">conversationId</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findLetterCount</span><span class="o">(</span><span class="nc">String</span> <span class="n">conversationId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">selectLetterCount</span><span class="o">(</span><span class="n">conversationId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findUnreadCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">selectLetterUnreadCount</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">conversationId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="控制层-2">控制层</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MessageService</span> <span class="n">messageService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">HostHolder</span> <span class="n">hostHolder</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="c1">//处理私信列表</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/letter/list"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLetterList</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>
        <span class="c1">//设置分页信息</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/letter/list"</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">messageService</span><span class="o">.</span><span class="na">fingConversationCount</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
        <span class="c1">//会话列表</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findConversations</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">conversations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">messages</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Message</span> <span class="n">message</span> <span class="o">:</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"conversation"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"unreadCount"</span><span class="o">,</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findUnreadCount</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">message</span><span class="o">.</span><span class="na">getConversationId</span><span class="o">()));</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"letterCount"</span><span class="o">,</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findLetterCount</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getConversationId</span><span class="o">()));</span>
                <span class="kt">int</span> <span class="n">targetId</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">message</span><span class="o">.</span><span class="na">getFromId</span><span class="o">()</span> <span class="o">?</span> <span class="n">message</span><span class="o">.</span><span class="na">getToId</span><span class="o">()</span> <span class="o">:</span> <span class="n">message</span><span class="o">.</span><span class="na">getFromId</span><span class="o">();</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"target"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">targetId</span><span class="o">));</span>
                <span class="n">conversations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"conversations"</span><span class="o">,</span> <span class="n">conversations</span><span class="o">);</span>
        <span class="c1">//查询当前用户未读消息数量</span>
        <span class="kt">int</span> <span class="n">letterUnreadCount</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findUnreadCount</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"letterUnreadCount"</span><span class="o">,</span> <span class="n">letterUnreadCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"/site/letter"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/letter/detail/{conversationId}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLetterDetail</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"conversationId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//分页信息</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/letter/detail/"</span> <span class="o">+</span> <span class="n">conversationId</span><span class="o">);</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">messageService</span><span class="o">.</span><span class="na">findLetterCount</span><span class="o">(</span><span class="n">conversationId</span><span class="o">));</span>
        <span class="c1">//得到了会话的所有私信</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">letterList</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findLetters</span><span class="o">(</span><span class="n">conversationId</span><span class="o">,</span> <span class="n">page</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">());</span>
        <span class="c1">//只需要显示from_user、</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">letters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">letterList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Message</span> <span class="n">letter</span> <span class="o">:</span> <span class="n">letterList</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"letter"</span><span class="o">,</span> <span class="n">letter</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"fromUser"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">letter</span><span class="o">.</span><span class="na">getFromId</span><span class="o">()));</span>
                <span class="n">letters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"letters"</span><span class="o">,</span> <span class="n">letters</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">target</span> <span class="o">=</span> <span class="n">getLetterTarget</span><span class="o">(</span><span class="n">conversationId</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"target"</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"/site/letter-detail"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">User</span> <span class="nf">getLetterTarget</span><span class="o">(</span><span class="nc">String</span> <span class="n">conversationId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">conversationId</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"_"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">id0</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ids</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="kt">int</span> <span class="n">id1</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ids</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">id0</span> <span class="o">==</span> <span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span>
            <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">id1</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">id0</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>模板处理略。</p>

<h2 id="发送私信">发送私信</h2>

<ul>
  <li>
    <p>在私信列表/私信详情内发私信</p>
  </li>
  <li>
    <p>进入私信详情中，未读消息需要变为已读</p>
  </li>
</ul>

<h3 id="数据层-2">数据层</h3>

<p>添加增加私信的功能和修改私信状态的功能</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//新增消息</span>
<span class="kt">int</span> <span class="nf">insertMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">);</span>

<span class="c1">//修改状态</span>
<span class="kt">int</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"ids"</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"status"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">status</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insertMessage"</span> <span class="na">parameterType=</span><span class="s">"Message"</span> <span class="na">keyProperty=</span><span class="s">"id"</span><span class="nt">&gt;</span>
    insert into message(<span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">"insertFields"</span><span class="nt">&gt;&lt;/include&gt;</span>)
    values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime})
<span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">"updateStatus"</span><span class="nt">&gt;</span>
    update message set status = #{status}
    where id in
    <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">"ids"</span> <span class="na">item=</span><span class="s">"id"</span> <span class="na">open=</span><span class="s">"("</span> <span class="na">separator=</span><span class="s">","</span> <span class="na">close=</span><span class="s">")"</span><span class="nt">&gt;</span>
        #{id}
    <span class="nt">&lt;/foreach&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</code></pre></div></div>

<h3 id="服务层-2">服务层</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="nc">HtmlUtils</span><span class="o">.</span><span class="na">htmlEscape</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">sensitiveFilter</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
    <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">insertMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">readMessage</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">messageMapper</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">ids</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="控制层-3">控制层</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">getLetterIds</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">letterList</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">letterList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Message</span> <span class="n">letter</span> <span class="o">:</span> <span class="n">letterList</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">letter</span><span class="o">.</span><span class="na">getToId</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">letter</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">letter</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">ids</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/letter/detail/{conversationId}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLetterDetail</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"conversationId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">conversationId</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//分页信息</span>
    <span class="n">page</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/letter/detail/"</span> <span class="o">+</span> <span class="n">conversationId</span><span class="o">);</span>
    <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">messageService</span><span class="o">.</span><span class="na">findLetterCount</span><span class="o">(</span><span class="n">conversationId</span><span class="o">));</span>
    <span class="c1">//得到了会话的所有私信</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">letterList</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">findLetters</span><span class="o">(</span><span class="n">conversationId</span><span class="o">,</span> <span class="n">page</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">());</span>
    <span class="c1">//只需要显示from_user、</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">letters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">letterList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Message</span> <span class="n">letter</span> <span class="o">:</span> <span class="n">letterList</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"letter"</span><span class="o">,</span> <span class="n">letter</span><span class="o">);</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"fromUser"</span><span class="o">,</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">letter</span><span class="o">.</span><span class="na">getFromId</span><span class="o">()));</span>
            <span class="n">letters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"letters"</span><span class="o">,</span> <span class="n">letters</span><span class="o">);</span>
    <span class="nc">User</span> <span class="n">target</span> <span class="o">=</span> <span class="n">getLetterTarget</span><span class="o">(</span><span class="n">conversationId</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"target"</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">getLetterIds</span><span class="o">(</span><span class="n">letterList</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">ids</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">messageService</span><span class="o">.</span><span class="na">readMessage</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">"/site/letter-detail"</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">User</span> <span class="nf">getLetterTarget</span><span class="o">(</span><span class="nc">String</span> <span class="n">conversationId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">conversationId</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"_"</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">id0</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ids</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="kt">int</span> <span class="n">id1</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ids</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">id0</span> <span class="o">==</span> <span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">id1</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">id0</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/letter/send"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="c1">//因为是异步请求</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">sendLetter</span><span class="o">(</span><span class="nc">String</span> <span class="n">toName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="n">target</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">toName</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"目标用户不存在"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">();</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setFromId</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setToId</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getFromId</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">message</span><span class="o">.</span><span class="na">getToId</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setConversationId</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getFromId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">getToId</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setConversationId</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getToId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">getFromId</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
    <span class="n">message</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="n">messageService</span><span class="o">.</span><span class="na">addMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="c1">//统一解决异常</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>前端模板代码略</p>

<h2 id="统一处理异常">统一处理异常</h2>

<p>服务器分为三层，如果数据层出异常了，会把异常抛给业务层，最后抛给表现层。</p>

<p>所以所有的异常都会汇聚到表现层，我们统一的处理表现层异常即可。</p>

<p>SpringBoot提供的方案：在项目的某一个路径下，加上对应错误页面，自动跳转到这个页面即可。</p>

<h3 id="spring-boot处理异常演示">Spring Boot处理异常演示</h3>

<p>首先需要把错误页面文件夹error移动到templates目录下，发生错误自动跳转</p>

<h3 id="spring统一处理异常">Spring统一处理异常</h3>

<p>注解：@ControllerAdvice</p>

<p>对controller全局统一配置，对任意controller发生异常，都可以全局统一处理，可以使用以下三种配置</p>

<p>@ModelAttribute绑定数据：controller中有很多请求，都需要使用某一个参数，可以使用此注解，对model中统一绑定一个参数</p>

<p>@DataBinder:SpringMVC有很多转换器，将页面发来的数据转换成服务器的数据类型，当内置的转换器不够用，可以使用此配置，自定义转换</p>

<p>@ExceptionHandler：统一捕获异常</p>

<p>在Controller中新建advice包，并实现统一处理异步请求和普通请求的异常，如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ControllerAdvice</span><span class="o">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="nc">Controller</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExceptionAdvice</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ExceptionAdvice</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@ExceptionHandler</span><span class="o">({</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleException</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">,</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"服务器发生异常"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">StackTraceElement</span> <span class="n">element</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">getStackTrace</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">xRequestedWith</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"x-requested-with"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"XMLHttpRequest"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">xRequestedWith</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/plain;charset=utf-8"</span><span class="o">);</span>
            <span class="nc">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"服务器异常"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/error"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h2 id="统一记录日志">统一记录日志</h2>

<p>记录日志的代码封装到一个组件，在不同的service中调用，但是这样会把系统需求和业务需求耦合在一起。</p>

<p>把系统需求单独实现：AOP（面向切面编程）（对OOP的补充）（提高编程效率）</p>

<h3 id="aop">AOP</h3>

<p>每个业务模块都有相同的系统需求，只需要单独的定义系统组件，包含各种业务组件。</p>

<p>常见术语：</p>

<ul>
  <li>一批业务组件（目标）：target（有很多地方可以织入代码）</li>
  <li>代码单独封装在一个组件，称为方面组件，编程针对于方面（切面）</li>
  <li>将方面组件代码织入（weaving)到目标中，有多种织入方式
    <ul>
      <li>编译时织入</li>
      <li>装载时织入</li>
      <li>运载时织入</li>
    </ul>
  </li>
  <li>目标代码上，有可能织入的位置，称为连接点（Joinpoint）</li>
  <li>Pointcut：声明具体织入到哪些对象的哪些位置（方面组件中）</li>
  <li>Advice：解决具体织入逻辑（调用前？调用后？返回后？异常时？）（方面组件中）</li>
</ul>

<p>如何实现：常见有AspectJ和Spring AOP，其中AspectJ是新的语言，能解决所有AOP问题，在编译时织入代码，支持所有连接点。</p>

<p>SpringAOP纯JAVA实现，运行时织入代码（通过代理），只支持方法类型的织入点（局限），支持对AspectJ的集合。</p>

<p>代理：在某个对象生成代理对象，调用时只调用代理对象。</p>

<p>SpringAOP默认使用JDK动态代理，在运行时创建接口的代理实例，通过接口的代理实例织入代码，CGLib动态代理：底层字节码技术，通过子类实现代理。</p>

<h3 id="aop统一处理service">AOP统一处理Service</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceAspect</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ServiceAspect</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution(* com.nowcoder.community.service.*.*(..))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">pointcut</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"pointcut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//用户（ip)在某一时间，访问了什么方法（service）</span>
        <span class="nc">ServletRequestAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span> <span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">();</span>
        <span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteHost</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="nc">String</span> <span class="n">target</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"用户[%s],在[%s]，访问了[%s]."</span><span class="o">,</span> <span class="n">ip</span><span class="o">,</span> <span class="n">now</span><span class="o">,</span> <span class="n">target</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注意如何获得当前请求的ip地址，当前接入点的方法名。</p>

</article>
      </div>
    </main>

    
  </body>
</html>