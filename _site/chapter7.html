<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>社区论坛：性能提升和安全模块</title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="社区论坛：性能提升和安全模块" />
<meta name="author" content="tie" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chapter 7 提高系统性能 提高系统安全性 Spring Security 提高身份认证和授权（帖子置顶/加精/删除） 方便扩展，自定义 防止各种攻击 可以和各种web开发集成（Spring MVC） 底层思路 Spring MVC ： DispatcherServlet —&gt; controller 一对多，其中拦截器可以在其中拦截请求，在DispatcherServlet之前，还有一个filter，可以对DispatcherServlet进行拦截，其中DispatcherServlet和filter都是javaEE的规范。 Spring Security利用Filter统一规范认证/授权，大概11个。（判断时机比较靠前） Spring Security是Spring中比较难的，比较建议学习，对框架理解比较好。可以参考这里的教程 演示Demo 打开demo，并导入Security组件，会自动为系统配置。 导入后，需要使用账号密码才能访问首页。账号为user，密码在服务端console可以看到 可以把这个登录页面换成自己的。 需要将User实现UserDetails接口 根绝type来定义用户的权限（但是是字符串”USER”“ADMIN” @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return true; } @Override //凭证未过期 public boolean isCredentialsNonExpired() { return true; } @Override //账号可用 public boolean isEnabled() { return true; } public void setUsername(String username) { this.username = username; } @Override //关键：权限 public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { List&lt;GrantedAuthority&gt; list = new ArrayList&lt;&gt;(); list.add(new GrantedAuthority() { @Override public String getAuthority() { switch (type){ case 1: return &quot;ADMIN&quot;; default: return &quot;USER&quot;; } } }); return list; } 在UserService中实现UserDetailsService 实现此接口可以帮助Security来查询用户 @Override //和findUserByName的功能是一样的，但是实现这个方法，security可以帮助我们检查登录 public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { return this.findUserByName(username); } 配置SecurityConfig（重点） 包括如下配置： 忽略静态资源的权限判断 实现”账号-密码”认证类的配置 配置”认证“相关消息 登录页面 配置连接的权限 在账号-密码filter前面增加一个filter 转发 VS 重定向 添加Remember-me功能 @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private UserService userService; @Override public void configure(WebSecurity web) throws Exception { //忽略静态资源 web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //对认证处理，auth:认证核心结构，用于构造接口实例 //常见实现类：provideManager为其默认实现类 //没有验证码 protected void configure(AuthenticationManagerBuilder auth) throws Exception { //内置的认证规则 //auth.userDetailsService(userService).passwordEncoder(new Pbkdf2PasswordEncoder(&quot;12345&quot;)); //自定义认证规则 //有多种AuthenticationProvider，每一种访问一种认证 //AuthenticationManagerBuilder自己不去做认证，委托给AuthenticationProvider auth.authenticationProvider(new AuthenticationProvider() { @Override //实现账号密码认证 //authentication用于封装认证信息的接口，不同的实现类代表不同类型的认证信息 public Authentication authenticate(Authentication authentication) throws AuthenticationException { String username = authentication.getName(); String password = (String) authentication.getCredentials(); User user = userService.findUserByName(username); if(user == null){ throw new UsernameNotFoundException(&quot;账号不存在&quot;); } password = CommunityUtil.md5(password+user.getSalt()); if(!user.getPassword().equals(password)){ throw new BadCredentialsException(&quot;密码不正确&quot;); } //认证的主要信息 + 证书 + 权限 return new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities()); } //返回当前接口是哪种类型，账号密码？指纹？短信？ @Override public boolean supports(Class&lt;?&gt; aClass) { //UsernamePasswordAuthenticationToken是authentication的常用的实现类，表示账号密码认证模式 return UsernamePasswordAuthenticationToken.class.equals(aClass); } }); } @Override //认证 protected void configure(HttpSecurity http) throws Exception { //配置登录相关的配置，告诉那个请求是登录 http.formLogin() .loginPage(&quot;/loginpage&quot;) .loginProcessingUrl(&quot;/login&quot;) .successHandler(new AuthenticationSuccessHandler() { @Override public void onAuthenticationSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }) .failureHandler(new AuthenticationFailureHandler() { @Override public void onAuthenticationFailure(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e) throws IOException, ServletException { //不能重定向,要用转发 //重定向：适合两个独立组件，当组件A完成没有什么东西返回时，（302）重定向到B，此时A不能给B带数据 //转发：两个独立组件，A只能完成请求的一半，然后由B处理，但是此时浏览器不知道B的存在（A和B有耦合） //此处：A:login --&gt; B:loginpage，也可以用模板，但是此处不行，不再controller内 httpServletRequest.setAttribute(&quot;error&quot;, e.getMessage()); httpServletRequest.getRequestDispatcher(&quot;/loginpage&quot;).forward(httpServletRequest, httpServletResponse); } }); http.logout() .logoutUrl(&quot;/logout&quot;) .logoutSuccessHandler(new LogoutSuccessHandler() { @Override public void onLogoutSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }); //配置授权 http.authorizeRequests() .antMatchers(&quot;/letter&quot;).hasAnyAuthority(&quot;USER&quot;, &quot;ADMIN&quot;) .antMatchers(&quot;/admin&quot;).hasAnyAuthority(&quot;ADMIN&quot;) .and().exceptionHandling().accessDeniedPage(&quot;/denied&quot;); //增加filter http.addFilterBefore(new Filter(){ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; if(request.getServletPath().equals(&quot;/login&quot;)){ String verifyCode = request.getParameter(&quot;verifyCode&quot;); if(verifyCode == null || !verifyCode.equalsIgnoreCase(&quot;1234&quot;)){ request.setAttribute(&quot;error&quot;,&quot;验证码错误&quot;); request.getRequestDispatcher(&quot;/loginpage&quot;).forward(request, response); return; } } //放行请求，请求继续执行 filterChain.doFilter(request,response); } },UsernamePasswordAuthenticationFilter.class); http.rememberMe() .tokenRepository(new InMemoryTokenRepositoryImpl()) .tokenValiditySeconds(3600 * 24) .userDetailsService(userService); } } 修改页面模板 在Security中，logout功能必须是post请求 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;首页&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;社区首页&lt;/h1&gt; &lt;!--欢迎信息--&gt; &lt;p th:if=&quot;${loginUser!=null}&quot;&gt; 欢迎你，&lt;span th:text=&quot;${loginUser.username}&quot;&gt;&lt;/span&gt; &lt;/p&gt; &lt;ul&gt; &lt;li&gt;&lt;a th:href=&quot;@{/discuss}&quot;&gt;帖子详情&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/letter}&quot;&gt;私信列表&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;登录&lt;/a&gt;&lt;/li&gt; &lt;!--&lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;退出&lt;/a&gt;&lt;/li&gt;--&gt; &lt;!-- *Security实现的logout必须是post --&gt; &lt;li&gt; &lt;form method=&quot;post&quot; th:action=&quot;@{/logout}&quot;&gt; &lt;a href=&quot;javascript:document.forms[0].submit();&quot;&gt;退出&lt;/a&gt; &lt;/form&gt; &lt;/li&gt; &lt;/ul&gt; &lt;/body&gt; &lt;/html&gt; 权限控制 废弃拦截器，使用SpringSecurity来进行登录检查 授权配置，分配权限：普通用户，版主，管理员 使用原有认证方案：登录退出使用原来的代码 CSRF配置：防止CSRF攻击 废弃拦截器 在WebMvcConfig中，讲login拦截器注释掉 设置权限 对一些路径进行权限设置/ @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant { @Override //忽略静态资源 public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //授权 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .anyRequest().permitAll() .and().csrf().disable(); //没有权限的异常处理 http.exceptionHandling() .accessDeniedHandler(new AccessDeniedHandler() { @Override //权限不足处理 public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (xRequestedWith.equals(&quot;XMLHttpRequest&quot;)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您无权限访问此功能&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/denied&quot;); } } }) .authenticationEntryPoint(new AuthenticationEntryPoint() { @Override //没有登录处理 public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您还没有登录，请登录&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/login&quot;); } } }); //默认Logout退出，会用filter拦截 //将security中的默认登出路径设置如下，避免覆盖我们自己的登出代码 http.logout().logoutUrl(&quot;/securityLogout&quot;); //Security获得权限需要在SecurityContext里获得 } } 在LoginTicket拦截器中，对登录的用户配置权限（因为在没有用security处理登录时，SecurityContext没有用户的权限信息，需要我们手动添加） @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //从cookie中获取ticket String ticket = CookieUtil.getValue(request, &quot;ticket&quot;); if (ticket != null) { LoginTicket loginTicket = userService.findLoginTicket(ticket); if (loginTicket != null &amp;&amp; loginTicket.getStatus() == 0 &amp;&amp; loginTicket.getExpired().after(new Date())) { User user = userService.findUserById(loginTicket.getUserId()); //在本此请求中持有用户，考虑多线程并发，多线程隔离 hostHolder.setUser(user); //构建用户认证结果，并存入SecurityContext,以便于Security进行权限管理 Authentication authentication = new UsernamePasswordAuthenticationToken( user, user.getPassword(), userService.getAuthorities(user.getId()) ); SecurityContextHolder.setContext(new SecurityContextImpl(authentication)); } } return true; } CSRF原理 某一网站盗取Cookie中的凭证（ticket），从而模拟用户提交表单。 解决办法：引入Security后，用户请求提交表单时，Security会在表单中加一个隐藏的Token，其他网站能够窃取到你的Ticket，但是无法获得你的表单数据（其中的Token），从而会被服务器发现。 问题：异步请求的时候需要自己处理，演示如下： &lt;!--&lt;meta name=&quot;_csrf&quot; th:content=&quot;${_csrf.token}&quot;&gt;--&gt; &lt;!--&lt;meta name=&quot;_csrf_header&quot; th:content=&quot;${_csrf.headerName}&quot;&gt;--&gt; $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //发送AJAX请求前，需要带上CSRF令牌 // var token = $(&quot;mata[name=&#39;_csrf&#39;]&quot;).attr(&quot;content&quot;); // var header = $(&quot;mata[name=&#39;_csrf_header&#39;]&quot;).attr(&quot;content&quot;); // $(document).ajaxSend(function(e, xhr, options){ // xhr.setRequestHeader(header, token); // }); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 置顶，加精，删除 功能实现：置顶—&gt;修改帖子类型，加精，删除 —&gt; 修改帖子状态 权限管理：用security设置即可 按钮显示：thymeleaf可以支持Security，但是需要添加包 实现置顶，加精，删除 数据层 int updateType(@Param(&quot;id&quot;) int id, @Param(&quot;type&quot;) int type); int updateStatus(@Param(&quot;id&quot;) int id, @Param(&quot;status&quot;) int status); 服务层 public int updateType(int id, int type) { return discussPostMapper.updateType(id, type); } public int updateStatus(int id, int status) { return discussPostMapper.updateStatus(id, status); } 控制层 //置顶 @RequestMapping(path = &quot;/top&quot;, method = RequestMethod.POST) @ResponseBody public String setTop(int id) { discussPostService.updateType(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //加精 @RequestMapping(path = &quot;/wonderful&quot;, method = RequestMethod.POST) @ResponseBody public String setWonderful(int id) { discussPostService.updateStatus(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //删除 @RequestMapping(path = &quot;/delete&quot;, method = RequestMethod.POST) @ResponseBody public String setDelete(int id) { discussPostService.updateStatus(id, 2); //帖子同步ES //触发发帖事件 //触发删帖事件 Event event = new Event() .setTopic(TOPIC_DELETE) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } 设置权限 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/top&quot;, &quot;/discuss/wonderful&quot; ) .hasAnyAuthority( AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/delete&quot; ) .hasAnyAuthority( AUTHORITY_ADMIN ) .anyRequest().permitAll() .and().csrf().disable(); Redis高级数据类型 HyperLogLog：超级日志 基数算法，独立总数统计，多次请求去重 数据占用空间少，只占12K的内存空间 不精确的统计算法，标准误差为0.81% Bitmap：位图 特殊格式字符串，按位存储数据 其实是byte数组 大量连续数据的布尔值，如每天的签到。如一年的签到数据：365/8，只有40多个字节 都适合用来给网站运营的数据进行统计，并且节约内存 使用redis中的hyperloglog和bitmap，代码如下： //统计20W个数据的独立整合 @Test public void testHyperLogLog() { String redisKey = &quot;test:hll:01&quot;; for (int i = 1; i &lt;= 100000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey, i); } for (int i = 1; i &lt;= 100000; i++) int r = (int) (Math.random() * 10000 + 1); redisTemplate.opsForHyperLogLog().add(redisKey, r); } long size = redisTemplate.opsForHyperLogLog().size(redisKey); System.out.println(size); } //将三组数据合并，在合并后的重复数据中，统计独立正数 @Test public void testHyperLogLogUnion() { String redisKey2 = &quot;test:hll:02&quot;; for (int i = 1; i &lt;= 10000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey2, i); } String redisKey3 = &quot;test:hll:03&quot;; for (int i = 5001; i &lt;= 15000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey3, i); } String redisKey4 = &quot;test:hll:04&quot;; for (int i = 10001; i &lt;= 20000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey4, i); } String unionKey = &quot;test:hll:union&quot;; redisTemplate.opsForHyperLogLog().union(unionKey, redisKey2, redisKey3, redisKey4); long size = redisTemplate.opsForHyperLogLog().size(unionKey); System.out.println(size); } //统计一组数据的布尔值 @Test public void testBitMap() { String redisKey = &quot;test:bm:01&quot;; //记录 redisTemplate.opsForValue().setBit(redisKey, 1, true); redisTemplate.opsForValue().setBit(redisKey, 4, true); redisTemplate.opsForValue().setBit(redisKey, 7, true); //查询 System.out.println(redisTemplate.opsForValue().getBit(redisKey, 0)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 1)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 2)); //统计 Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } //统计三组数据布尔值，并进行or运算 @Test public void testBitMapOperation() { String redisKey2 = &quot;test:bm:02&quot;; redisTemplate.opsForValue().setBit(redisKey2, 0, true); redisTemplate.opsForValue().setBit(redisKey2, 1, true); redisTemplate.opsForValue().setBit(redisKey2, 2, false); String redisKey3 = &quot;test:bm:03&quot;; redisTemplate.opsForValue().setBit(redisKey3, 2, true); redisTemplate.opsForValue().setBit(redisKey3, 3, true); redisTemplate.opsForValue().setBit(redisKey3, 4, false); String redisKey4 = &quot;test:bm:04&quot;; redisTemplate.opsForValue().setBit(redisKey4, 4, true); redisTemplate.opsForValue().setBit(redisKey4, 5, true); redisTemplate.opsForValue().setBit(redisKey4, 6, false); String redisKey = &quot;test:bm:or&quot;; Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), redisKey2.getBytes(), redisKey3.getBytes(), redisKey4.getBytes()); return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } } 网站数据统计 UV：独立访客，通过IP地址统计，希望把匿名用户（游客）也统计起来。每次访问都要统计，因为不确定此次访问的IP是否已经记录过。用HyperLogLog进行统计。 DAU：日活跃用户，访问过一次则认为其是活跃或用。与UV的区别是：通过userId进行排重（已注册用户），而且是比较精确的结果，故使用bitmap。可以用UserId为Index,在redis中存储，（key为日期），所以每天需要大概几十万位。 定义RedisKey 分别定义UA和DAU的rediskey //单日UV public static String getUVKey(String date) { return PREFIX_UV + SPLIT + date; } //区间UV public static String getUVKey(String startDate, String endDate) { return PREFIX_UV + SPLIT + startDate + SPLIT + endDate; } //单日DAU public static String getDAUKey(String date) { return PREFIX_DAU + SPLIT + date; } //区间DAU public static String getDAUKey(String startDate, String endDate) { return PREFIX_DAU + SPLIT + startDate + SPLIT + endDate; } DataService @Service public class DataService { @Autowired private RedisTemplate redisTemplate; private SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyyMMdd&quot;); //记录UV数据，记录指定IP public void recordIV(String ip) { String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(new Date())); redisTemplate.opsForHyperLogLog().add(redisKey, ip); } //统计指定范围内的UV public long calculateUV(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;String&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getUVKey(dateFormat.format(calendar.getTime())); keyList.add(key); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(start), dateFormat.format(end)); redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray()); return redisTemplate.opsForHyperLogLog().size(redisKey); } //记录指定用户到DAU public void recordDAU(int userId) { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(new Date())); redisTemplate.opsForValue().setBit(redisKey, userId, true); } //统计指定范围内的DAU public long calculateDAU(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;byte[]&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getDAUKey(dateFormat.format(calendar.getTime())); keyList.add(key.getBytes()); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); return (long) redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), keyList.toArray(new byte[0][0])); return connection.bitCount(redisKey.getBytes()); } }); } } 拦截器 每次请求需要判断Ip和用户 @Component public class Datainteceptor implements HandlerInterceptor { @Autowired private DataService dataService; @Autowired private HostHolder hostHolder; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //记录UV String ip = request.getRemoteHost(); dataService.recordIV(ip); //记录DAU User user = hostHolder.getUser(); if (user != null) { dataService.recordDAU(user.getId()); } return true; } } Controller 实现访问数据页/查询UV/查询dau的功能 @Controller public class DataController { @Autowired private DataService dataService; @RequestMapping(path = &quot;/data&quot;, method = {RequestMethod.GET, RequestMethod.POST}) public String getDataPage() { return &quot;/site/admin/data&quot;; } @RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST) public String getUV(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateUV(start, end); model.addAttribute(&quot;uvResult&quot;, uv); model.addAttribute(&quot;uvStartDate&quot;, start); model.addAttribute(&quot;uvEndDate&quot;, end); return &quot;forward:/data&quot;; } @RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST) public String getDAU(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateDAU(start, end); model.addAttribute(&quot;dauResult&quot;, uv); model.addAttribute(&quot;dauStartDate&quot;, start); model.addAttribute(&quot;dauEndDate&quot;, end); return &quot;forward:/data&quot;; } } 配置权限 在SecurityConfig下添加路径即可 任务执行和调度 JDK线程池 ExecutorService ScheduledExecutorService Spring线程池 ThreadPoolTaskExecutor ThreadPoolTaskScheduler 分布式定时任务 Spring Quartz 在分布式部署中，使用JDK或者Spring的线程池调度，会有问题。在分布式服务器中，请求会通过Nginx来分配，从而可以实现负载均衡，但是Scheduler不能被Nigix管理，所以同一的Scheduler请求，可能会在多服务器执行多次。 使用Quartz，不同服务器的Scheduler运行时，会在数据库服务器访问运行数据，通过排队（加锁），可以使得程序只运行一次。 JDK线程池演示 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ThreadPoolTest { private static final Logger logger = LoggerFactory.getLogger(ThreadPoolTest.class); //演示JDK普通线程池 //包含5个线程 private ExecutorService executorService = Executors.newFixedThreadPool(5); //定时执行任务的线程池 private ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(5); //使用test方法，让当前线程sleep，以避免线程自动结束 private void sleep(long m) { try { Thread.sleep(m); } catch (InterruptedException e) { e.printStackTrace(); } } //演示JDK普通线程池 @Test public void testExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, executorService&quot;); } }; for (int i = 0; i &lt; 10; i++) { executorService.submit(task); } sleep(10000); } //JDK定时任务线程池 @Test public void testScheduledExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, scheduledExecutorService&quot;); } }; scheduledExecutorService.scheduleAtFixedRate(task, 10000, 1000, TimeUnit.MILLISECONDS); sleep(30000); } } Spring线程池 配置： #TaskExecutionProperties spring.task.execution.pool.core-size=5 spring.task.execution.pool.max-size=15 spring.task.execution.pool.queue-capacity=100 #TaskSchedulingProperties spring.task.scheduling.pool.size=5 演示： //演示Spring普通线程池 @Test public void testThreadPoolTaskExecutor() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskExecutor&quot;); } }; for (int i = 0; i &lt; 10; i++) taskExecutor.submit(task); sleep(10000); } //演示Spring定时线程 @Test public void testThreadPoolTaskScheduler() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskScheduler&quot;); } }; Date startTime = new Date(System.currentTimeMillis() + 10000); taskScheduler.scheduleAtFixedRate(task, startTime, 1000); sleep(30000); } Spring使用多线程的简单方法 通过注解即可 @Async public void execute1() { System.out.println(&quot;当前执行线程为&quot; + Thread.currentThread().getName()); } @Scheduled(initialDelay = 10000, fixedDelay = 1000) public void scheduled1() { System.out.println(&quot;当前执行定时任务，执行线程为 ---&gt;&quot; + Thread.currentThread().getName()); } //Spring多线程简便方法 @Test public void testThreadPoolTaskExecutorSimple() { for (int i = 0; i &lt; 10; i++) alphaService.execute1(); sleep(10000); } //Spring定时任务简化 @Test public void testThreadPoolTaskSchedulerSimple() { sleep(30000); } Quartz演示 需要提前创建Database，其中存放运行定时任务，所需要的信息 默认读取内存中数据，所以需要配置 # QuartzProperties spring.quartz.job-store-type=jdbc spring.quartz.scheduler-name=communityScheduler spring.quartz.properties.org.quartz.scheduler.instanceId=AUTO spring.quartz.properties.org.quartz.jobStore.class=org.quartz.impl.jdbcjobstore.JobStoreTX spring.quartz.properties.org.quartz.jobStore.driverDelegateClass=org.quartz.impl.jdbcjobstore.StdJDBCDelegate spring.quartz.properties.org.quartz.jobStore.isClustered=true spring.quartz.properties.org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool spring.quartz.properties.org.quartz.threadPool.threadCount=5 定义QuarzJob public class AlphaJob implements Job { @Override public void execute(JobExecutionContext context) throws JobExecutionException { System.out.println(Thread.currentThread().getName() + &quot;: execute quartz job&quot;); } } 配置Quartz @Configuration public class QuartzConfig { //FactoryBean，可以简化Bean的实例化过程 //1.通过factoryBean封装Bean的实例化过程 //2.将FactorBean装配到容器里 //3.FactoryBean注入给其他的Bean， //4.其他的Bean得到了FactoryBean所管理的实例对象 @Bean public JobDetailFactoryBean alphaJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(AlphaJob.class); factoryBean.setName(&quot;alphaJob&quot;); factoryBean.setGroup(&quot;alphaGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } @Bean public SimpleTriggerFactoryBean simpleTrigger(JobDetail alphaJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(alphaJobDetail); factoryBean.setName(&quot;alphaTrigger&quot;); factoryBean.setGroup(&quot;alphaTriggerGroup&quot;); factoryBean.setRepeatInterval(3000); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } } 此时上述Job就能在项目启动后，自动运行，如果需要删除，可执行如下代码 public class QuartzTest { @Autowired private Scheduler scheduler; @Test public void testDeleteJob() { try { boolean result = scheduler.deleteJob(new JobKey(&quot;alphaJob&quot;, &quot;alphaGroup&quot;)); System.out.println(result); } catch (SchedulerException e) { e.printStackTrace(); } } } 热帖排名 时间增加，分数减小，评论/收藏/点赞越多，分数越高。 分数计算方式：定时算一次，从而能保证帖子的分数一段时间是不变的。 只算分数变化的帖子 —&gt; 把分数变化的帖子放在Redis中。 统计帖子分数 RedisKey public static String getPostScore() { return PREFIX_POSt + SPLIT + &quot;socre&quot;; } 能修改帖子分数的地方，存入Redis 包括点赞/评论/发帖/加精 定义定时任务 每隔5分钟运行一次 @Bean public JobDetailFactoryBean postScoreRefreshJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(PostScoreReferenceJob.class); factoryBean.setName(&quot;postScoreReferenceJob&quot;); factoryBean.setGroup(&quot;communityJobGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } //刷新帖子分数 @Bean public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(postScoreRefreshJobDetail); factoryBean.setName(&quot;postScoreRefreshTrigger&quot;); factoryBean.setGroup(&quot;communityTriggerGroup&quot;); factoryBean.setRepeatInterval(1000 * 60 * 5); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } 计算分数（job) public class PostScoreReferenceJob implements Job, CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(PostScoreReferenceJob.class); //牛客纪元 private static final Date epoch; static { try { epoch = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(&quot;2014-08-01 00:00:00&quot;); } catch (ParseException e) { throw new RuntimeException(&quot;初始化牛客网纪元失败&quot; + e); } } @Autowired private RedisTemplate redisTemplate; @Autowired private DiscussPostService discussPostService; @Autowired private LikeService likeService; @Autowired private ElasticsearchService elasticsearchService; @Override public void execute(JobExecutionContext context) throws JobExecutionException { String redisKey = RedisKeyUtil.getPostScore(); BoundSetOperations operations = redisTemplate.boundSetOps(redisKey); if (operations.size() == 0) { logger.info(&quot;任务取消，没有需要重新计分的帖子&quot;); } logger.info(&quot;任务开始，正在计算帖子分数： &quot; + operations.size()); while (operations.size() &gt; 0) { this.refresh((Integer) operations.pop()); } logger.info(&quot;帖子分数计算结束！&quot;); } private void refresh(int postId) { DiscussPost post = discussPostService.findDiscussPostById(postId); if (post == null) { logger.error(&quot;帖子不存在，postId :&quot; + postId); return; } //计算是否加精，评论数，点赞数 boolean wonderful = post.getStatus() == 1; int commentCount = post.getCommentCount(); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId); //计算权重 double w = (wonderful ? 75 : 0) + commentCount * 10 + likeCount * 2; double score = Math.log10(Math.max(w, 1)) + (post.getCreateTime().getTime() - epoch.getTime()) / (1000 * 3600 * 24); //更新帖子的分数 discussPostService.updateScore(postId, score); //同步service post.setScore(score); elasticsearchService.saveDiscussPost(post); } } 修改排序方式 数据访问层 @Mapper public interface DiscussPostMapper { List&lt;DiscussPost&gt; selectDiscussPosts(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit, @Param(&quot;orderMode&quot;) int orderMode); 服务层 public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } 控制层 orderMode通过路径传过来 @RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET) public String getIndexPage(Model model, Page page, @RequestParam(name = &quot;orderMode&quot;, defaultValue = &quot;0&quot;) int orderMode) { page.setRows(discussPostService.findDiscussPostsRows(0)); page.setPath(&quot;/index?orderMode=&quot; + orderMode); //在方法调用前，SpringMVC会自动实例化Page和Model，并且将Page注入Model //所以可以在thymeleaf中直接访问Page对象中的数据。 List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit(), orderMode); List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); for (DiscussPost post : list) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); User user = userService.findUserById(post.getUserId()); map.put(&quot;user&quot;, user); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()); map.put(&quot;likeCount&quot;, likeCount); discussPosts.add(map); } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;orderMode&quot;, orderMode); return &quot;/index&quot;; } Idea查看方法调用的快捷键：alt + F7 生成长图 将模板文件转换为PDF（在服务端） 使用wkhtmltopdf 1，wkhtmltopdf url file 2，wkhtmltoimage url file 通过java Runtime.getRuntime().exec(); 官网 配置环境变量 通过命令访问工具 wkhtmltoimage --quality 75 https://www.nowcoder.com d:/Java/nowcoder_project/wk_image/1.png 模拟分享功能 将命令行设置为可配置，将图片位置设置为可配，检查路径是否存在（wk不能生成路径） 创建配置文件： #wk wk.image.command=d:/Java/nowcoder_project/wkhtmltopdf/bin/wkhtmltoimage wk.image.storage=d:/Java/nowcoder_project/wk_image ShareController 使用Kafka，并且异步驱动，可以节省时间 @Controller public class ShareController implements CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(ShareController.class); @Autowired private EventProducer eventProducer; @Value(&quot;${community.path.domain}&quot;) private String domain; @Value(&quot;${server.servlet.context-path}&quot;) private String contextPath; @Value(&quot;${wk.image.storage}&quot;) private String wkImageStorage; //生成图片：异步驱动 //处理为事件，因为生成的时间可能比较长，用户不需要在页面等待。 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, domain + contextPath + &quot;/share/image/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } //获取长图 @RequestMapping(path = &quot;/share/image/{fileName}&quot;, method = RequestMethod.GET) public void getShareImage(@PathVariable(&quot;fileName&quot;) String fileName, HttpServletResponse response) { if (StringUtils.isBlank(fileName)) { throw new IllegalArgumentException(&quot;文件名不能为空&quot;); } response.setContentType(&quot;image/png&quot;); File file = new File(wkImageStorage + &quot;/&quot; + fileName + &quot;.png&quot;); try { OutputStream os = response.getOutputStream(); FileInputStream fis = new FileInputStream(file); byte[] buffer = new byte[1024]; int b = 0; while (b != -1) { b = fis.read(buffer); os.write(buffer, 0, b); } } catch (IOException e) { e.printStackTrace(); logger.error(&quot;获取长图失败&quot; + e.getMessage()); } } } EventConsumer 处理分享事件 //消费分享时间 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } } 文件上传云服务器 客户端上传 服务器直传 需要注册七牛云，并且创建两个空间，用于存储用户头像和用户share图片 设置七牛云的配置参数 #qiniu qiniu.key.access=LeG24jUYDhS6YFSxe2d6EEC1rksz3MmZ0yeYu7F3 qiniu.key.secret=H-BUVFxvB1QoqKzv6abOCMT_NEzAPvz3pPodJo3Q qiniu.bucket.header.name=zt-community-header qiniu.bucket.header.url=qbbxkqk6q.bkt.clouddn.com qiniu.bucket.share.name=zt-community-share qiniu.bucket.share.url=qbbx267e5.bkt.clouddn.com 从客户端分享到云服务器 在进入设置页面后，为此次设置（上传图片），生成一个uploadToken，和fileName，传给页面。 @LoginRequired @RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET) public String getSettingPage(Model model) { //生成上传文件名称 String fileName = CommunityUtil.generateUUID(); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //生成上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(headerBucketName, fileName, 3600, policy); model.addAttribute(&quot;uploadToken&quot;, uploadToken); model.addAttribute(&quot;fileName&quot;, fileName); return &quot;/site/setting&quot;; } 页面根据得到的token和filename，异步的使用post命令，将文件上传到云服务器 $(function(){ $(&quot;#uploadForm&quot;).submit(upload); }); function upload() { $.ajax({ url: &quot;http://upload-z2.qiniup.com&quot;, method: &quot;post&quot;, processData: false, contentType: false, data: new FormData($(&quot;#uploadForm&quot;)[0]), success: function(data) { if(data &amp;&amp; data.code == 0) { // 更新头像访问路径 $.post( CONTEXT_PATH + &quot;/user/header/url&quot;, {&quot;fileName&quot;:$(&quot;input[name=&#39;key&#39;]&quot;).val()}, function(data) { data = $.parseJSON(data); if(data.code == 0) { window.location.reload(); } else { alert(data.msg); } } ); } else { alert(&quot;上传失败!&quot;); } } }); return false; } 由上面js代码可以，如果上传成功，则访问更改用户头像的路径来更改header_url。 //User表中的headerUrl需要更新 @RequestMapping(path = &quot;/header/url&quot;, method = RequestMethod.POST) @ResponseBody public String updateHeaderUrl(String fileName) { if (StringUtils.isBlank(fileName)) { return CommunityUtil.getJSONString(1, &quot;文件名不能为空&quot;); } String url = &quot;http://&quot; + headerBucketUrl + &quot;/&quot; + fileName; userService.updataHeader(hostHolder.getUser().getId(), url); return CommunityUtil.getJSONString(0); } 从服务器分享到云服务器 生成七牛云的服务器路径，返回给浏览器 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, shareBucketUrl + &quot;/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } 处理分享（上传）事件 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { //Runtime的线程执行时间可能很长。需要经常检查是否生成了图片。 Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } //eventConsummer有天然的抢占机制，只会有一个服务器执行 UploadTask uploadTask = new UploadTask(fileName, suffix); Future future = taskScheduler.scheduleAtFixedRate(uploadTask, 500); uploadTask.setFuture(future); } class UploadTask implements Runnable { //文件名称 private String fileName; //文件后缀 private String suffix; //开始时间 private long startTime; //上传次数 private int uploadTimes; public void setFuture(Future future) { this.future = future; } //启动任务的返回值 private Future future; public UploadTask(String fileName, String suffix) { this.fileName = fileName; this.suffix = suffix; this.startTime = System.currentTimeMillis(); } @Override public void run() { //图片生成失败 if (System.currentTimeMillis() - startTime &gt; 30000) { logger.error(&quot;执行时间过长 ：&quot; + fileName); future.cancel(true); return; } //无法上传到七牛云 if (uploadTimes &gt;= 3) { logger.error(&quot;无法上传到七牛云&quot; + fileName); future.cancel(true); return; } String path = wkImageStorage + &quot;/&quot; + fileName + suffix; File file = new File(path); if (file.exists()) { logger.info(String.format(&quot;开始第%d次上传[%s]&quot;, ++uploadTimes, fileName)); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(shareBucketName, fileName, 3600, policy); //指定机房 UploadManager manager = new UploadManager(new Configuration(Zone.zone2())); try { Response response = manager.put(path, fileName, uploadToken, null, &quot;/image&quot; + suffix, false); //处理响应结果 JSONObject json = JSONObject.parseObject(response.bodyString()); if (json == null || json.get(&quot;code&quot;) == null || !json.get(&quot;code&quot;).toString().equals(&quot;0&quot;)) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } else { logger.info(String.format(&quot;第%d次上传成功[%s]&quot;, uploadTimes, fileName)); future.cancel(true); return; } } catch (QiniuException e) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } } else { logger.info(&quot;等待图片生成[%s]&quot;, fileName); } } 优化网站性能 加缓存，并使用压力测试工具，展示性能变化情况。 本地缓存 数据存到应用服务器上 常用工具：Ehchche,Guava,Caffeine 分布式缓存 缓存数据存到NoSQL服务器上（有一些数据必须放在分布式服务器上） 比本地缓存差（有网络开销） Redistribution，MenCache 多级缓存 一级缓存：本地，二级缓存：分布式 总之尽力避免缓存雪崩，尽力避免访问database 目标：优化热门帖子列表（对它缓存）（按时间帖子列表经常变，所以要经常更新缓存，性能下降） 本地缓存：Caffeine（可以用Spring整合，但是不建议，因为Spring只用一个缓存管理器来管理所有缓存，所以缓存的大小/过期时间都是一样的，不便于自定义） 使用Caffeine 导入包后，配置Caffeine #Caffeine caffeine.posts.max-size=15 caffeine.posts.expire-seconds=180 通常优化Service @Value(&quot;${caffeine.posts.max-size}&quot;) private int maxSize; @Value(&quot;${caffeine.posts.expire-seconds}&quot;) private int expireSeconds; //Caffeine核心接口：Cache, LoadingCache, AsyncLoadingCache(支持并发） //声明两个缓存：帖子列表 //按照key缓存value private LoadingCache&lt;String, List&lt;DiscussPost&gt;&gt; postListCache; //缓存帖子总数 private LoadingCache&lt;Integer, Integer&gt; postRowsCache; //初始化的时候缓存 @PostConstruct public void init() { //初始化帖子列表 postListCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;String, List&lt;DiscussPost&gt;&gt;() { @Nullable @Override public List&lt;DiscussPost&gt; load(@NonNull String key) throws Exception { //缓存中没有数据时，调用一下代码来查数据 if (key == null || key.length() == 0) { throw new IllegalArgumentException(&quot;参数错误&quot;); } String[] params = key.split(&quot;:&quot;); if (params == null || params.length != 2) { throw new IllegalArgumentException(&quot;参数错误&quot;); } int offset = Integer.valueOf(params[0]); int limit = Integer.valueOf(params[1]); //可以加二级缓存 logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(0, offset, limit, 1); } }); //初始化帖子总数 postRowsCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;Integer, Integer&gt;() { @Nullable @Override public Integer load(@NonNull Integer key) throws Exception { logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(key); } }); } public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { //只缓存首页数据，并且每次只缓存一页，并且只缓存热门帖子 if (userId == 0 &amp;&amp; orderMode == 1) { return postListCache.get(offset + &quot;:&quot; + limit); } logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } public int findDiscussPostsRows(int userId) { if (userId == 0) { return postRowsCache.get(userId); } logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(userId); } 插入30W条数据，用于压力测试 @Test public void initDataForTest() { for (int i = 0; i &lt; 300000; i++) { DiscussPost post = new DiscussPost(); post.setUserId(111); post.setTitle(&quot;互联网求职暖春计划&quot;); post.setContent(&quot;今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&amp;19届，拯救0 offer！&quot;); post.setCreateTime(new Date()); post.setScore(Math.random() * 2000); postService.addDiscussPost(post); } } @Test public void testCache() { System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 0)); } 使用Jmeter进行压力测试 优化前和优化后，吞吐量对比：速度大概增加了10倍 优化前： 优化后：" />
<meta property="og:description" content="Chapter 7 提高系统性能 提高系统安全性 Spring Security 提高身份认证和授权（帖子置顶/加精/删除） 方便扩展，自定义 防止各种攻击 可以和各种web开发集成（Spring MVC） 底层思路 Spring MVC ： DispatcherServlet —&gt; controller 一对多，其中拦截器可以在其中拦截请求，在DispatcherServlet之前，还有一个filter，可以对DispatcherServlet进行拦截，其中DispatcherServlet和filter都是javaEE的规范。 Spring Security利用Filter统一规范认证/授权，大概11个。（判断时机比较靠前） Spring Security是Spring中比较难的，比较建议学习，对框架理解比较好。可以参考这里的教程 演示Demo 打开demo，并导入Security组件，会自动为系统配置。 导入后，需要使用账号密码才能访问首页。账号为user，密码在服务端console可以看到 可以把这个登录页面换成自己的。 需要将User实现UserDetails接口 根绝type来定义用户的权限（但是是字符串”USER”“ADMIN” @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return true; } @Override //凭证未过期 public boolean isCredentialsNonExpired() { return true; } @Override //账号可用 public boolean isEnabled() { return true; } public void setUsername(String username) { this.username = username; } @Override //关键：权限 public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { List&lt;GrantedAuthority&gt; list = new ArrayList&lt;&gt;(); list.add(new GrantedAuthority() { @Override public String getAuthority() { switch (type){ case 1: return &quot;ADMIN&quot;; default: return &quot;USER&quot;; } } }); return list; } 在UserService中实现UserDetailsService 实现此接口可以帮助Security来查询用户 @Override //和findUserByName的功能是一样的，但是实现这个方法，security可以帮助我们检查登录 public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { return this.findUserByName(username); } 配置SecurityConfig（重点） 包括如下配置： 忽略静态资源的权限判断 实现”账号-密码”认证类的配置 配置”认证“相关消息 登录页面 配置连接的权限 在账号-密码filter前面增加一个filter 转发 VS 重定向 添加Remember-me功能 @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private UserService userService; @Override public void configure(WebSecurity web) throws Exception { //忽略静态资源 web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //对认证处理，auth:认证核心结构，用于构造接口实例 //常见实现类：provideManager为其默认实现类 //没有验证码 protected void configure(AuthenticationManagerBuilder auth) throws Exception { //内置的认证规则 //auth.userDetailsService(userService).passwordEncoder(new Pbkdf2PasswordEncoder(&quot;12345&quot;)); //自定义认证规则 //有多种AuthenticationProvider，每一种访问一种认证 //AuthenticationManagerBuilder自己不去做认证，委托给AuthenticationProvider auth.authenticationProvider(new AuthenticationProvider() { @Override //实现账号密码认证 //authentication用于封装认证信息的接口，不同的实现类代表不同类型的认证信息 public Authentication authenticate(Authentication authentication) throws AuthenticationException { String username = authentication.getName(); String password = (String) authentication.getCredentials(); User user = userService.findUserByName(username); if(user == null){ throw new UsernameNotFoundException(&quot;账号不存在&quot;); } password = CommunityUtil.md5(password+user.getSalt()); if(!user.getPassword().equals(password)){ throw new BadCredentialsException(&quot;密码不正确&quot;); } //认证的主要信息 + 证书 + 权限 return new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities()); } //返回当前接口是哪种类型，账号密码？指纹？短信？ @Override public boolean supports(Class&lt;?&gt; aClass) { //UsernamePasswordAuthenticationToken是authentication的常用的实现类，表示账号密码认证模式 return UsernamePasswordAuthenticationToken.class.equals(aClass); } }); } @Override //认证 protected void configure(HttpSecurity http) throws Exception { //配置登录相关的配置，告诉那个请求是登录 http.formLogin() .loginPage(&quot;/loginpage&quot;) .loginProcessingUrl(&quot;/login&quot;) .successHandler(new AuthenticationSuccessHandler() { @Override public void onAuthenticationSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }) .failureHandler(new AuthenticationFailureHandler() { @Override public void onAuthenticationFailure(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e) throws IOException, ServletException { //不能重定向,要用转发 //重定向：适合两个独立组件，当组件A完成没有什么东西返回时，（302）重定向到B，此时A不能给B带数据 //转发：两个独立组件，A只能完成请求的一半，然后由B处理，但是此时浏览器不知道B的存在（A和B有耦合） //此处：A:login --&gt; B:loginpage，也可以用模板，但是此处不行，不再controller内 httpServletRequest.setAttribute(&quot;error&quot;, e.getMessage()); httpServletRequest.getRequestDispatcher(&quot;/loginpage&quot;).forward(httpServletRequest, httpServletResponse); } }); http.logout() .logoutUrl(&quot;/logout&quot;) .logoutSuccessHandler(new LogoutSuccessHandler() { @Override public void onLogoutSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }); //配置授权 http.authorizeRequests() .antMatchers(&quot;/letter&quot;).hasAnyAuthority(&quot;USER&quot;, &quot;ADMIN&quot;) .antMatchers(&quot;/admin&quot;).hasAnyAuthority(&quot;ADMIN&quot;) .and().exceptionHandling().accessDeniedPage(&quot;/denied&quot;); //增加filter http.addFilterBefore(new Filter(){ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; if(request.getServletPath().equals(&quot;/login&quot;)){ String verifyCode = request.getParameter(&quot;verifyCode&quot;); if(verifyCode == null || !verifyCode.equalsIgnoreCase(&quot;1234&quot;)){ request.setAttribute(&quot;error&quot;,&quot;验证码错误&quot;); request.getRequestDispatcher(&quot;/loginpage&quot;).forward(request, response); return; } } //放行请求，请求继续执行 filterChain.doFilter(request,response); } },UsernamePasswordAuthenticationFilter.class); http.rememberMe() .tokenRepository(new InMemoryTokenRepositoryImpl()) .tokenValiditySeconds(3600 * 24) .userDetailsService(userService); } } 修改页面模板 在Security中，logout功能必须是post请求 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;首页&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;社区首页&lt;/h1&gt; &lt;!--欢迎信息--&gt; &lt;p th:if=&quot;${loginUser!=null}&quot;&gt; 欢迎你，&lt;span th:text=&quot;${loginUser.username}&quot;&gt;&lt;/span&gt; &lt;/p&gt; &lt;ul&gt; &lt;li&gt;&lt;a th:href=&quot;@{/discuss}&quot;&gt;帖子详情&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/letter}&quot;&gt;私信列表&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;登录&lt;/a&gt;&lt;/li&gt; &lt;!--&lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;退出&lt;/a&gt;&lt;/li&gt;--&gt; &lt;!-- *Security实现的logout必须是post --&gt; &lt;li&gt; &lt;form method=&quot;post&quot; th:action=&quot;@{/logout}&quot;&gt; &lt;a href=&quot;javascript:document.forms[0].submit();&quot;&gt;退出&lt;/a&gt; &lt;/form&gt; &lt;/li&gt; &lt;/ul&gt; &lt;/body&gt; &lt;/html&gt; 权限控制 废弃拦截器，使用SpringSecurity来进行登录检查 授权配置，分配权限：普通用户，版主，管理员 使用原有认证方案：登录退出使用原来的代码 CSRF配置：防止CSRF攻击 废弃拦截器 在WebMvcConfig中，讲login拦截器注释掉 设置权限 对一些路径进行权限设置/ @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant { @Override //忽略静态资源 public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //授权 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .anyRequest().permitAll() .and().csrf().disable(); //没有权限的异常处理 http.exceptionHandling() .accessDeniedHandler(new AccessDeniedHandler() { @Override //权限不足处理 public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (xRequestedWith.equals(&quot;XMLHttpRequest&quot;)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您无权限访问此功能&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/denied&quot;); } } }) .authenticationEntryPoint(new AuthenticationEntryPoint() { @Override //没有登录处理 public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您还没有登录，请登录&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/login&quot;); } } }); //默认Logout退出，会用filter拦截 //将security中的默认登出路径设置如下，避免覆盖我们自己的登出代码 http.logout().logoutUrl(&quot;/securityLogout&quot;); //Security获得权限需要在SecurityContext里获得 } } 在LoginTicket拦截器中，对登录的用户配置权限（因为在没有用security处理登录时，SecurityContext没有用户的权限信息，需要我们手动添加） @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //从cookie中获取ticket String ticket = CookieUtil.getValue(request, &quot;ticket&quot;); if (ticket != null) { LoginTicket loginTicket = userService.findLoginTicket(ticket); if (loginTicket != null &amp;&amp; loginTicket.getStatus() == 0 &amp;&amp; loginTicket.getExpired().after(new Date())) { User user = userService.findUserById(loginTicket.getUserId()); //在本此请求中持有用户，考虑多线程并发，多线程隔离 hostHolder.setUser(user); //构建用户认证结果，并存入SecurityContext,以便于Security进行权限管理 Authentication authentication = new UsernamePasswordAuthenticationToken( user, user.getPassword(), userService.getAuthorities(user.getId()) ); SecurityContextHolder.setContext(new SecurityContextImpl(authentication)); } } return true; } CSRF原理 某一网站盗取Cookie中的凭证（ticket），从而模拟用户提交表单。 解决办法：引入Security后，用户请求提交表单时，Security会在表单中加一个隐藏的Token，其他网站能够窃取到你的Ticket，但是无法获得你的表单数据（其中的Token），从而会被服务器发现。 问题：异步请求的时候需要自己处理，演示如下： &lt;!--&lt;meta name=&quot;_csrf&quot; th:content=&quot;${_csrf.token}&quot;&gt;--&gt; &lt;!--&lt;meta name=&quot;_csrf_header&quot; th:content=&quot;${_csrf.headerName}&quot;&gt;--&gt; $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //发送AJAX请求前，需要带上CSRF令牌 // var token = $(&quot;mata[name=&#39;_csrf&#39;]&quot;).attr(&quot;content&quot;); // var header = $(&quot;mata[name=&#39;_csrf_header&#39;]&quot;).attr(&quot;content&quot;); // $(document).ajaxSend(function(e, xhr, options){ // xhr.setRequestHeader(header, token); // }); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 置顶，加精，删除 功能实现：置顶—&gt;修改帖子类型，加精，删除 —&gt; 修改帖子状态 权限管理：用security设置即可 按钮显示：thymeleaf可以支持Security，但是需要添加包 实现置顶，加精，删除 数据层 int updateType(@Param(&quot;id&quot;) int id, @Param(&quot;type&quot;) int type); int updateStatus(@Param(&quot;id&quot;) int id, @Param(&quot;status&quot;) int status); 服务层 public int updateType(int id, int type) { return discussPostMapper.updateType(id, type); } public int updateStatus(int id, int status) { return discussPostMapper.updateStatus(id, status); } 控制层 //置顶 @RequestMapping(path = &quot;/top&quot;, method = RequestMethod.POST) @ResponseBody public String setTop(int id) { discussPostService.updateType(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //加精 @RequestMapping(path = &quot;/wonderful&quot;, method = RequestMethod.POST) @ResponseBody public String setWonderful(int id) { discussPostService.updateStatus(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //删除 @RequestMapping(path = &quot;/delete&quot;, method = RequestMethod.POST) @ResponseBody public String setDelete(int id) { discussPostService.updateStatus(id, 2); //帖子同步ES //触发发帖事件 //触发删帖事件 Event event = new Event() .setTopic(TOPIC_DELETE) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } 设置权限 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/top&quot;, &quot;/discuss/wonderful&quot; ) .hasAnyAuthority( AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/delete&quot; ) .hasAnyAuthority( AUTHORITY_ADMIN ) .anyRequest().permitAll() .and().csrf().disable(); Redis高级数据类型 HyperLogLog：超级日志 基数算法，独立总数统计，多次请求去重 数据占用空间少，只占12K的内存空间 不精确的统计算法，标准误差为0.81% Bitmap：位图 特殊格式字符串，按位存储数据 其实是byte数组 大量连续数据的布尔值，如每天的签到。如一年的签到数据：365/8，只有40多个字节 都适合用来给网站运营的数据进行统计，并且节约内存 使用redis中的hyperloglog和bitmap，代码如下： //统计20W个数据的独立整合 @Test public void testHyperLogLog() { String redisKey = &quot;test:hll:01&quot;; for (int i = 1; i &lt;= 100000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey, i); } for (int i = 1; i &lt;= 100000; i++) int r = (int) (Math.random() * 10000 + 1); redisTemplate.opsForHyperLogLog().add(redisKey, r); } long size = redisTemplate.opsForHyperLogLog().size(redisKey); System.out.println(size); } //将三组数据合并，在合并后的重复数据中，统计独立正数 @Test public void testHyperLogLogUnion() { String redisKey2 = &quot;test:hll:02&quot;; for (int i = 1; i &lt;= 10000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey2, i); } String redisKey3 = &quot;test:hll:03&quot;; for (int i = 5001; i &lt;= 15000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey3, i); } String redisKey4 = &quot;test:hll:04&quot;; for (int i = 10001; i &lt;= 20000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey4, i); } String unionKey = &quot;test:hll:union&quot;; redisTemplate.opsForHyperLogLog().union(unionKey, redisKey2, redisKey3, redisKey4); long size = redisTemplate.opsForHyperLogLog().size(unionKey); System.out.println(size); } //统计一组数据的布尔值 @Test public void testBitMap() { String redisKey = &quot;test:bm:01&quot;; //记录 redisTemplate.opsForValue().setBit(redisKey, 1, true); redisTemplate.opsForValue().setBit(redisKey, 4, true); redisTemplate.opsForValue().setBit(redisKey, 7, true); //查询 System.out.println(redisTemplate.opsForValue().getBit(redisKey, 0)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 1)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 2)); //统计 Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } //统计三组数据布尔值，并进行or运算 @Test public void testBitMapOperation() { String redisKey2 = &quot;test:bm:02&quot;; redisTemplate.opsForValue().setBit(redisKey2, 0, true); redisTemplate.opsForValue().setBit(redisKey2, 1, true); redisTemplate.opsForValue().setBit(redisKey2, 2, false); String redisKey3 = &quot;test:bm:03&quot;; redisTemplate.opsForValue().setBit(redisKey3, 2, true); redisTemplate.opsForValue().setBit(redisKey3, 3, true); redisTemplate.opsForValue().setBit(redisKey3, 4, false); String redisKey4 = &quot;test:bm:04&quot;; redisTemplate.opsForValue().setBit(redisKey4, 4, true); redisTemplate.opsForValue().setBit(redisKey4, 5, true); redisTemplate.opsForValue().setBit(redisKey4, 6, false); String redisKey = &quot;test:bm:or&quot;; Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), redisKey2.getBytes(), redisKey3.getBytes(), redisKey4.getBytes()); return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } } 网站数据统计 UV：独立访客，通过IP地址统计，希望把匿名用户（游客）也统计起来。每次访问都要统计，因为不确定此次访问的IP是否已经记录过。用HyperLogLog进行统计。 DAU：日活跃用户，访问过一次则认为其是活跃或用。与UV的区别是：通过userId进行排重（已注册用户），而且是比较精确的结果，故使用bitmap。可以用UserId为Index,在redis中存储，（key为日期），所以每天需要大概几十万位。 定义RedisKey 分别定义UA和DAU的rediskey //单日UV public static String getUVKey(String date) { return PREFIX_UV + SPLIT + date; } //区间UV public static String getUVKey(String startDate, String endDate) { return PREFIX_UV + SPLIT + startDate + SPLIT + endDate; } //单日DAU public static String getDAUKey(String date) { return PREFIX_DAU + SPLIT + date; } //区间DAU public static String getDAUKey(String startDate, String endDate) { return PREFIX_DAU + SPLIT + startDate + SPLIT + endDate; } DataService @Service public class DataService { @Autowired private RedisTemplate redisTemplate; private SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyyMMdd&quot;); //记录UV数据，记录指定IP public void recordIV(String ip) { String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(new Date())); redisTemplate.opsForHyperLogLog().add(redisKey, ip); } //统计指定范围内的UV public long calculateUV(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;String&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getUVKey(dateFormat.format(calendar.getTime())); keyList.add(key); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(start), dateFormat.format(end)); redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray()); return redisTemplate.opsForHyperLogLog().size(redisKey); } //记录指定用户到DAU public void recordDAU(int userId) { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(new Date())); redisTemplate.opsForValue().setBit(redisKey, userId, true); } //统计指定范围内的DAU public long calculateDAU(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;byte[]&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getDAUKey(dateFormat.format(calendar.getTime())); keyList.add(key.getBytes()); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); return (long) redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), keyList.toArray(new byte[0][0])); return connection.bitCount(redisKey.getBytes()); } }); } } 拦截器 每次请求需要判断Ip和用户 @Component public class Datainteceptor implements HandlerInterceptor { @Autowired private DataService dataService; @Autowired private HostHolder hostHolder; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //记录UV String ip = request.getRemoteHost(); dataService.recordIV(ip); //记录DAU User user = hostHolder.getUser(); if (user != null) { dataService.recordDAU(user.getId()); } return true; } } Controller 实现访问数据页/查询UV/查询dau的功能 @Controller public class DataController { @Autowired private DataService dataService; @RequestMapping(path = &quot;/data&quot;, method = {RequestMethod.GET, RequestMethod.POST}) public String getDataPage() { return &quot;/site/admin/data&quot;; } @RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST) public String getUV(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateUV(start, end); model.addAttribute(&quot;uvResult&quot;, uv); model.addAttribute(&quot;uvStartDate&quot;, start); model.addAttribute(&quot;uvEndDate&quot;, end); return &quot;forward:/data&quot;; } @RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST) public String getDAU(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateDAU(start, end); model.addAttribute(&quot;dauResult&quot;, uv); model.addAttribute(&quot;dauStartDate&quot;, start); model.addAttribute(&quot;dauEndDate&quot;, end); return &quot;forward:/data&quot;; } } 配置权限 在SecurityConfig下添加路径即可 任务执行和调度 JDK线程池 ExecutorService ScheduledExecutorService Spring线程池 ThreadPoolTaskExecutor ThreadPoolTaskScheduler 分布式定时任务 Spring Quartz 在分布式部署中，使用JDK或者Spring的线程池调度，会有问题。在分布式服务器中，请求会通过Nginx来分配，从而可以实现负载均衡，但是Scheduler不能被Nigix管理，所以同一的Scheduler请求，可能会在多服务器执行多次。 使用Quartz，不同服务器的Scheduler运行时，会在数据库服务器访问运行数据，通过排队（加锁），可以使得程序只运行一次。 JDK线程池演示 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ThreadPoolTest { private static final Logger logger = LoggerFactory.getLogger(ThreadPoolTest.class); //演示JDK普通线程池 //包含5个线程 private ExecutorService executorService = Executors.newFixedThreadPool(5); //定时执行任务的线程池 private ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(5); //使用test方法，让当前线程sleep，以避免线程自动结束 private void sleep(long m) { try { Thread.sleep(m); } catch (InterruptedException e) { e.printStackTrace(); } } //演示JDK普通线程池 @Test public void testExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, executorService&quot;); } }; for (int i = 0; i &lt; 10; i++) { executorService.submit(task); } sleep(10000); } //JDK定时任务线程池 @Test public void testScheduledExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, scheduledExecutorService&quot;); } }; scheduledExecutorService.scheduleAtFixedRate(task, 10000, 1000, TimeUnit.MILLISECONDS); sleep(30000); } } Spring线程池 配置： #TaskExecutionProperties spring.task.execution.pool.core-size=5 spring.task.execution.pool.max-size=15 spring.task.execution.pool.queue-capacity=100 #TaskSchedulingProperties spring.task.scheduling.pool.size=5 演示： //演示Spring普通线程池 @Test public void testThreadPoolTaskExecutor() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskExecutor&quot;); } }; for (int i = 0; i &lt; 10; i++) taskExecutor.submit(task); sleep(10000); } //演示Spring定时线程 @Test public void testThreadPoolTaskScheduler() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskScheduler&quot;); } }; Date startTime = new Date(System.currentTimeMillis() + 10000); taskScheduler.scheduleAtFixedRate(task, startTime, 1000); sleep(30000); } Spring使用多线程的简单方法 通过注解即可 @Async public void execute1() { System.out.println(&quot;当前执行线程为&quot; + Thread.currentThread().getName()); } @Scheduled(initialDelay = 10000, fixedDelay = 1000) public void scheduled1() { System.out.println(&quot;当前执行定时任务，执行线程为 ---&gt;&quot; + Thread.currentThread().getName()); } //Spring多线程简便方法 @Test public void testThreadPoolTaskExecutorSimple() { for (int i = 0; i &lt; 10; i++) alphaService.execute1(); sleep(10000); } //Spring定时任务简化 @Test public void testThreadPoolTaskSchedulerSimple() { sleep(30000); } Quartz演示 需要提前创建Database，其中存放运行定时任务，所需要的信息 默认读取内存中数据，所以需要配置 # QuartzProperties spring.quartz.job-store-type=jdbc spring.quartz.scheduler-name=communityScheduler spring.quartz.properties.org.quartz.scheduler.instanceId=AUTO spring.quartz.properties.org.quartz.jobStore.class=org.quartz.impl.jdbcjobstore.JobStoreTX spring.quartz.properties.org.quartz.jobStore.driverDelegateClass=org.quartz.impl.jdbcjobstore.StdJDBCDelegate spring.quartz.properties.org.quartz.jobStore.isClustered=true spring.quartz.properties.org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool spring.quartz.properties.org.quartz.threadPool.threadCount=5 定义QuarzJob public class AlphaJob implements Job { @Override public void execute(JobExecutionContext context) throws JobExecutionException { System.out.println(Thread.currentThread().getName() + &quot;: execute quartz job&quot;); } } 配置Quartz @Configuration public class QuartzConfig { //FactoryBean，可以简化Bean的实例化过程 //1.通过factoryBean封装Bean的实例化过程 //2.将FactorBean装配到容器里 //3.FactoryBean注入给其他的Bean， //4.其他的Bean得到了FactoryBean所管理的实例对象 @Bean public JobDetailFactoryBean alphaJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(AlphaJob.class); factoryBean.setName(&quot;alphaJob&quot;); factoryBean.setGroup(&quot;alphaGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } @Bean public SimpleTriggerFactoryBean simpleTrigger(JobDetail alphaJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(alphaJobDetail); factoryBean.setName(&quot;alphaTrigger&quot;); factoryBean.setGroup(&quot;alphaTriggerGroup&quot;); factoryBean.setRepeatInterval(3000); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } } 此时上述Job就能在项目启动后，自动运行，如果需要删除，可执行如下代码 public class QuartzTest { @Autowired private Scheduler scheduler; @Test public void testDeleteJob() { try { boolean result = scheduler.deleteJob(new JobKey(&quot;alphaJob&quot;, &quot;alphaGroup&quot;)); System.out.println(result); } catch (SchedulerException e) { e.printStackTrace(); } } } 热帖排名 时间增加，分数减小，评论/收藏/点赞越多，分数越高。 分数计算方式：定时算一次，从而能保证帖子的分数一段时间是不变的。 只算分数变化的帖子 —&gt; 把分数变化的帖子放在Redis中。 统计帖子分数 RedisKey public static String getPostScore() { return PREFIX_POSt + SPLIT + &quot;socre&quot;; } 能修改帖子分数的地方，存入Redis 包括点赞/评论/发帖/加精 定义定时任务 每隔5分钟运行一次 @Bean public JobDetailFactoryBean postScoreRefreshJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(PostScoreReferenceJob.class); factoryBean.setName(&quot;postScoreReferenceJob&quot;); factoryBean.setGroup(&quot;communityJobGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } //刷新帖子分数 @Bean public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(postScoreRefreshJobDetail); factoryBean.setName(&quot;postScoreRefreshTrigger&quot;); factoryBean.setGroup(&quot;communityTriggerGroup&quot;); factoryBean.setRepeatInterval(1000 * 60 * 5); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } 计算分数（job) public class PostScoreReferenceJob implements Job, CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(PostScoreReferenceJob.class); //牛客纪元 private static final Date epoch; static { try { epoch = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(&quot;2014-08-01 00:00:00&quot;); } catch (ParseException e) { throw new RuntimeException(&quot;初始化牛客网纪元失败&quot; + e); } } @Autowired private RedisTemplate redisTemplate; @Autowired private DiscussPostService discussPostService; @Autowired private LikeService likeService; @Autowired private ElasticsearchService elasticsearchService; @Override public void execute(JobExecutionContext context) throws JobExecutionException { String redisKey = RedisKeyUtil.getPostScore(); BoundSetOperations operations = redisTemplate.boundSetOps(redisKey); if (operations.size() == 0) { logger.info(&quot;任务取消，没有需要重新计分的帖子&quot;); } logger.info(&quot;任务开始，正在计算帖子分数： &quot; + operations.size()); while (operations.size() &gt; 0) { this.refresh((Integer) operations.pop()); } logger.info(&quot;帖子分数计算结束！&quot;); } private void refresh(int postId) { DiscussPost post = discussPostService.findDiscussPostById(postId); if (post == null) { logger.error(&quot;帖子不存在，postId :&quot; + postId); return; } //计算是否加精，评论数，点赞数 boolean wonderful = post.getStatus() == 1; int commentCount = post.getCommentCount(); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId); //计算权重 double w = (wonderful ? 75 : 0) + commentCount * 10 + likeCount * 2; double score = Math.log10(Math.max(w, 1)) + (post.getCreateTime().getTime() - epoch.getTime()) / (1000 * 3600 * 24); //更新帖子的分数 discussPostService.updateScore(postId, score); //同步service post.setScore(score); elasticsearchService.saveDiscussPost(post); } } 修改排序方式 数据访问层 @Mapper public interface DiscussPostMapper { List&lt;DiscussPost&gt; selectDiscussPosts(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit, @Param(&quot;orderMode&quot;) int orderMode); 服务层 public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } 控制层 orderMode通过路径传过来 @RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET) public String getIndexPage(Model model, Page page, @RequestParam(name = &quot;orderMode&quot;, defaultValue = &quot;0&quot;) int orderMode) { page.setRows(discussPostService.findDiscussPostsRows(0)); page.setPath(&quot;/index?orderMode=&quot; + orderMode); //在方法调用前，SpringMVC会自动实例化Page和Model，并且将Page注入Model //所以可以在thymeleaf中直接访问Page对象中的数据。 List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit(), orderMode); List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); for (DiscussPost post : list) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); User user = userService.findUserById(post.getUserId()); map.put(&quot;user&quot;, user); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()); map.put(&quot;likeCount&quot;, likeCount); discussPosts.add(map); } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;orderMode&quot;, orderMode); return &quot;/index&quot;; } Idea查看方法调用的快捷键：alt + F7 生成长图 将模板文件转换为PDF（在服务端） 使用wkhtmltopdf 1，wkhtmltopdf url file 2，wkhtmltoimage url file 通过java Runtime.getRuntime().exec(); 官网 配置环境变量 通过命令访问工具 wkhtmltoimage --quality 75 https://www.nowcoder.com d:/Java/nowcoder_project/wk_image/1.png 模拟分享功能 将命令行设置为可配置，将图片位置设置为可配，检查路径是否存在（wk不能生成路径） 创建配置文件： #wk wk.image.command=d:/Java/nowcoder_project/wkhtmltopdf/bin/wkhtmltoimage wk.image.storage=d:/Java/nowcoder_project/wk_image ShareController 使用Kafka，并且异步驱动，可以节省时间 @Controller public class ShareController implements CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(ShareController.class); @Autowired private EventProducer eventProducer; @Value(&quot;${community.path.domain}&quot;) private String domain; @Value(&quot;${server.servlet.context-path}&quot;) private String contextPath; @Value(&quot;${wk.image.storage}&quot;) private String wkImageStorage; //生成图片：异步驱动 //处理为事件，因为生成的时间可能比较长，用户不需要在页面等待。 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, domain + contextPath + &quot;/share/image/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } //获取长图 @RequestMapping(path = &quot;/share/image/{fileName}&quot;, method = RequestMethod.GET) public void getShareImage(@PathVariable(&quot;fileName&quot;) String fileName, HttpServletResponse response) { if (StringUtils.isBlank(fileName)) { throw new IllegalArgumentException(&quot;文件名不能为空&quot;); } response.setContentType(&quot;image/png&quot;); File file = new File(wkImageStorage + &quot;/&quot; + fileName + &quot;.png&quot;); try { OutputStream os = response.getOutputStream(); FileInputStream fis = new FileInputStream(file); byte[] buffer = new byte[1024]; int b = 0; while (b != -1) { b = fis.read(buffer); os.write(buffer, 0, b); } } catch (IOException e) { e.printStackTrace(); logger.error(&quot;获取长图失败&quot; + e.getMessage()); } } } EventConsumer 处理分享事件 //消费分享时间 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } } 文件上传云服务器 客户端上传 服务器直传 需要注册七牛云，并且创建两个空间，用于存储用户头像和用户share图片 设置七牛云的配置参数 #qiniu qiniu.key.access=LeG24jUYDhS6YFSxe2d6EEC1rksz3MmZ0yeYu7F3 qiniu.key.secret=H-BUVFxvB1QoqKzv6abOCMT_NEzAPvz3pPodJo3Q qiniu.bucket.header.name=zt-community-header qiniu.bucket.header.url=qbbxkqk6q.bkt.clouddn.com qiniu.bucket.share.name=zt-community-share qiniu.bucket.share.url=qbbx267e5.bkt.clouddn.com 从客户端分享到云服务器 在进入设置页面后，为此次设置（上传图片），生成一个uploadToken，和fileName，传给页面。 @LoginRequired @RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET) public String getSettingPage(Model model) { //生成上传文件名称 String fileName = CommunityUtil.generateUUID(); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //生成上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(headerBucketName, fileName, 3600, policy); model.addAttribute(&quot;uploadToken&quot;, uploadToken); model.addAttribute(&quot;fileName&quot;, fileName); return &quot;/site/setting&quot;; } 页面根据得到的token和filename，异步的使用post命令，将文件上传到云服务器 $(function(){ $(&quot;#uploadForm&quot;).submit(upload); }); function upload() { $.ajax({ url: &quot;http://upload-z2.qiniup.com&quot;, method: &quot;post&quot;, processData: false, contentType: false, data: new FormData($(&quot;#uploadForm&quot;)[0]), success: function(data) { if(data &amp;&amp; data.code == 0) { // 更新头像访问路径 $.post( CONTEXT_PATH + &quot;/user/header/url&quot;, {&quot;fileName&quot;:$(&quot;input[name=&#39;key&#39;]&quot;).val()}, function(data) { data = $.parseJSON(data); if(data.code == 0) { window.location.reload(); } else { alert(data.msg); } } ); } else { alert(&quot;上传失败!&quot;); } } }); return false; } 由上面js代码可以，如果上传成功，则访问更改用户头像的路径来更改header_url。 //User表中的headerUrl需要更新 @RequestMapping(path = &quot;/header/url&quot;, method = RequestMethod.POST) @ResponseBody public String updateHeaderUrl(String fileName) { if (StringUtils.isBlank(fileName)) { return CommunityUtil.getJSONString(1, &quot;文件名不能为空&quot;); } String url = &quot;http://&quot; + headerBucketUrl + &quot;/&quot; + fileName; userService.updataHeader(hostHolder.getUser().getId(), url); return CommunityUtil.getJSONString(0); } 从服务器分享到云服务器 生成七牛云的服务器路径，返回给浏览器 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, shareBucketUrl + &quot;/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } 处理分享（上传）事件 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { //Runtime的线程执行时间可能很长。需要经常检查是否生成了图片。 Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } //eventConsummer有天然的抢占机制，只会有一个服务器执行 UploadTask uploadTask = new UploadTask(fileName, suffix); Future future = taskScheduler.scheduleAtFixedRate(uploadTask, 500); uploadTask.setFuture(future); } class UploadTask implements Runnable { //文件名称 private String fileName; //文件后缀 private String suffix; //开始时间 private long startTime; //上传次数 private int uploadTimes; public void setFuture(Future future) { this.future = future; } //启动任务的返回值 private Future future; public UploadTask(String fileName, String suffix) { this.fileName = fileName; this.suffix = suffix; this.startTime = System.currentTimeMillis(); } @Override public void run() { //图片生成失败 if (System.currentTimeMillis() - startTime &gt; 30000) { logger.error(&quot;执行时间过长 ：&quot; + fileName); future.cancel(true); return; } //无法上传到七牛云 if (uploadTimes &gt;= 3) { logger.error(&quot;无法上传到七牛云&quot; + fileName); future.cancel(true); return; } String path = wkImageStorage + &quot;/&quot; + fileName + suffix; File file = new File(path); if (file.exists()) { logger.info(String.format(&quot;开始第%d次上传[%s]&quot;, ++uploadTimes, fileName)); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(shareBucketName, fileName, 3600, policy); //指定机房 UploadManager manager = new UploadManager(new Configuration(Zone.zone2())); try { Response response = manager.put(path, fileName, uploadToken, null, &quot;/image&quot; + suffix, false); //处理响应结果 JSONObject json = JSONObject.parseObject(response.bodyString()); if (json == null || json.get(&quot;code&quot;) == null || !json.get(&quot;code&quot;).toString().equals(&quot;0&quot;)) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } else { logger.info(String.format(&quot;第%d次上传成功[%s]&quot;, uploadTimes, fileName)); future.cancel(true); return; } } catch (QiniuException e) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } } else { logger.info(&quot;等待图片生成[%s]&quot;, fileName); } } 优化网站性能 加缓存，并使用压力测试工具，展示性能变化情况。 本地缓存 数据存到应用服务器上 常用工具：Ehchche,Guava,Caffeine 分布式缓存 缓存数据存到NoSQL服务器上（有一些数据必须放在分布式服务器上） 比本地缓存差（有网络开销） Redistribution，MenCache 多级缓存 一级缓存：本地，二级缓存：分布式 总之尽力避免缓存雪崩，尽力避免访问database 目标：优化热门帖子列表（对它缓存）（按时间帖子列表经常变，所以要经常更新缓存，性能下降） 本地缓存：Caffeine（可以用Spring整合，但是不建议，因为Spring只用一个缓存管理器来管理所有缓存，所以缓存的大小/过期时间都是一样的，不便于自定义） 使用Caffeine 导入包后，配置Caffeine #Caffeine caffeine.posts.max-size=15 caffeine.posts.expire-seconds=180 通常优化Service @Value(&quot;${caffeine.posts.max-size}&quot;) private int maxSize; @Value(&quot;${caffeine.posts.expire-seconds}&quot;) private int expireSeconds; //Caffeine核心接口：Cache, LoadingCache, AsyncLoadingCache(支持并发） //声明两个缓存：帖子列表 //按照key缓存value private LoadingCache&lt;String, List&lt;DiscussPost&gt;&gt; postListCache; //缓存帖子总数 private LoadingCache&lt;Integer, Integer&gt; postRowsCache; //初始化的时候缓存 @PostConstruct public void init() { //初始化帖子列表 postListCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;String, List&lt;DiscussPost&gt;&gt;() { @Nullable @Override public List&lt;DiscussPost&gt; load(@NonNull String key) throws Exception { //缓存中没有数据时，调用一下代码来查数据 if (key == null || key.length() == 0) { throw new IllegalArgumentException(&quot;参数错误&quot;); } String[] params = key.split(&quot;:&quot;); if (params == null || params.length != 2) { throw new IllegalArgumentException(&quot;参数错误&quot;); } int offset = Integer.valueOf(params[0]); int limit = Integer.valueOf(params[1]); //可以加二级缓存 logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(0, offset, limit, 1); } }); //初始化帖子总数 postRowsCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;Integer, Integer&gt;() { @Nullable @Override public Integer load(@NonNull Integer key) throws Exception { logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(key); } }); } public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { //只缓存首页数据，并且每次只缓存一页，并且只缓存热门帖子 if (userId == 0 &amp;&amp; orderMode == 1) { return postListCache.get(offset + &quot;:&quot; + limit); } logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } public int findDiscussPostsRows(int userId) { if (userId == 0) { return postRowsCache.get(userId); } logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(userId); } 插入30W条数据，用于压力测试 @Test public void initDataForTest() { for (int i = 0; i &lt; 300000; i++) { DiscussPost post = new DiscussPost(); post.setUserId(111); post.setTitle(&quot;互联网求职暖春计划&quot;); post.setContent(&quot;今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&amp;19届，拯救0 offer！&quot;); post.setCreateTime(new Date()); post.setScore(Math.random() * 2000); postService.addDiscussPost(post); } } @Test public void testCache() { System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 0)); } 使用Jmeter进行压力测试 优化前和优化后，吞吐量对比：速度大概增加了10倍 优化前： 优化后：" />
<link rel="canonical" href="https://github.com/tietietietie/tietietietie.github.io/chapter7.html" />
<meta property="og:url" content="https://github.com/tietietietie/tietietietie.github.io/chapter7.html" />
<meta property="og:site_name" content="tie’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-23T07:48:00+08:00" />
<script type="application/ld+json">
{"url":"https://github.com/tietietietie/tietietietie.github.io/chapter7.html","headline":"社区论坛：性能提升和安全模块","dateModified":"2020-07-23T07:48:00+08:00","datePublished":"2020-07-23T07:48:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/tietietietie/tietietietie.github.io/chapter7.html"},"author":{"@type":"Person","name":"tie"},"description":"Chapter 7 提高系统性能 提高系统安全性 Spring Security 提高身份认证和授权（帖子置顶/加精/删除） 方便扩展，自定义 防止各种攻击 可以和各种web开发集成（Spring MVC） 底层思路 Spring MVC ： DispatcherServlet —&gt; controller 一对多，其中拦截器可以在其中拦截请求，在DispatcherServlet之前，还有一个filter，可以对DispatcherServlet进行拦截，其中DispatcherServlet和filter都是javaEE的规范。 Spring Security利用Filter统一规范认证/授权，大概11个。（判断时机比较靠前） Spring Security是Spring中比较难的，比较建议学习，对框架理解比较好。可以参考这里的教程 演示Demo 打开demo，并导入Security组件，会自动为系统配置。 导入后，需要使用账号密码才能访问首页。账号为user，密码在服务端console可以看到 可以把这个登录页面换成自己的。 需要将User实现UserDetails接口 根绝type来定义用户的权限（但是是字符串”USER”“ADMIN” @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return true; } @Override //凭证未过期 public boolean isCredentialsNonExpired() { return true; } @Override //账号可用 public boolean isEnabled() { return true; } public void setUsername(String username) { this.username = username; } @Override //关键：权限 public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() { List&lt;GrantedAuthority&gt; list = new ArrayList&lt;&gt;(); list.add(new GrantedAuthority() { @Override public String getAuthority() { switch (type){ case 1: return &quot;ADMIN&quot;; default: return &quot;USER&quot;; } } }); return list; } 在UserService中实现UserDetailsService 实现此接口可以帮助Security来查询用户 @Override //和findUserByName的功能是一样的，但是实现这个方法，security可以帮助我们检查登录 public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { return this.findUserByName(username); } 配置SecurityConfig（重点） 包括如下配置： 忽略静态资源的权限判断 实现”账号-密码”认证类的配置 配置”认证“相关消息 登录页面 配置连接的权限 在账号-密码filter前面增加一个filter 转发 VS 重定向 添加Remember-me功能 @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private UserService userService; @Override public void configure(WebSecurity web) throws Exception { //忽略静态资源 web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //对认证处理，auth:认证核心结构，用于构造接口实例 //常见实现类：provideManager为其默认实现类 //没有验证码 protected void configure(AuthenticationManagerBuilder auth) throws Exception { //内置的认证规则 //auth.userDetailsService(userService).passwordEncoder(new Pbkdf2PasswordEncoder(&quot;12345&quot;)); //自定义认证规则 //有多种AuthenticationProvider，每一种访问一种认证 //AuthenticationManagerBuilder自己不去做认证，委托给AuthenticationProvider auth.authenticationProvider(new AuthenticationProvider() { @Override //实现账号密码认证 //authentication用于封装认证信息的接口，不同的实现类代表不同类型的认证信息 public Authentication authenticate(Authentication authentication) throws AuthenticationException { String username = authentication.getName(); String password = (String) authentication.getCredentials(); User user = userService.findUserByName(username); if(user == null){ throw new UsernameNotFoundException(&quot;账号不存在&quot;); } password = CommunityUtil.md5(password+user.getSalt()); if(!user.getPassword().equals(password)){ throw new BadCredentialsException(&quot;密码不正确&quot;); } //认证的主要信息 + 证书 + 权限 return new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities()); } //返回当前接口是哪种类型，账号密码？指纹？短信？ @Override public boolean supports(Class&lt;?&gt; aClass) { //UsernamePasswordAuthenticationToken是authentication的常用的实现类，表示账号密码认证模式 return UsernamePasswordAuthenticationToken.class.equals(aClass); } }); } @Override //认证 protected void configure(HttpSecurity http) throws Exception { //配置登录相关的配置，告诉那个请求是登录 http.formLogin() .loginPage(&quot;/loginpage&quot;) .loginProcessingUrl(&quot;/login&quot;) .successHandler(new AuthenticationSuccessHandler() { @Override public void onAuthenticationSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }) .failureHandler(new AuthenticationFailureHandler() { @Override public void onAuthenticationFailure(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e) throws IOException, ServletException { //不能重定向,要用转发 //重定向：适合两个独立组件，当组件A完成没有什么东西返回时，（302）重定向到B，此时A不能给B带数据 //转发：两个独立组件，A只能完成请求的一半，然后由B处理，但是此时浏览器不知道B的存在（A和B有耦合） //此处：A:login --&gt; B:loginpage，也可以用模板，但是此处不行，不再controller内 httpServletRequest.setAttribute(&quot;error&quot;, e.getMessage()); httpServletRequest.getRequestDispatcher(&quot;/loginpage&quot;).forward(httpServletRequest, httpServletResponse); } }); http.logout() .logoutUrl(&quot;/logout&quot;) .logoutSuccessHandler(new LogoutSuccessHandler() { @Override public void onLogoutSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException { httpServletResponse.sendRedirect(httpServletRequest.getContextPath() + &quot;/index&quot;); } }); //配置授权 http.authorizeRequests() .antMatchers(&quot;/letter&quot;).hasAnyAuthority(&quot;USER&quot;, &quot;ADMIN&quot;) .antMatchers(&quot;/admin&quot;).hasAnyAuthority(&quot;ADMIN&quot;) .and().exceptionHandling().accessDeniedPage(&quot;/denied&quot;); //增加filter http.addFilterBefore(new Filter(){ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; if(request.getServletPath().equals(&quot;/login&quot;)){ String verifyCode = request.getParameter(&quot;verifyCode&quot;); if(verifyCode == null || !verifyCode.equalsIgnoreCase(&quot;1234&quot;)){ request.setAttribute(&quot;error&quot;,&quot;验证码错误&quot;); request.getRequestDispatcher(&quot;/loginpage&quot;).forward(request, response); return; } } //放行请求，请求继续执行 filterChain.doFilter(request,response); } },UsernamePasswordAuthenticationFilter.class); http.rememberMe() .tokenRepository(new InMemoryTokenRepositoryImpl()) .tokenValiditySeconds(3600 * 24) .userDetailsService(userService); } } 修改页面模板 在Security中，logout功能必须是post请求 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;首页&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;社区首页&lt;/h1&gt; &lt;!--欢迎信息--&gt; &lt;p th:if=&quot;${loginUser!=null}&quot;&gt; 欢迎你，&lt;span th:text=&quot;${loginUser.username}&quot;&gt;&lt;/span&gt; &lt;/p&gt; &lt;ul&gt; &lt;li&gt;&lt;a th:href=&quot;@{/discuss}&quot;&gt;帖子详情&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/letter}&quot;&gt;私信列表&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;登录&lt;/a&gt;&lt;/li&gt; &lt;!--&lt;li&gt;&lt;a th:href=&quot;@{/loginpage}&quot;&gt;退出&lt;/a&gt;&lt;/li&gt;--&gt; &lt;!-- *Security实现的logout必须是post --&gt; &lt;li&gt; &lt;form method=&quot;post&quot; th:action=&quot;@{/logout}&quot;&gt; &lt;a href=&quot;javascript:document.forms[0].submit();&quot;&gt;退出&lt;/a&gt; &lt;/form&gt; &lt;/li&gt; &lt;/ul&gt; &lt;/body&gt; &lt;/html&gt; 权限控制 废弃拦截器，使用SpringSecurity来进行登录检查 授权配置，分配权限：普通用户，版主，管理员 使用原有认证方案：登录退出使用原来的代码 CSRF配置：防止CSRF攻击 废弃拦截器 在WebMvcConfig中，讲login拦截器注释掉 设置权限 对一些路径进行权限设置/ @Configuration public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant { @Override //忽略静态资源 public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(&quot;/resources/**&quot;); } @Override //授权 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .anyRequest().permitAll() .and().csrf().disable(); //没有权限的异常处理 http.exceptionHandling() .accessDeniedHandler(new AccessDeniedHandler() { @Override //权限不足处理 public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (xRequestedWith.equals(&quot;XMLHttpRequest&quot;)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您无权限访问此功能&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/denied&quot;); } } }) .authenticationEntryPoint(new AuthenticationEntryPoint() { @Override //没有登录处理 public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException { String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;); if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith)) { response.setContentType(&quot;application/plain; charset=utf-8&quot;); PrintWriter writer = response.getWriter(); writer.write(CommunityUtil.getJSONString(403, &quot;您还没有登录，请登录&quot;)); } else { response.sendRedirect(request.getContextPath() + &quot;/login&quot;); } } }); //默认Logout退出，会用filter拦截 //将security中的默认登出路径设置如下，避免覆盖我们自己的登出代码 http.logout().logoutUrl(&quot;/securityLogout&quot;); //Security获得权限需要在SecurityContext里获得 } } 在LoginTicket拦截器中，对登录的用户配置权限（因为在没有用security处理登录时，SecurityContext没有用户的权限信息，需要我们手动添加） @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //从cookie中获取ticket String ticket = CookieUtil.getValue(request, &quot;ticket&quot;); if (ticket != null) { LoginTicket loginTicket = userService.findLoginTicket(ticket); if (loginTicket != null &amp;&amp; loginTicket.getStatus() == 0 &amp;&amp; loginTicket.getExpired().after(new Date())) { User user = userService.findUserById(loginTicket.getUserId()); //在本此请求中持有用户，考虑多线程并发，多线程隔离 hostHolder.setUser(user); //构建用户认证结果，并存入SecurityContext,以便于Security进行权限管理 Authentication authentication = new UsernamePasswordAuthenticationToken( user, user.getPassword(), userService.getAuthorities(user.getId()) ); SecurityContextHolder.setContext(new SecurityContextImpl(authentication)); } } return true; } CSRF原理 某一网站盗取Cookie中的凭证（ticket），从而模拟用户提交表单。 解决办法：引入Security后，用户请求提交表单时，Security会在表单中加一个隐藏的Token，其他网站能够窃取到你的Ticket，但是无法获得你的表单数据（其中的Token），从而会被服务器发现。 问题：异步请求的时候需要自己处理，演示如下： &lt;!--&lt;meta name=&quot;_csrf&quot; th:content=&quot;${_csrf.token}&quot;&gt;--&gt; &lt;!--&lt;meta name=&quot;_csrf_header&quot; th:content=&quot;${_csrf.headerName}&quot;&gt;--&gt; $(function(){ $(&quot;#publishBtn&quot;).click(publish); }); function publish() { $(&quot;#publishModal&quot;).modal(&quot;hide&quot;); //发送AJAX请求前，需要带上CSRF令牌 // var token = $(&quot;mata[name=&#39;_csrf&#39;]&quot;).attr(&quot;content&quot;); // var header = $(&quot;mata[name=&#39;_csrf_header&#39;]&quot;).attr(&quot;content&quot;); // $(document).ajaxSend(function(e, xhr, options){ // xhr.setRequestHeader(header, token); // }); //先返回结果再显示 //获取标题/内容 var title = $(&quot;#recipient-name&quot;).val(); var content = $(&quot;#message-text&quot;).val(); //发送异步请求 $.post( &quot;/community/discuss/add&quot;, {&quot;title&quot;:title,&quot;content&quot;:content}, function(data){ data = $.parseJSON(data); //提示框显示返回消息 $(&quot;#hintBody&quot;).text(data.msg); //显示提示框/两秒后自动隐藏 $(&quot;#hintModal&quot;).modal(&quot;show&quot;); setTimeout(function(){ $(&quot;#hintModal&quot;).modal(&quot;hide&quot;); if(data.code == 0) { window.location.reload(); } }, 2000); } ); } 置顶，加精，删除 功能实现：置顶—&gt;修改帖子类型，加精，删除 —&gt; 修改帖子状态 权限管理：用security设置即可 按钮显示：thymeleaf可以支持Security，但是需要添加包 实现置顶，加精，删除 数据层 int updateType(@Param(&quot;id&quot;) int id, @Param(&quot;type&quot;) int type); int updateStatus(@Param(&quot;id&quot;) int id, @Param(&quot;status&quot;) int status); 服务层 public int updateType(int id, int type) { return discussPostMapper.updateType(id, type); } public int updateStatus(int id, int status) { return discussPostMapper.updateStatus(id, status); } 控制层 //置顶 @RequestMapping(path = &quot;/top&quot;, method = RequestMethod.POST) @ResponseBody public String setTop(int id) { discussPostService.updateType(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //加精 @RequestMapping(path = &quot;/wonderful&quot;, method = RequestMethod.POST) @ResponseBody public String setWonderful(int id) { discussPostService.updateStatus(id, 1); //帖子同步ES //触发发帖事件 //触发发帖事件 Event event = new Event() .setTopic(TOPIC_PUBLISH) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } //删除 @RequestMapping(path = &quot;/delete&quot;, method = RequestMethod.POST) @ResponseBody public String setDelete(int id) { discussPostService.updateStatus(id, 2); //帖子同步ES //触发发帖事件 //触发删帖事件 Event event = new Event() .setTopic(TOPIC_DELETE) .setUserId(hostHolder.getUser().getId()) .setEntityType(ENTITY_TYPE_POST) .setEntityId(id); producer.fireEvent(event); return CommunityUtil.getJSONString(0); } 设置权限 protected void configure(HttpSecurity http) throws Exception { http.authorizeRequests() .antMatchers( &quot;/user/setting&quot;, &quot;/user/upload&quot;, &quot;/comment/add/**&quot;, &quot;/discuss/add&quot;, &quot;/letter/**&quot;, &quot;/notice/**&quot;, &quot;/like&quot;, &quot;follow&quot;, &quot;unfollow&quot; ) .hasAnyAuthority( AUTHORITY_USER, AUTHORITY_ADMIN, AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/top&quot;, &quot;/discuss/wonderful&quot; ) .hasAnyAuthority( AUTHORITY_MODERATOR ) .antMatchers( &quot;/discuss/delete&quot; ) .hasAnyAuthority( AUTHORITY_ADMIN ) .anyRequest().permitAll() .and().csrf().disable(); Redis高级数据类型 HyperLogLog：超级日志 基数算法，独立总数统计，多次请求去重 数据占用空间少，只占12K的内存空间 不精确的统计算法，标准误差为0.81% Bitmap：位图 特殊格式字符串，按位存储数据 其实是byte数组 大量连续数据的布尔值，如每天的签到。如一年的签到数据：365/8，只有40多个字节 都适合用来给网站运营的数据进行统计，并且节约内存 使用redis中的hyperloglog和bitmap，代码如下： //统计20W个数据的独立整合 @Test public void testHyperLogLog() { String redisKey = &quot;test:hll:01&quot;; for (int i = 1; i &lt;= 100000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey, i); } for (int i = 1; i &lt;= 100000; i++) int r = (int) (Math.random() * 10000 + 1); redisTemplate.opsForHyperLogLog().add(redisKey, r); } long size = redisTemplate.opsForHyperLogLog().size(redisKey); System.out.println(size); } //将三组数据合并，在合并后的重复数据中，统计独立正数 @Test public void testHyperLogLogUnion() { String redisKey2 = &quot;test:hll:02&quot;; for (int i = 1; i &lt;= 10000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey2, i); } String redisKey3 = &quot;test:hll:03&quot;; for (int i = 5001; i &lt;= 15000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey3, i); } String redisKey4 = &quot;test:hll:04&quot;; for (int i = 10001; i &lt;= 20000; i++) { redisTemplate.opsForHyperLogLog().add(redisKey4, i); } String unionKey = &quot;test:hll:union&quot;; redisTemplate.opsForHyperLogLog().union(unionKey, redisKey2, redisKey3, redisKey4); long size = redisTemplate.opsForHyperLogLog().size(unionKey); System.out.println(size); } //统计一组数据的布尔值 @Test public void testBitMap() { String redisKey = &quot;test:bm:01&quot;; //记录 redisTemplate.opsForValue().setBit(redisKey, 1, true); redisTemplate.opsForValue().setBit(redisKey, 4, true); redisTemplate.opsForValue().setBit(redisKey, 7, true); //查询 System.out.println(redisTemplate.opsForValue().getBit(redisKey, 0)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 1)); System.out.println(redisTemplate.opsForValue().getBit(redisKey, 2)); //统计 Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } //统计三组数据布尔值，并进行or运算 @Test public void testBitMapOperation() { String redisKey2 = &quot;test:bm:02&quot;; redisTemplate.opsForValue().setBit(redisKey2, 0, true); redisTemplate.opsForValue().setBit(redisKey2, 1, true); redisTemplate.opsForValue().setBit(redisKey2, 2, false); String redisKey3 = &quot;test:bm:03&quot;; redisTemplate.opsForValue().setBit(redisKey3, 2, true); redisTemplate.opsForValue().setBit(redisKey3, 3, true); redisTemplate.opsForValue().setBit(redisKey3, 4, false); String redisKey4 = &quot;test:bm:04&quot;; redisTemplate.opsForValue().setBit(redisKey4, 4, true); redisTemplate.opsForValue().setBit(redisKey4, 5, true); redisTemplate.opsForValue().setBit(redisKey4, 6, false); String redisKey = &quot;test:bm:or&quot;; Object obj = redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), redisKey2.getBytes(), redisKey3.getBytes(), redisKey4.getBytes()); return connection.bitCount(redisKey.getBytes()); } }); System.out.println(obj); } } 网站数据统计 UV：独立访客，通过IP地址统计，希望把匿名用户（游客）也统计起来。每次访问都要统计，因为不确定此次访问的IP是否已经记录过。用HyperLogLog进行统计。 DAU：日活跃用户，访问过一次则认为其是活跃或用。与UV的区别是：通过userId进行排重（已注册用户），而且是比较精确的结果，故使用bitmap。可以用UserId为Index,在redis中存储，（key为日期），所以每天需要大概几十万位。 定义RedisKey 分别定义UA和DAU的rediskey //单日UV public static String getUVKey(String date) { return PREFIX_UV + SPLIT + date; } //区间UV public static String getUVKey(String startDate, String endDate) { return PREFIX_UV + SPLIT + startDate + SPLIT + endDate; } //单日DAU public static String getDAUKey(String date) { return PREFIX_DAU + SPLIT + date; } //区间DAU public static String getDAUKey(String startDate, String endDate) { return PREFIX_DAU + SPLIT + startDate + SPLIT + endDate; } DataService @Service public class DataService { @Autowired private RedisTemplate redisTemplate; private SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyyMMdd&quot;); //记录UV数据，记录指定IP public void recordIV(String ip) { String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(new Date())); redisTemplate.opsForHyperLogLog().add(redisKey, ip); } //统计指定范围内的UV public long calculateUV(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;String&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getUVKey(dateFormat.format(calendar.getTime())); keyList.add(key); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getUVKey(dateFormat.format(start), dateFormat.format(end)); redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray()); return redisTemplate.opsForHyperLogLog().size(redisKey); } //记录指定用户到DAU public void recordDAU(int userId) { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(new Date())); redisTemplate.opsForValue().setBit(redisKey, userId, true); } //统计指定范围内的DAU public long calculateDAU(Date start, Date end) { if (end == null || start == null) { throw new IllegalArgumentException(&quot;参数不能为空&quot;); } //整理key List&lt;byte[]&gt; keyList = new ArrayList&lt;&gt;(); Calendar calendar = Calendar.getInstance(); calendar.setTime(start); while (!calendar.getTime().after(end)) { String key = RedisKeyUtil.getDAUKey(dateFormat.format(calendar.getTime())); keyList.add(key.getBytes()); calendar.add(Calendar.DATE, 1); } String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); return (long) redisTemplate.execute(new RedisCallback() { @Override public Object doInRedis(RedisConnection connection) throws DataAccessException { String redisKey = RedisKeyUtil.getDAUKey(dateFormat.format(start), dateFormat.format(end)); connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), keyList.toArray(new byte[0][0])); return connection.bitCount(redisKey.getBytes()); } }); } } 拦截器 每次请求需要判断Ip和用户 @Component public class Datainteceptor implements HandlerInterceptor { @Autowired private DataService dataService; @Autowired private HostHolder hostHolder; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { //记录UV String ip = request.getRemoteHost(); dataService.recordIV(ip); //记录DAU User user = hostHolder.getUser(); if (user != null) { dataService.recordDAU(user.getId()); } return true; } } Controller 实现访问数据页/查询UV/查询dau的功能 @Controller public class DataController { @Autowired private DataService dataService; @RequestMapping(path = &quot;/data&quot;, method = {RequestMethod.GET, RequestMethod.POST}) public String getDataPage() { return &quot;/site/admin/data&quot;; } @RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST) public String getUV(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateUV(start, end); model.addAttribute(&quot;uvResult&quot;, uv); model.addAttribute(&quot;uvStartDate&quot;, start); model.addAttribute(&quot;uvEndDate&quot;, end); return &quot;forward:/data&quot;; } @RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST) public String getDAU(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start, @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model) { long uv = dataService.calculateDAU(start, end); model.addAttribute(&quot;dauResult&quot;, uv); model.addAttribute(&quot;dauStartDate&quot;, start); model.addAttribute(&quot;dauEndDate&quot;, end); return &quot;forward:/data&quot;; } } 配置权限 在SecurityConfig下添加路径即可 任务执行和调度 JDK线程池 ExecutorService ScheduledExecutorService Spring线程池 ThreadPoolTaskExecutor ThreadPoolTaskScheduler 分布式定时任务 Spring Quartz 在分布式部署中，使用JDK或者Spring的线程池调度，会有问题。在分布式服务器中，请求会通过Nginx来分配，从而可以实现负载均衡，但是Scheduler不能被Nigix管理，所以同一的Scheduler请求，可能会在多服务器执行多次。 使用Quartz，不同服务器的Scheduler运行时，会在数据库服务器访问运行数据，通过排队（加锁），可以使得程序只运行一次。 JDK线程池演示 @SpringBootTest @ContextConfiguration(classes = CommunityApplication.class) public class ThreadPoolTest { private static final Logger logger = LoggerFactory.getLogger(ThreadPoolTest.class); //演示JDK普通线程池 //包含5个线程 private ExecutorService executorService = Executors.newFixedThreadPool(5); //定时执行任务的线程池 private ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(5); //使用test方法，让当前线程sleep，以避免线程自动结束 private void sleep(long m) { try { Thread.sleep(m); } catch (InterruptedException e) { e.printStackTrace(); } } //演示JDK普通线程池 @Test public void testExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, executorService&quot;); } }; for (int i = 0; i &lt; 10; i++) { executorService.submit(task); } sleep(10000); } //JDK定时任务线程池 @Test public void testScheduledExecutorService() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, scheduledExecutorService&quot;); } }; scheduledExecutorService.scheduleAtFixedRate(task, 10000, 1000, TimeUnit.MILLISECONDS); sleep(30000); } } Spring线程池 配置： #TaskExecutionProperties spring.task.execution.pool.core-size=5 spring.task.execution.pool.max-size=15 spring.task.execution.pool.queue-capacity=100 #TaskSchedulingProperties spring.task.scheduling.pool.size=5 演示： //演示Spring普通线程池 @Test public void testThreadPoolTaskExecutor() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskExecutor&quot;); } }; for (int i = 0; i &lt; 10; i++) taskExecutor.submit(task); sleep(10000); } //演示Spring定时线程 @Test public void testThreadPoolTaskScheduler() { Runnable task = new Runnable() { @Override public void run() { logger.debug(&quot;hello, ThreadPoolTaskScheduler&quot;); } }; Date startTime = new Date(System.currentTimeMillis() + 10000); taskScheduler.scheduleAtFixedRate(task, startTime, 1000); sleep(30000); } Spring使用多线程的简单方法 通过注解即可 @Async public void execute1() { System.out.println(&quot;当前执行线程为&quot; + Thread.currentThread().getName()); } @Scheduled(initialDelay = 10000, fixedDelay = 1000) public void scheduled1() { System.out.println(&quot;当前执行定时任务，执行线程为 ---&gt;&quot; + Thread.currentThread().getName()); } //Spring多线程简便方法 @Test public void testThreadPoolTaskExecutorSimple() { for (int i = 0; i &lt; 10; i++) alphaService.execute1(); sleep(10000); } //Spring定时任务简化 @Test public void testThreadPoolTaskSchedulerSimple() { sleep(30000); } Quartz演示 需要提前创建Database，其中存放运行定时任务，所需要的信息 默认读取内存中数据，所以需要配置 # QuartzProperties spring.quartz.job-store-type=jdbc spring.quartz.scheduler-name=communityScheduler spring.quartz.properties.org.quartz.scheduler.instanceId=AUTO spring.quartz.properties.org.quartz.jobStore.class=org.quartz.impl.jdbcjobstore.JobStoreTX spring.quartz.properties.org.quartz.jobStore.driverDelegateClass=org.quartz.impl.jdbcjobstore.StdJDBCDelegate spring.quartz.properties.org.quartz.jobStore.isClustered=true spring.quartz.properties.org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool spring.quartz.properties.org.quartz.threadPool.threadCount=5 定义QuarzJob public class AlphaJob implements Job { @Override public void execute(JobExecutionContext context) throws JobExecutionException { System.out.println(Thread.currentThread().getName() + &quot;: execute quartz job&quot;); } } 配置Quartz @Configuration public class QuartzConfig { //FactoryBean，可以简化Bean的实例化过程 //1.通过factoryBean封装Bean的实例化过程 //2.将FactorBean装配到容器里 //3.FactoryBean注入给其他的Bean， //4.其他的Bean得到了FactoryBean所管理的实例对象 @Bean public JobDetailFactoryBean alphaJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(AlphaJob.class); factoryBean.setName(&quot;alphaJob&quot;); factoryBean.setGroup(&quot;alphaGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } @Bean public SimpleTriggerFactoryBean simpleTrigger(JobDetail alphaJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(alphaJobDetail); factoryBean.setName(&quot;alphaTrigger&quot;); factoryBean.setGroup(&quot;alphaTriggerGroup&quot;); factoryBean.setRepeatInterval(3000); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } } 此时上述Job就能在项目启动后，自动运行，如果需要删除，可执行如下代码 public class QuartzTest { @Autowired private Scheduler scheduler; @Test public void testDeleteJob() { try { boolean result = scheduler.deleteJob(new JobKey(&quot;alphaJob&quot;, &quot;alphaGroup&quot;)); System.out.println(result); } catch (SchedulerException e) { e.printStackTrace(); } } } 热帖排名 时间增加，分数减小，评论/收藏/点赞越多，分数越高。 分数计算方式：定时算一次，从而能保证帖子的分数一段时间是不变的。 只算分数变化的帖子 —&gt; 把分数变化的帖子放在Redis中。 统计帖子分数 RedisKey public static String getPostScore() { return PREFIX_POSt + SPLIT + &quot;socre&quot;; } 能修改帖子分数的地方，存入Redis 包括点赞/评论/发帖/加精 定义定时任务 每隔5分钟运行一次 @Bean public JobDetailFactoryBean postScoreRefreshJobDetail() { JobDetailFactoryBean factoryBean = new JobDetailFactoryBean(); factoryBean.setJobClass(PostScoreReferenceJob.class); factoryBean.setName(&quot;postScoreReferenceJob&quot;); factoryBean.setGroup(&quot;communityJobGroup&quot;); //长久保存 factoryBean.setDurability(true); factoryBean.setRequestsRecovery(true); return factoryBean; } //刷新帖子分数 @Bean public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail) { SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean(); factoryBean.setJobDetail(postScoreRefreshJobDetail); factoryBean.setName(&quot;postScoreRefreshTrigger&quot;); factoryBean.setGroup(&quot;communityTriggerGroup&quot;); factoryBean.setRepeatInterval(1000 * 60 * 5); factoryBean.setJobDataMap(new JobDataMap()); return factoryBean; } 计算分数（job) public class PostScoreReferenceJob implements Job, CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(PostScoreReferenceJob.class); //牛客纪元 private static final Date epoch; static { try { epoch = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(&quot;2014-08-01 00:00:00&quot;); } catch (ParseException e) { throw new RuntimeException(&quot;初始化牛客网纪元失败&quot; + e); } } @Autowired private RedisTemplate redisTemplate; @Autowired private DiscussPostService discussPostService; @Autowired private LikeService likeService; @Autowired private ElasticsearchService elasticsearchService; @Override public void execute(JobExecutionContext context) throws JobExecutionException { String redisKey = RedisKeyUtil.getPostScore(); BoundSetOperations operations = redisTemplate.boundSetOps(redisKey); if (operations.size() == 0) { logger.info(&quot;任务取消，没有需要重新计分的帖子&quot;); } logger.info(&quot;任务开始，正在计算帖子分数： &quot; + operations.size()); while (operations.size() &gt; 0) { this.refresh((Integer) operations.pop()); } logger.info(&quot;帖子分数计算结束！&quot;); } private void refresh(int postId) { DiscussPost post = discussPostService.findDiscussPostById(postId); if (post == null) { logger.error(&quot;帖子不存在，postId :&quot; + postId); return; } //计算是否加精，评论数，点赞数 boolean wonderful = post.getStatus() == 1; int commentCount = post.getCommentCount(); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId); //计算权重 double w = (wonderful ? 75 : 0) + commentCount * 10 + likeCount * 2; double score = Math.log10(Math.max(w, 1)) + (post.getCreateTime().getTime() - epoch.getTime()) / (1000 * 3600 * 24); //更新帖子的分数 discussPostService.updateScore(postId, score); //同步service post.setScore(score); elasticsearchService.saveDiscussPost(post); } } 修改排序方式 数据访问层 @Mapper public interface DiscussPostMapper { List&lt;DiscussPost&gt; selectDiscussPosts(@Param(&quot;userId&quot;) int userId, @Param(&quot;offset&quot;) int offset, @Param(&quot;limit&quot;) int limit, @Param(&quot;orderMode&quot;) int orderMode); 服务层 public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } 控制层 orderMode通过路径传过来 @RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET) public String getIndexPage(Model model, Page page, @RequestParam(name = &quot;orderMode&quot;, defaultValue = &quot;0&quot;) int orderMode) { page.setRows(discussPostService.findDiscussPostsRows(0)); page.setPath(&quot;/index?orderMode=&quot; + orderMode); //在方法调用前，SpringMVC会自动实例化Page和Model，并且将Page注入Model //所以可以在thymeleaf中直接访问Page对象中的数据。 List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit(), orderMode); List&lt;Map&lt;String, Object&gt;&gt; discussPosts = new ArrayList&lt;&gt;(); for (DiscussPost post : list) { Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;post&quot;, post); User user = userService.findUserById(post.getUserId()); map.put(&quot;user&quot;, user); long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()); map.put(&quot;likeCount&quot;, likeCount); discussPosts.add(map); } model.addAttribute(&quot;discussPosts&quot;, discussPosts); model.addAttribute(&quot;orderMode&quot;, orderMode); return &quot;/index&quot;; } Idea查看方法调用的快捷键：alt + F7 生成长图 将模板文件转换为PDF（在服务端） 使用wkhtmltopdf 1，wkhtmltopdf url file 2，wkhtmltoimage url file 通过java Runtime.getRuntime().exec(); 官网 配置环境变量 通过命令访问工具 wkhtmltoimage --quality 75 https://www.nowcoder.com d:/Java/nowcoder_project/wk_image/1.png 模拟分享功能 将命令行设置为可配置，将图片位置设置为可配，检查路径是否存在（wk不能生成路径） 创建配置文件： #wk wk.image.command=d:/Java/nowcoder_project/wkhtmltopdf/bin/wkhtmltoimage wk.image.storage=d:/Java/nowcoder_project/wk_image ShareController 使用Kafka，并且异步驱动，可以节省时间 @Controller public class ShareController implements CommunityConstant { private static final Logger logger = LoggerFactory.getLogger(ShareController.class); @Autowired private EventProducer eventProducer; @Value(&quot;${community.path.domain}&quot;) private String domain; @Value(&quot;${server.servlet.context-path}&quot;) private String contextPath; @Value(&quot;${wk.image.storage}&quot;) private String wkImageStorage; //生成图片：异步驱动 //处理为事件，因为生成的时间可能比较长，用户不需要在页面等待。 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, domain + contextPath + &quot;/share/image/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } //获取长图 @RequestMapping(path = &quot;/share/image/{fileName}&quot;, method = RequestMethod.GET) public void getShareImage(@PathVariable(&quot;fileName&quot;) String fileName, HttpServletResponse response) { if (StringUtils.isBlank(fileName)) { throw new IllegalArgumentException(&quot;文件名不能为空&quot;); } response.setContentType(&quot;image/png&quot;); File file = new File(wkImageStorage + &quot;/&quot; + fileName + &quot;.png&quot;); try { OutputStream os = response.getOutputStream(); FileInputStream fis = new FileInputStream(file); byte[] buffer = new byte[1024]; int b = 0; while (b != -1) { b = fis.read(buffer); os.write(buffer, 0, b); } } catch (IOException e) { e.printStackTrace(); logger.error(&quot;获取长图失败&quot; + e.getMessage()); } } } EventConsumer 处理分享事件 //消费分享时间 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } } 文件上传云服务器 客户端上传 服务器直传 需要注册七牛云，并且创建两个空间，用于存储用户头像和用户share图片 设置七牛云的配置参数 #qiniu qiniu.key.access=LeG24jUYDhS6YFSxe2d6EEC1rksz3MmZ0yeYu7F3 qiniu.key.secret=H-BUVFxvB1QoqKzv6abOCMT_NEzAPvz3pPodJo3Q qiniu.bucket.header.name=zt-community-header qiniu.bucket.header.url=qbbxkqk6q.bkt.clouddn.com qiniu.bucket.share.name=zt-community-share qiniu.bucket.share.url=qbbx267e5.bkt.clouddn.com 从客户端分享到云服务器 在进入设置页面后，为此次设置（上传图片），生成一个uploadToken，和fileName，传给页面。 @LoginRequired @RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET) public String getSettingPage(Model model) { //生成上传文件名称 String fileName = CommunityUtil.generateUUID(); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //生成上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(headerBucketName, fileName, 3600, policy); model.addAttribute(&quot;uploadToken&quot;, uploadToken); model.addAttribute(&quot;fileName&quot;, fileName); return &quot;/site/setting&quot;; } 页面根据得到的token和filename，异步的使用post命令，将文件上传到云服务器 $(function(){ $(&quot;#uploadForm&quot;).submit(upload); }); function upload() { $.ajax({ url: &quot;http://upload-z2.qiniup.com&quot;, method: &quot;post&quot;, processData: false, contentType: false, data: new FormData($(&quot;#uploadForm&quot;)[0]), success: function(data) { if(data &amp;&amp; data.code == 0) { // 更新头像访问路径 $.post( CONTEXT_PATH + &quot;/user/header/url&quot;, {&quot;fileName&quot;:$(&quot;input[name=&#39;key&#39;]&quot;).val()}, function(data) { data = $.parseJSON(data); if(data.code == 0) { window.location.reload(); } else { alert(data.msg); } } ); } else { alert(&quot;上传失败!&quot;); } } }); return false; } 由上面js代码可以，如果上传成功，则访问更改用户头像的路径来更改header_url。 //User表中的headerUrl需要更新 @RequestMapping(path = &quot;/header/url&quot;, method = RequestMethod.POST) @ResponseBody public String updateHeaderUrl(String fileName) { if (StringUtils.isBlank(fileName)) { return CommunityUtil.getJSONString(1, &quot;文件名不能为空&quot;); } String url = &quot;http://&quot; + headerBucketUrl + &quot;/&quot; + fileName; userService.updataHeader(hostHolder.getUser().getId(), url); return CommunityUtil.getJSONString(0); } 从服务器分享到云服务器 生成七牛云的服务器路径，返回给浏览器 @RequestMapping(path = &quot;/share&quot;, method = RequestMethod.GET) @ResponseBody public String share(String htmlUrl) { //文件名随机 String fileName = CommunityUtil.generateUUID(); Event event = new Event() .setTopic(TOPIC_SHARE) .setData(&quot;htmlUrl&quot;, htmlUrl) .setData(&quot;fileName&quot;, fileName) .setData(&quot;suffix&quot;, &quot;.png&quot;); eventProducer.fireEvent(event); //返回访问路径 Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;shareUrl&quot;, shareBucketUrl + &quot;/&quot; + fileName); return CommunityUtil.getJSONString(0, null, map); } 处理分享（上传）事件 @KafkaListener(topics = {TOPIC_SHARE}) public void handleShareMessage(ConsumerRecord record) { if (record == null || record.value() == null) { logger.error(&quot;消息内容为空&quot;); return; } Event event = JSONObject.parseObject(record.value().toString(), Event.class); if (event == null) { logger.error(&quot;消息格式错误&quot;); return; } String htmlUrl = (String) event.getData().get(&quot;htmlUrl&quot;); String fileName = (String) event.getData().get(&quot;fileName&quot;); String suffix = (String) event.getData().get(&quot;suffix&quot;); String cmd = wkImageCommand + &quot; --quality 75 &quot; + htmlUrl + &quot; &quot; + wkImageStorage + &quot;/&quot; + fileName + suffix; try { //Runtime的线程执行时间可能很长。需要经常检查是否生成了图片。 Runtime.getRuntime().exec(cmd); logger.info(&quot;生成图片成功&quot; + cmd); } catch (IOException e) { e.printStackTrace(); logger.info(&quot;生成图片失败&quot; + e.getMessage() + &quot; &quot; + cmd); } //eventConsummer有天然的抢占机制，只会有一个服务器执行 UploadTask uploadTask = new UploadTask(fileName, suffix); Future future = taskScheduler.scheduleAtFixedRate(uploadTask, 500); uploadTask.setFuture(future); } class UploadTask implements Runnable { //文件名称 private String fileName; //文件后缀 private String suffix; //开始时间 private long startTime; //上传次数 private int uploadTimes; public void setFuture(Future future) { this.future = future; } //启动任务的返回值 private Future future; public UploadTask(String fileName, String suffix) { this.fileName = fileName; this.suffix = suffix; this.startTime = System.currentTimeMillis(); } @Override public void run() { //图片生成失败 if (System.currentTimeMillis() - startTime &gt; 30000) { logger.error(&quot;执行时间过长 ：&quot; + fileName); future.cancel(true); return; } //无法上传到七牛云 if (uploadTimes &gt;= 3) { logger.error(&quot;无法上传到七牛云&quot; + fileName); future.cancel(true); return; } String path = wkImageStorage + &quot;/&quot; + fileName + suffix; File file = new File(path); if (file.exists()) { logger.info(String.format(&quot;开始第%d次上传[%s]&quot;, ++uploadTimes, fileName)); //设置响应信息 StringMap policy = new StringMap(); policy.put(&quot;returnBody&quot;, CommunityUtil.getJSONString(0)); //上传凭证 Auth auth = Auth.create(accessKey, secretKey); String uploadToken = auth.uploadToken(shareBucketName, fileName, 3600, policy); //指定机房 UploadManager manager = new UploadManager(new Configuration(Zone.zone2())); try { Response response = manager.put(path, fileName, uploadToken, null, &quot;/image&quot; + suffix, false); //处理响应结果 JSONObject json = JSONObject.parseObject(response.bodyString()); if (json == null || json.get(&quot;code&quot;) == null || !json.get(&quot;code&quot;).toString().equals(&quot;0&quot;)) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } else { logger.info(String.format(&quot;第%d次上传成功[%s]&quot;, uploadTimes, fileName)); future.cancel(true); return; } } catch (QiniuException e) { logger.info(String.format(&quot;第%d次上传失败[%s]&quot;, uploadTimes, fileName)); } } else { logger.info(&quot;等待图片生成[%s]&quot;, fileName); } } 优化网站性能 加缓存，并使用压力测试工具，展示性能变化情况。 本地缓存 数据存到应用服务器上 常用工具：Ehchche,Guava,Caffeine 分布式缓存 缓存数据存到NoSQL服务器上（有一些数据必须放在分布式服务器上） 比本地缓存差（有网络开销） Redistribution，MenCache 多级缓存 一级缓存：本地，二级缓存：分布式 总之尽力避免缓存雪崩，尽力避免访问database 目标：优化热门帖子列表（对它缓存）（按时间帖子列表经常变，所以要经常更新缓存，性能下降） 本地缓存：Caffeine（可以用Spring整合，但是不建议，因为Spring只用一个缓存管理器来管理所有缓存，所以缓存的大小/过期时间都是一样的，不便于自定义） 使用Caffeine 导入包后，配置Caffeine #Caffeine caffeine.posts.max-size=15 caffeine.posts.expire-seconds=180 通常优化Service @Value(&quot;${caffeine.posts.max-size}&quot;) private int maxSize; @Value(&quot;${caffeine.posts.expire-seconds}&quot;) private int expireSeconds; //Caffeine核心接口：Cache, LoadingCache, AsyncLoadingCache(支持并发） //声明两个缓存：帖子列表 //按照key缓存value private LoadingCache&lt;String, List&lt;DiscussPost&gt;&gt; postListCache; //缓存帖子总数 private LoadingCache&lt;Integer, Integer&gt; postRowsCache; //初始化的时候缓存 @PostConstruct public void init() { //初始化帖子列表 postListCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;String, List&lt;DiscussPost&gt;&gt;() { @Nullable @Override public List&lt;DiscussPost&gt; load(@NonNull String key) throws Exception { //缓存中没有数据时，调用一下代码来查数据 if (key == null || key.length() == 0) { throw new IllegalArgumentException(&quot;参数错误&quot;); } String[] params = key.split(&quot;:&quot;); if (params == null || params.length != 2) { throw new IllegalArgumentException(&quot;参数错误&quot;); } int offset = Integer.valueOf(params[0]); int limit = Integer.valueOf(params[1]); //可以加二级缓存 logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(0, offset, limit, 1); } }); //初始化帖子总数 postRowsCache = Caffeine.newBuilder() .maximumSize(maxSize) .expireAfterWrite(expireSeconds, TimeUnit.SECONDS) .build(new CacheLoader&lt;Integer, Integer&gt;() { @Nullable @Override public Integer load(@NonNull Integer key) throws Exception { logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(key); } }); } public List&lt;DiscussPost&gt; findDiscussPosts(int userId, int offset, int limit, int orderMode) { //只缓存首页数据，并且每次只缓存一页，并且只缓存热门帖子 if (userId == 0 &amp;&amp; orderMode == 1) { return postListCache.get(offset + &quot;:&quot; + limit); } logger.debug(&quot;load list from DB&quot;); return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode); } public int findDiscussPostsRows(int userId) { if (userId == 0) { return postRowsCache.get(userId); } logger.debug(&quot;load post rows from DB&quot;); return discussPostMapper.selectDiscussPostRows(userId); } 插入30W条数据，用于压力测试 @Test public void initDataForTest() { for (int i = 0; i &lt; 300000; i++) { DiscussPost post = new DiscussPost(); post.setUserId(111); post.setTitle(&quot;互联网求职暖春计划&quot;); post.setContent(&quot;今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&amp;19届，拯救0 offer！&quot;); post.setCreateTime(new Date()); post.setScore(Math.random() * 2000); postService.addDiscussPost(post); } } @Test public void testCache() { System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 1)); System.out.println(postService.findDiscussPosts(0, 0, 10, 0)); } 使用Jmeter进行压力测试 优化前和优化后，吞吐量对比：速度大概增加了10倍 优化前： 优化后：","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://github.com/tietietietie/tietietietie.github.io/feed.xml" title="tie's blog" />

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a>

<article>
  <p class="post-meta">
    <time datetime="2020-07-23 07:48:00 +0800">2020-07-23</time>
  </p>
  
  <h1>社区论坛：性能提升和安全模块</h1>

  <h1 id="chapter-7">Chapter 7</h1>

<ul>
  <li>提高系统性能</li>
  <li>提高系统安全性</li>
</ul>

<h2 id="spring-security">Spring Security</h2>

<ul>
  <li>提高身份<strong>认证</strong>和<strong>授权</strong>（帖子置顶/加精/删除）</li>
  <li>方便扩展，自定义</li>
  <li>防止各种攻击</li>
  <li>可以和各种web开发集成（Spring MVC）</li>
</ul>

<h3 id="底层思路">底层思路</h3>

<p>Spring MVC ： DispatcherServlet —&gt; controller 一对多，其中拦截器可以在其中拦截请求，在DispatcherServlet之前，还有一个filter，可以对DispatcherServlet进行拦截，其中DispatcherServlet和filter都是javaEE的规范。</p>

<p>Spring Security利用Filter统一规范认证/授权，大概11个。（判断时机比较靠前）</p>

<p>Spring Security是Spring中比较难的，比较建议学习，对框架理解比较好。可以参考<a href="http://www.spring4all.com/article/428">这里</a>的教程</p>

<h3 id="演示demo">演示Demo</h3>

<p>打开demo，并导入Security组件，会自动为系统配置。</p>

<p>导入后，需要使用账号密码才能访问首页。账号为user，密码在服务端console可以看到</p>

<p>可以把这个登录页面换成自己的。</p>

<h4 id="需要将user实现userdetails接口">需要将User实现UserDetails接口</h4>

<p>根绝type来定义用户的权限（但是是字符串”USER”“ADMIN”</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//凭证未过期</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//账号可用</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//关键：权限</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">GrantedAuthority</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAuthority</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">){</span>
                    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                        <span class="k">return</span> <span class="s">"ADMIN"</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">return</span> <span class="s">"USER"</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="在userservice中实现userdetailsservice">在UserService中实现UserDetailsService</h4>

<p>实现此接口可以帮助Security来查询用户</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="c1">//和findUserByName的功能是一样的，但是实现这个方法，security可以帮助我们检查登录</span>
<span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="配置securityconfig重点">配置SecurityConfig（重点）</h4>

<p>包括如下配置：</p>

<ul>
  <li>忽略静态资源的权限判断</li>
  <li>实现”账号-密码”认证类的配置</li>
  <li>配置”认证“相关消息
    <ul>
      <li>登录页面</li>
      <li>配置连接的权限</li>
      <li>在账号-密码filter前面增加一个filter</li>
      <li>转发 VS 重定向</li>
      <li>添加Remember-me功能</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">WebSecurity</span> <span class="n">web</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//忽略静态资源</span>
        <span class="n">web</span><span class="o">.</span><span class="na">ignoring</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/resources/**"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//对认证处理，auth:认证核心结构，用于构造接口实例</span>
    <span class="c1">//常见实现类：provideManager为其默认实现类</span>
    <span class="c1">//没有验证码</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//内置的认证规则</span>
        <span class="c1">//auth.userDetailsService(userService).passwordEncoder(new Pbkdf2PasswordEncoder("12345"));</span>
        <span class="c1">//自定义认证规则</span>
        <span class="c1">//有多种AuthenticationProvider，每一种访问一种认证</span>
        <span class="c1">//AuthenticationManagerBuilder自己不去做认证，委托给AuthenticationProvider</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationProvider</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="c1">//实现账号密码认证</span>
            <span class="c1">//authentication用于封装认证信息的接口，不同的实现类代表不同类型的认证信息</span>
            <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">();</span>

                <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"账号不存在"</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">password</span> <span class="o">=</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="n">password</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">());</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">)){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"密码不正确"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">//认证的主要信息 + 证书 + 权限</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="c1">//返回当前接口是哪种类型，账号密码？指纹？短信？</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//UsernamePasswordAuthenticationToken是authentication的常用的实现类，表示账号密码认证模式</span>
                <span class="k">return</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">aClass</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//认证</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//配置登录相关的配置，告诉那个请求是登录</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/loginpage"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">successHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationSuccessHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/index"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">failureHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationFailureHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                        <span class="c1">//不能重定向,要用转发</span>
                        <span class="c1">//重定向：适合两个独立组件，当组件A完成没有什么东西返回时，（302）重定向到B，此时A不能给B带数据</span>
                        <span class="c1">//转发：两个独立组件，A只能完成请求的一半，然后由B处理，但是此时浏览器不知道B的存在（A和B有耦合）</span>
                        <span class="c1">//此处：A:login --&gt; B:loginpage，也可以用模板，但是此处不行，不再controller内</span>
                        <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                        <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">"/loginpage"</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">()</span>
                <span class="o">.</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LogoutSuccessHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutSuccess</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/index"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>

        <span class="c1">//配置授权</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/letter"</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">"USER"</span><span class="o">,</span> <span class="s">"ADMIN"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin"</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">exceptionHandling</span><span class="o">().</span><span class="na">accessDeniedPage</span><span class="o">(</span><span class="s">"/denied"</span><span class="o">);</span>

        <span class="c1">//增加filter</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="k">new</span> <span class="nc">Filter</span><span class="o">(){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                <span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">servletRequest</span><span class="o">;</span>
                <span class="nc">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">servletResponse</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getServletPath</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)){</span>
                    <span class="nc">String</span> <span class="n">verifyCode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"verifyCode"</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">verifyCode</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">verifyCode</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"1234"</span><span class="o">)){</span>
                        <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span><span class="s">"验证码错误"</span><span class="o">);</span>
                        <span class="n">request</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">"/loginpage"</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">//放行请求，请求继续执行</span>
                <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">()</span>
                <span class="o">.</span><span class="na">tokenRepository</span><span class="o">(</span><span class="k">new</span> <span class="nc">InMemoryTokenRepositoryImpl</span><span class="o">())</span>
                <span class="o">.</span><span class="na">tokenValiditySeconds</span><span class="o">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="o">)</span>
                <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="修改页面模板">修改页面模板</h4>

<p>在Security中，logout功能必须是post请求</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>首页<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;h1&gt;</span>社区首页<span class="nt">&lt;/h1&gt;</span>
    <span class="c">&lt;!--欢迎信息--&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">th:if=</span><span class="s">"${loginUser!=null}"</span><span class="nt">&gt;</span>
        欢迎你，<span class="nt">&lt;span</span> <span class="na">th:text=</span><span class="s">"${loginUser.username}"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/p&gt;</span>

    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/discuss}"</span><span class="nt">&gt;</span>帖子详情<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/letter}"</span><span class="nt">&gt;</span>私信列表<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/loginpage}"</span><span class="nt">&gt;</span>登录<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="c">&lt;!--&lt;li&gt;&lt;a th:href="@{/loginpage}"&gt;退出&lt;/a&gt;&lt;/li&gt;--&gt;</span>
        <span class="c">&lt;!--
        *Security实现的logout必须是post
        --&gt;</span>
        <span class="nt">&lt;li&gt;</span>
            <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">th:action=</span><span class="s">"@{/logout}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"javascript:document.forms[0].submit();"</span><span class="nt">&gt;</span>退出<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<h2 id="权限控制">权限控制</h2>

<ul>
  <li>废弃拦截器，使用SpringSecurity来进行登录检查</li>
  <li>授权配置，分配权限：普通用户，版主，管理员</li>
  <li>使用原有认证方案：登录退出使用原来的代码</li>
  <li>CSRF配置：防止CSRF攻击</li>
</ul>

<h3 id="废弃拦截器">废弃拦截器</h3>

<p>在WebMvcConfig中，讲login拦截器注释掉</p>

<h3 id="设置权限">设置权限</h3>

<p>对一些路径进行权限设置/</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="kd">implements</span> <span class="nc">CommunityConstant</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="c1">//忽略静态资源</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">WebSecurity</span> <span class="n">web</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">web</span><span class="o">.</span><span class="na">ignoring</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/resources/**"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//授权</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
                        <span class="s">"/user/setting"</span><span class="o">,</span>
                        <span class="s">"/user/upload"</span><span class="o">,</span>
                        <span class="s">"/comment/add/**"</span><span class="o">,</span>
                        <span class="s">"/discuss/add"</span><span class="o">,</span>
                        <span class="s">"/letter/**"</span><span class="o">,</span>
                        <span class="s">"/notice/**"</span><span class="o">,</span>
                        <span class="s">"/like"</span><span class="o">,</span>
                        <span class="s">"follow"</span><span class="o">,</span>
                        <span class="s">"unfollow"</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">hasAnyAuthority</span><span class="o">(</span>
                        <span class="no">AUTHORITY_USER</span><span class="o">,</span>
                        <span class="no">AUTHORITY_ADMIN</span><span class="o">,</span>
                        <span class="no">AUTHORITY_MODERATOR</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="c1">//没有权限的异常处理</span>
        <span class="n">http</span><span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
                <span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">AccessDeniedHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="c1">//权限不足处理</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AccessDeniedException</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                        <span class="nc">String</span> <span class="n">xRequestedWith</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"x-requested-with"</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">xRequestedWith</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"XMLHttpRequest"</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/plain; charset=utf-8"</span><span class="o">);</span>
                            <span class="nc">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
                            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">403</span><span class="o">,</span> <span class="s">"您无权限访问此功能"</span><span class="o">));</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/denied"</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationEntryPoint</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="c1">//没有登录处理</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
                        <span class="nc">String</span> <span class="n">xRequestedWith</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"x-requested-with"</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="s">"XMLHttpRequest"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">xRequestedWith</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/plain; charset=utf-8"</span><span class="o">);</span>
                            <span class="nc">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
                            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">403</span><span class="o">,</span> <span class="s">"您还没有登录，请登录"</span><span class="o">));</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/login"</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="c1">//默认Logout退出，会用filter拦截</span>
        <span class="c1">//将security中的默认登出路径设置如下，避免覆盖我们自己的登出代码</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">"/securityLogout"</span><span class="o">);</span>
        <span class="c1">//Security获得权限需要在SecurityContext里获得</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在LoginTicket拦截器中，对登录的用户配置权限（因为在没有用security处理登录时，SecurityContext没有用户的权限信息，需要我们手动添加）</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//从cookie中获取ticket</span>
        <span class="nc">String</span> <span class="n">ticket</span> <span class="o">=</span> <span class="nc">CookieUtil</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">"ticket"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ticket</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">LoginTicket</span> <span class="n">loginTicket</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findLoginTicket</span><span class="o">(</span><span class="n">ticket</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">loginTicket</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">loginTicket</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">loginTicket</span><span class="o">.</span><span class="na">getExpired</span><span class="o">().</span><span class="na">after</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">loginTicket</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
                <span class="c1">//在本此请求中持有用户，考虑多线程并发，多线程隔离</span>
                <span class="n">hostHolder</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
                <span class="c1">//构建用户认证结果，并存入SecurityContext,以便于Security进行权限管理</span>
                <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span>
                        <span class="n">user</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">userService</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
                <span class="o">);</span>
                <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="k">new</span> <span class="nc">SecurityContextImpl</span><span class="o">(</span><span class="n">authentication</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="csrf原理">CSRF原理</h3>

<p>某一网站盗取Cookie中的凭证（ticket），从而模拟用户提交表单。</p>

<p>解决办法：引入Security后，用户请求提交表单时，Security会在表单中加一个隐藏的Token，其他网站能够窃取到你的Ticket，但是无法获得你的表单数据（其中的Token），从而会被服务器发现。</p>

<p>问题：异步请求的时候需要自己处理，演示如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;!--&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">"_csrf"</span> <span class="nl">th:</span><span class="n">content</span><span class="o">=</span><span class="s">"${_csrf.token}"</span><span class="o">&gt;--&gt;</span>
<span class="o">&lt;!--&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s">"_csrf_header"</span> <span class="nl">th:</span><span class="n">content</span><span class="o">=</span><span class="s">"${_csrf.headerName}"</span><span class="o">&gt;--&gt;</span>
<span class="err">$</span><span class="o">(</span><span class="n">function</span><span class="o">(){</span>
	<span class="err">$</span><span class="o">(</span><span class="s">"#publishBtn"</span><span class="o">).</span><span class="na">click</span><span class="o">(</span><span class="n">publish</span><span class="o">);</span>
<span class="o">});</span>


<span class="n">function</span> <span class="nf">publish</span><span class="o">()</span> <span class="o">{</span>
	<span class="err">$</span><span class="o">(</span><span class="s">"#publishModal"</span><span class="o">).</span><span class="na">modal</span><span class="o">(</span><span class="s">"hide"</span><span class="o">);</span>
	<span class="c1">//发送AJAX请求前，需要带上CSRF令牌</span>
<span class="c1">//    var token = $("mata[name='_csrf']").attr("content");</span>
<span class="c1">//    var header = $("mata[name='_csrf_header']").attr("content");</span>
<span class="c1">//    $(document).ajaxSend(function(e, xhr, options){</span>
<span class="c1">//        xhr.setRequestHeader(header, token);</span>
<span class="c1">//    });</span>
	<span class="c1">//先返回结果再显示</span>
    <span class="c1">//获取标题/内容</span>
    <span class="kt">var</span> <span class="n">title</span> <span class="o">=</span>  <span class="err">$</span><span class="o">(</span><span class="s">"#recipient-name"</span><span class="o">).</span><span class="na">val</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">content</span> <span class="o">=</span> <span class="err">$</span><span class="o">(</span><span class="s">"#message-text"</span><span class="o">).</span><span class="na">val</span><span class="o">();</span>
    <span class="c1">//发送异步请求</span>
    <span class="err">$</span><span class="o">.</span><span class="na">post</span><span class="o">(</span>
        <span class="s">"/community/discuss/add"</span><span class="o">,</span>
        <span class="o">{</span><span class="s">"title"</span><span class="o">:</span><span class="n">title</span><span class="o">,</span><span class="s">"content"</span><span class="o">:</span><span class="n">content</span><span class="o">},</span>
        <span class="n">function</span><span class="o">(</span><span class="n">data</span><span class="o">){</span>
            <span class="n">data</span> <span class="o">=</span> <span class="err">$</span><span class="o">.</span><span class="na">parseJSON</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="c1">//提示框显示返回消息</span>
            <span class="err">$</span><span class="o">(</span><span class="s">"#hintBody"</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">msg</span><span class="o">);</span>
            <span class="c1">//显示提示框/两秒后自动隐藏</span>
            <span class="err">$</span><span class="o">(</span><span class="s">"#hintModal"</span><span class="o">).</span><span class="na">modal</span><span class="o">(</span><span class="s">"show"</span><span class="o">);</span>
            <span class="n">setTimeout</span><span class="o">(</span><span class="n">function</span><span class="o">(){</span>
                <span class="err">$</span><span class="o">(</span><span class="s">"#hintModal"</span><span class="o">).</span><span class="na">modal</span><span class="o">(</span><span class="s">"hide"</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">code</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">window</span><span class="o">.</span><span class="na">location</span><span class="o">.</span><span class="na">reload</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">},</span> <span class="mi">2000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="置顶加精删除">置顶，加精，删除</h2>

<ul>
  <li>功能实现：置顶—&gt;修改帖子类型，加精，删除 —&gt; 修改帖子状态</li>
  <li>权限管理：用security设置即可</li>
  <li>按钮显示：thymeleaf可以支持Security，但是需要添加包</li>
</ul>

<h3 id="实现置顶加精删除">实现置顶，加精，删除</h3>

<p>数据层</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">updateType</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"type"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">type</span><span class="o">);</span>

<span class="kt">int</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"status"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">status</span><span class="o">);</span>
</code></pre></div></div>

<p>服务层</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateType</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">updateType</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>控制层</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//置顶</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/top"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">setTop</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">discussPostService</span><span class="o">.</span><span class="na">updateType</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

    <span class="c1">//帖子同步ES</span>
    <span class="c1">//触发发帖事件</span>
    <span class="c1">//触发发帖事件</span>
    <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="no">TOPIC_PUBLISH</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">setEntityType</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setEntityId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">producer</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//加精</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/wonderful"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">setWonderful</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">discussPostService</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

    <span class="c1">//帖子同步ES</span>
    <span class="c1">//触发发帖事件</span>
    <span class="c1">//触发发帖事件</span>
    <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="no">TOPIC_PUBLISH</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">setEntityType</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setEntityId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">producer</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//删除</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/delete"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">setDelete</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">discussPostService</span><span class="o">.</span><span class="na">updateStatus</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>

    <span class="c1">//帖子同步ES</span>
    <span class="c1">//触发发帖事件</span>
    <span class="c1">//触发删帖事件</span>
    <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="no">TOPIC_DELETE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">setEntityType</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setEntityId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">producer</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="设置权限-1">设置权限</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
                        <span class="s">"/user/setting"</span><span class="o">,</span>
                        <span class="s">"/user/upload"</span><span class="o">,</span>
                        <span class="s">"/comment/add/**"</span><span class="o">,</span>
                        <span class="s">"/discuss/add"</span><span class="o">,</span>
                        <span class="s">"/letter/**"</span><span class="o">,</span>
                        <span class="s">"/notice/**"</span><span class="o">,</span>
                        <span class="s">"/like"</span><span class="o">,</span>
                        <span class="s">"follow"</span><span class="o">,</span>
                        <span class="s">"unfollow"</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">hasAnyAuthority</span><span class="o">(</span>
                        <span class="no">AUTHORITY_USER</span><span class="o">,</span>
                        <span class="no">AUTHORITY_ADMIN</span><span class="o">,</span>
                        <span class="no">AUTHORITY_MODERATOR</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
                        <span class="s">"/discuss/top"</span><span class="o">,</span>
                        <span class="s">"/discuss/wonderful"</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">hasAnyAuthority</span><span class="o">(</span>
                        <span class="no">AUTHORITY_MODERATOR</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span>
                        <span class="s">"/discuss/delete"</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">hasAnyAuthority</span><span class="o">(</span>
                        <span class="no">AUTHORITY_ADMIN</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
</code></pre></div></div>

<h2 id="redis高级数据类型">Redis高级数据类型</h2>

<ul>
  <li>HyperLogLog：超级日志
    <ul>
      <li>基数算法，独立总数统计，多次请求去重</li>
      <li>数据占用空间少，只占12K的内存空间</li>
      <li>不精确的统计算法，标准误差为0.81%</li>
    </ul>
  </li>
  <li>Bitmap：位图
    <ul>
      <li>特殊格式字符串，按位存储数据</li>
      <li>其实是byte数组</li>
      <li>大量连续数据的布尔值，如每天的签到。如一年的签到数据：365/8，只有40多个字节</li>
    </ul>
  </li>
</ul>

<p>都适合用来给网站运营的数据进行统计，并且节约内存</p>

<p>使用redis中的hyperloglog和bitmap，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//统计20W个数据的独立整合</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testHyperLogLog</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="s">"test:hll:01"</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> 
            <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="n">redisKey</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//将三组数据合并，在合并后的重复数据中，统计独立正数</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testHyperLogLogUnion</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey2</span> <span class="o">=</span> <span class="s">"test:hll:02"</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey2</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">redisKey3</span> <span class="o">=</span> <span class="s">"test:hll:03"</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5001</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey3</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">redisKey4</span> <span class="o">=</span> <span class="s">"test:hll:04"</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10001</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">20000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey4</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">unionKey</span> <span class="o">=</span> <span class="s">"test:hll:union"</span><span class="o">;</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">union</span><span class="o">(</span><span class="n">unionKey</span><span class="o">,</span> <span class="n">redisKey2</span><span class="o">,</span> <span class="n">redisKey3</span><span class="o">,</span> <span class="n">redisKey4</span><span class="o">);</span>

        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="n">unionKey</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//统计一组数据的布尔值</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBitMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="s">"test:bm:01"</span><span class="o">;</span>

        <span class="c1">//记录</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="c1">//查询</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">getBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">getBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">getBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>

        <span class="c1">//统计</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">bitCount</span><span class="o">(</span><span class="n">redisKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//统计三组数据布尔值，并进行or运算</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBitMapOperation</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey2</span> <span class="o">=</span> <span class="s">"test:bm:02"</span><span class="o">;</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey2</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">redisKey3</span> <span class="o">=</span> <span class="s">"test:bm:03"</span><span class="o">;</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey3</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey3</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">redisKey4</span> <span class="o">=</span> <span class="s">"test:bm:04"</span><span class="o">;</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey4</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey4</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="s">"test:bm:or"</span><span class="o">;</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
                <span class="n">connection</span><span class="o">.</span><span class="na">bitOp</span><span class="o">(</span><span class="nc">RedisStringCommands</span><span class="o">.</span><span class="na">BitOperation</span><span class="o">.</span><span class="na">OR</span><span class="o">,</span> <span class="n">redisKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span>
                        <span class="n">redisKey2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">redisKey3</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">redisKey4</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">bitCount</span><span class="o">(</span><span class="n">redisKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="网站数据统计">网站数据统计</h2>

<ul>
  <li>UV：独立访客，通过IP地址统计，希望把匿名用户（游客）也统计起来。每次访问都要统计，因为不确定此次访问的IP是否已经记录过。用HyperLogLog进行统计。</li>
  <li>DAU：日活跃用户，访问过一次则认为其是活跃或用。与UV的区别是：通过userId进行排重（已注册用户），而且是比较精确的结果，故使用bitmap。可以用UserId为Index,在redis中存储，（key为日期），所以每天需要大概几十万位。</li>
</ul>

<h3 id="定义rediskey">定义RedisKey</h3>

<p>分别定义UA和DAU的rediskey</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//单日UV</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getUVKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">PREFIX_UV</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//区间UV</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getUVKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">startDate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">PREFIX_UV</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">startDate</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">endDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//单日DAU</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getDAUKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">PREFIX_DAU</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//区间DAU</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getDAUKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">startDate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">PREFIX_DAU</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">startDate</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="n">endDate</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="dataservice">DataService</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyyMMdd"</span><span class="o">);</span>

    <span class="c1">//记录UV数据，记录指定IP</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recordIV</span><span class="o">(</span><span class="nc">String</span> <span class="n">ip</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getUVKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">ip</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//统计指定范围内的UV</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">calculateUV</span><span class="o">(</span><span class="nc">Date</span> <span class="n">start</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">start</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数不能为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//整理key</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keyList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Calendar</span> <span class="n">calendar</span> <span class="o">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="n">calendar</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="n">start</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">calendar</span><span class="o">.</span><span class="na">getTime</span><span class="o">().</span><span class="na">after</span><span class="o">(</span><span class="n">end</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getUVKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">calendar</span><span class="o">.</span><span class="na">getTime</span><span class="o">()));</span>
            <span class="n">keyList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="n">calendar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Calendar</span><span class="o">.</span><span class="na">DATE</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getUVKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">start</span><span class="o">),</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">end</span><span class="o">));</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">union</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">keyList</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="n">redisKey</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//记录指定用户到DAU</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recordDAU</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getDAUKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="n">redisKey</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//统计指定范围内的DAU</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">calculateDAU</span><span class="o">(</span><span class="nc">Date</span> <span class="n">start</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">start</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数不能为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//整理key</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">keyList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Calendar</span> <span class="n">calendar</span> <span class="o">=</span> <span class="nc">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="n">calendar</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="n">start</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">calendar</span><span class="o">.</span><span class="na">getTime</span><span class="o">().</span><span class="na">after</span><span class="o">(</span><span class="n">end</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getDAUKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">calendar</span><span class="o">.</span><span class="na">getTime</span><span class="o">()));</span>
            <span class="n">keyList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">calendar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Calendar</span><span class="o">.</span><span class="na">DATE</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getDAUKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">start</span><span class="o">),</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">end</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getDAUKey</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">start</span><span class="o">),</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">end</span><span class="o">));</span>
                <span class="n">connection</span><span class="o">.</span><span class="na">bitOp</span><span class="o">(</span><span class="nc">RedisStringCommands</span><span class="o">.</span><span class="na">BitOperation</span><span class="o">.</span><span class="na">OR</span><span class="o">,</span> <span class="n">redisKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">keyList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">]));</span>
                <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">bitCount</span><span class="o">(</span><span class="n">redisKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="拦截器">拦截器</h3>

<p>每次请求需要判断Ip和用户</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Datainteceptor</span> <span class="kd">implements</span> <span class="nc">HandlerInterceptor</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DataService</span> <span class="n">dataService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">HostHolder</span> <span class="n">hostHolder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//记录UV</span>
        <span class="nc">String</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteHost</span><span class="o">();</span>
        <span class="n">dataService</span><span class="o">.</span><span class="na">recordIV</span><span class="o">(</span><span class="n">ip</span><span class="o">);</span>

        <span class="c1">//记录DAU</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataService</span><span class="o">.</span><span class="na">recordDAU</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="controller">Controller</h3>

<p>实现访问数据页/查询UV/查询dau的功能</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DataService</span> <span class="n">dataService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/data"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="o">{</span><span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDataPage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"/site/admin/data"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/data/uv"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUV</span><span class="o">(</span><span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">)</span> <span class="nc">Date</span> <span class="n">start</span><span class="o">,</span>
                        <span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">)</span> <span class="nc">Date</span> <span class="n">end</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">dataService</span><span class="o">.</span><span class="na">calculateUV</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"uvResult"</span><span class="o">,</span> <span class="n">uv</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"uvStartDate"</span><span class="o">,</span> <span class="n">start</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"uvEndDate"</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"forward:/data"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/data/dau"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDAU</span><span class="o">(</span><span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">)</span> <span class="nc">Date</span> <span class="n">start</span><span class="o">,</span>
                         <span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">)</span> <span class="nc">Date</span> <span class="n">end</span><span class="o">,</span> <span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">dataService</span><span class="o">.</span><span class="na">calculateDAU</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"dauResult"</span><span class="o">,</span> <span class="n">uv</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"dauStartDate"</span><span class="o">,</span> <span class="n">start</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"dauEndDate"</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"forward:/data"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="配置权限">配置权限</h3>

<p>在SecurityConfig下添加路径即可</p>

<h2 id="任务执行和调度">任务执行和调度</h2>

<ul>
  <li>JDK线程池
    <ul>
      <li>ExecutorService</li>
      <li>ScheduledExecutorService</li>
    </ul>
  </li>
  <li>Spring线程池
    <ul>
      <li>ThreadPoolTaskExecutor</li>
      <li>ThreadPoolTaskScheduler</li>
    </ul>
  </li>
  <li>分布式定时任务
    <ul>
      <li>Spring Quartz</li>
    </ul>
  </li>
</ul>

<p>在分布式部署中，使用JDK或者Spring的线程池调度，会有问题。在分布式服务器中，请求会通过Nginx来分配，从而可以实现负载均衡，但是Scheduler不能被Nigix管理，所以同一的Scheduler请求，可能会在多服务器执行多次。</p>

<p>使用Quartz，不同服务器的Scheduler运行时，会在数据库服务器访问运行数据，通过排队（加锁），可以使得程序只运行一次。</p>

<h3 id="jdk线程池演示">JDK线程池演示</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">CommunityApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ThreadPoolTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">//演示JDK普通线程池</span>
    <span class="c1">//包含5个线程</span>
    <span class="kd">private</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

    <span class="c1">//定时执行任务的线程池</span>
    <span class="kd">private</span> <span class="nc">ScheduledExecutorService</span> <span class="n">scheduledExecutorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

    <span class="c1">//使用test方法，让当前线程sleep，以避免线程自动结束</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//演示JDK普通线程池</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testExecutorService</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"hello, executorService"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//JDK定时任务线程池</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testScheduledExecutorService</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"hello, scheduledExecutorService"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">scheduledExecutorService</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="mi">10000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">30000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="spring线程池">Spring线程池</h3>

<p>配置：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#TaskExecutionProperties
spring.task.execution.pool.core-size=5
spring.task.execution.pool.max-size=15
spring.task.execution.pool.queue-capacity=100
#TaskSchedulingProperties
spring.task.scheduling.pool.size=5
</code></pre></div></div>

<p>演示：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//演示Spring普通线程池</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testThreadPoolTaskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"hello, ThreadPoolTaskExecutor"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">taskExecutor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//演示Spring定时线程</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testThreadPoolTaskScheduler</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"hello, ThreadPoolTaskScheduler"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Date</span> <span class="n">startTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="n">taskScheduler</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">startTime</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">30000</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="spring使用多线程的简单方法">Spring使用多线程的简单方法</h3>

<p>通过注解即可</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Async</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute1</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"当前执行线程为"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">initialDelay</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">,</span> <span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduled1</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"当前执行定时任务，执行线程为 ---&gt;"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//Spring多线程简便方法</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testThreadPoolTaskExecutorSimple</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">alphaService</span><span class="o">.</span><span class="na">execute1</span><span class="o">();</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//Spring定时任务简化</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testThreadPoolTaskSchedulerSimple</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">30000</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="quartz演示">Quartz演示</h3>

<p>需要提前创建Database，其中存放运行定时任务，所需要的信息</p>

<p>默认读取内存中数据，所以需要配置</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># QuartzProperties
spring.quartz.job-store-type=jdbc
spring.quartz.scheduler-name=communityScheduler
spring.quartz.properties.org.quartz.scheduler.instanceId=AUTO
spring.quartz.properties.org.quartz.jobStore.class=org.quartz.impl.jdbcjobstore.JobStoreTX
spring.quartz.properties.org.quartz.jobStore.driverDelegateClass=org.quartz.impl.jdbcjobstore.StdJDBCDelegate
spring.quartz.properties.org.quartz.jobStore.isClustered=true
spring.quartz.properties.org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool
spring.quartz.properties.org.quartz.threadPool.threadCount=5
</code></pre></div></div>

<p>定义QuarzJob</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AlphaJob</span> <span class="kd">implements</span> <span class="nc">Job</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": execute quartz job"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>配置Quartz</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzConfig</span> <span class="o">{</span>
    <span class="c1">//FactoryBean，可以简化Bean的实例化过程</span>
    <span class="c1">//1.通过factoryBean封装Bean的实例化过程</span>
    <span class="c1">//2.将FactorBean装配到容器里</span>
    <span class="c1">//3.FactoryBean注入给其他的Bean，</span>
    <span class="c1">//4.其他的Bean得到了FactoryBean所管理的实例对象</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JobDetailFactoryBean</span> <span class="nf">alphaJobDetail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">JobDetailFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JobDetailFactoryBean</span><span class="o">();</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobClass</span><span class="o">(</span><span class="nc">AlphaJob</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"alphaJob"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setGroup</span><span class="o">(</span><span class="s">"alphaGroup"</span><span class="o">);</span>
        <span class="c1">//长久保存</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setDurability</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setRequestsRecovery</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">factoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleTriggerFactoryBean</span> <span class="nf">simpleTrigger</span><span class="o">(</span><span class="nc">JobDetail</span> <span class="n">alphaJobDetail</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SimpleTriggerFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleTriggerFactoryBean</span><span class="o">();</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobDetail</span><span class="o">(</span><span class="n">alphaJobDetail</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"alphaTrigger"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setGroup</span><span class="o">(</span><span class="s">"alphaTriggerGroup"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setRepeatInterval</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobDataMap</span><span class="o">(</span><span class="k">new</span> <span class="nc">JobDataMap</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">factoryBean</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>此时上述Job就能在项目启动后，自动运行，如果需要删除，可执行如下代码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeleteJob</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="na">deleteJob</span><span class="o">(</span><span class="k">new</span> <span class="nc">JobKey</span><span class="o">(</span><span class="s">"alphaJob"</span><span class="o">,</span> <span class="s">"alphaGroup"</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="热帖排名">热帖排名</h2>

<p>时间增加，分数减小，评论/收藏/点赞越多，分数越高。</p>

<p>分数计算方式：定时算一次，从而能保证帖子的分数一段时间是不变的。</p>

<p>只算分数变化的帖子 —&gt; 把分数变化的帖子放在Redis中。</p>

<h3 id="统计帖子分数">统计帖子分数</h3>

<h4 id="rediskey">RedisKey</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getPostScore</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">PREFIX_POSt</span> <span class="o">+</span> <span class="no">SPLIT</span> <span class="o">+</span> <span class="s">"socre"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="能修改帖子分数的地方存入redis">能修改帖子分数的地方，存入Redis</h4>

<p>包括点赞/评论/发帖/加精</p>

<h4 id="定义定时任务">定义定时任务</h4>

<p>每隔5分钟运行一次</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JobDetailFactoryBean</span> <span class="nf">postScoreRefreshJobDetail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">JobDetailFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JobDetailFactoryBean</span><span class="o">();</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobClass</span><span class="o">(</span><span class="nc">PostScoreReferenceJob</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"postScoreReferenceJob"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setGroup</span><span class="o">(</span><span class="s">"communityJobGroup"</span><span class="o">);</span>
        <span class="c1">//长久保存</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setDurability</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setRequestsRecovery</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">factoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//刷新帖子分数</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleTriggerFactoryBean</span> <span class="nf">postScoreRefreshTrigger</span><span class="o">(</span><span class="nc">JobDetail</span> <span class="n">postScoreRefreshJobDetail</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SimpleTriggerFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleTriggerFactoryBean</span><span class="o">();</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobDetail</span><span class="o">(</span><span class="n">postScoreRefreshJobDetail</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"postScoreRefreshTrigger"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setGroup</span><span class="o">(</span><span class="s">"communityTriggerGroup"</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setRepeatInterval</span><span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>
        <span class="n">factoryBean</span><span class="o">.</span><span class="na">setJobDataMap</span><span class="o">(</span><span class="k">new</span> <span class="nc">JobDataMap</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">factoryBean</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>计算分数（job)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostScoreReferenceJob</span> <span class="kd">implements</span> <span class="nc">Job</span><span class="o">,</span> <span class="nc">CommunityConstant</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">PostScoreReferenceJob</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">//牛客纪元</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Date</span> <span class="n">epoch</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="s">"2014-08-01 00:00:00"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"初始化牛客网纪元失败"</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DiscussPostService</span> <span class="n">discussPostService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">LikeService</span> <span class="n">likeService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ElasticsearchService</span> <span class="n">elasticsearchService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="nc">RedisKeyUtil</span><span class="o">.</span><span class="na">getPostScore</span><span class="o">();</span>
        <span class="nc">BoundSetOperations</span> <span class="n">operations</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">boundSetOps</span><span class="o">(</span><span class="n">redisKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">operations</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"任务取消，没有需要重新计分的帖子"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"任务开始，正在计算帖子分数： "</span> <span class="o">+</span> <span class="n">operations</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">operations</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">refresh</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">operations</span><span class="o">.</span><span class="na">pop</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"帖子分数计算结束！"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="kt">int</span> <span class="n">postId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPostById</span><span class="o">(</span><span class="n">postId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">post</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"帖子不存在，postId :"</span> <span class="o">+</span> <span class="n">postId</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//计算是否加精，评论数，点赞数</span>
        <span class="kt">boolean</span> <span class="n">wonderful</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">commentCount</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">getCommentCount</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="n">likeService</span><span class="o">.</span><span class="na">findEntityLikeCount</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">,</span> <span class="n">postId</span><span class="o">);</span>
        <span class="c1">//计算权重</span>
        <span class="kt">double</span> <span class="n">w</span> <span class="o">=</span> <span class="o">(</span><span class="n">wonderful</span> <span class="o">?</span> <span class="mi">75</span> <span class="o">:</span> <span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">commentCount</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">likeCount</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">score</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">log10</span><span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
                <span class="o">+</span> <span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getCreateTime</span><span class="o">().</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">epoch</span><span class="o">.</span><span class="na">getTime</span><span class="o">())</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="o">);</span>
        <span class="c1">//更新帖子的分数</span>
        <span class="n">discussPostService</span><span class="o">.</span><span class="na">updateScore</span><span class="o">(</span><span class="n">postId</span><span class="o">,</span> <span class="n">score</span><span class="o">);</span>
        <span class="c1">//同步service</span>
        <span class="n">post</span><span class="o">.</span><span class="na">setScore</span><span class="o">(</span><span class="n">score</span><span class="o">);</span>
        <span class="n">elasticsearchService</span><span class="o">.</span><span class="na">saveDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="修改排序方式">修改排序方式</h3>

<h4 id="数据访问层">数据访问层</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DiscussPostMapper</span> <span class="o">{</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="nf">selectDiscussPosts</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"limit"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"orderMode"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">orderMode</span><span class="o">);</span>
</code></pre></div></div>

<h4 id="服务层">服务层</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="nf">findDiscussPosts</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span> <span class="kt">int</span> <span class="n">orderMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="n">orderMode</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="控制层">控制层</h4>

<p>orderMode通过路径传过来</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/index"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getIndexPage</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">,</span> <span class="nc">Page</span> <span class="n">page</span><span class="o">,</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"orderMode"</span><span class="o">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">"0"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">orderMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setRows</span><span class="o">(</span><span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPostsRows</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/index?orderMode="</span> <span class="o">+</span> <span class="n">orderMode</span><span class="o">);</span>
        <span class="c1">//在方法调用前，SpringMVC会自动实例化Page和Model，并且将Page注入Model</span>
        <span class="c1">//所以可以在thymeleaf中直接访问Page对象中的数据。</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">discussPostService</span><span class="o">.</span><span class="na">findDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">page</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span> <span class="n">page</span><span class="o">.</span><span class="na">getLimit</span><span class="o">(),</span> <span class="n">orderMode</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">discussPosts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"post"</span><span class="o">,</span> <span class="n">post</span><span class="o">);</span>
            <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserById</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="n">likeService</span><span class="o">.</span><span class="na">findEntityLikeCount</span><span class="o">(</span><span class="no">ENTITY_TYPE_POST</span><span class="o">,</span> <span class="n">post</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"likeCount"</span><span class="o">,</span> <span class="n">likeCount</span><span class="o">);</span>
            <span class="n">discussPosts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"discussPosts"</span><span class="o">,</span> <span class="n">discussPosts</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"orderMode"</span><span class="o">,</span> <span class="n">orderMode</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"/index"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Idea查看方法调用的快捷键：alt + F7</p>

<h2 id="生成长图">生成长图</h2>

<ul>
  <li>将模板文件转换为PDF（在服务端）</li>
  <li>使用wkhtmltopdf
    <ul>
      <li>1，wkhtmltopdf url file</li>
      <li>2，wkhtmltoimage url file</li>
    </ul>
  </li>
  <li>通过java
    <ul>
      <li>Runtime.getRuntime().exec();</li>
    </ul>
  </li>
  <li><a href="https://wkhtmltopdf.org/">官网</a></li>
  <li>配置环境变量</li>
</ul>

<p>通过命令访问工具</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wkhtmltoimage --quality 75 https://www.nowcoder.com d:/Java/nowcoder_project/wk_image/1.png
</code></pre></div></div>

<h3 id="模拟分享功能">模拟分享功能</h3>

<p>将命令行设置为可配置，将图片位置设置为可配，检查路径是否存在（wk不能生成路径）</p>

<p>创建配置文件：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#wk
wk.image.command=d:/Java/nowcoder_project/wkhtmltopdf/bin/wkhtmltoimage
wk.image.storage=d:/Java/nowcoder_project/wk_image
</code></pre></div></div>

<h4 id="sharecontroller">ShareController</h4>

<p>使用Kafka，并且异步驱动，可以节省时间</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShareController</span> <span class="kd">implements</span> <span class="nc">CommunityConstant</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ShareController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">EventProducer</span> <span class="n">eventProducer</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${community.path.domain}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">domain</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.servlet.context-path}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">contextPath</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${wk.image.storage}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">wkImageStorage</span><span class="o">;</span>

    <span class="c1">//生成图片：异步驱动</span>
    <span class="c1">//处理为事件，因为生成的时间可能比较长，用户不需要在页面等待。</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/share"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">share</span><span class="o">(</span><span class="nc">String</span> <span class="n">htmlUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//文件名随机</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">generateUUID</span><span class="o">();</span>
        <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="no">TOPIC_SHARE</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"htmlUrl"</span><span class="o">,</span> <span class="n">htmlUrl</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"suffix"</span><span class="o">,</span> <span class="s">".png"</span><span class="o">);</span>
        <span class="n">eventProducer</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
        <span class="c1">//返回访问路径</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"shareUrl"</span><span class="o">,</span> <span class="n">domain</span> <span class="o">+</span> <span class="n">contextPath</span> <span class="o">+</span> <span class="s">"/share/image/"</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//获取长图</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/share/image/{fileName}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getShareImage</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">fileName</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"文件名不能为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"image/png"</span><span class="o">);</span>
        <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">wkImageStorage</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s">".png"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
            <span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"获取长图失败"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="eventconsumer">EventConsumer</h4>

<p>处理分享事件</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//消费分享时间</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="o">{</span><span class="no">TOPIC_SHARE</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShareMessage</span><span class="o">(</span><span class="nc">ConsumerRecord</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息内容为空"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Event</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息格式错误"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">htmlUrl</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"htmlUrl"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">suffix</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"suffix"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">wkImageCommand</span> <span class="o">+</span> <span class="s">" --quality 75 "</span> <span class="o">+</span> <span class="n">htmlUrl</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">wkImageStorage</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"生成图片成功"</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"生成图片失败"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">+</span> <span class="s">"  "</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="文件上传云服务器">文件上传云服务器</h2>

<ul>
  <li>客户端上传</li>
  <li>服务器直传</li>
</ul>

<p>需要注册<a href="https://www.qiniu.com/">七牛云</a>，并且创建两个空间，用于存储用户头像和用户share图片</p>

<p>设置七牛云的配置参数</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#qiniu
qiniu.key.access=LeG24jUYDhS6YFSxe2d6EEC1rksz3MmZ0yeYu7F3
qiniu.key.secret=H-BUVFxvB1QoqKzv6abOCMT_NEzAPvz3pPodJo3Q
qiniu.bucket.header.name=zt-community-header
qiniu.bucket.header.url=qbbxkqk6q.bkt.clouddn.com
qiniu.bucket.share.name=zt-community-share
qiniu.bucket.share.url=qbbx267e5.bkt.clouddn.com
</code></pre></div></div>

<h3 id="从客户端分享到云服务器">从客户端分享到云服务器</h3>

<p>在进入设置页面后，为此次设置（上传图片），生成一个uploadToken，和fileName，传给页面。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@LoginRequired</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/setting"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getSettingPage</span><span class="o">(</span><span class="nc">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//生成上传文件名称</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">generateUUID</span><span class="o">();</span>
        <span class="c1">//设置响应信息</span>
        <span class="nc">StringMap</span> <span class="n">policy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringMap</span><span class="o">();</span>
        <span class="n">policy</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"returnBody"</span><span class="o">,</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="c1">//生成上传凭证</span>
        <span class="nc">Auth</span> <span class="n">auth</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">accessKey</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">uploadToken</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="na">uploadToken</span><span class="o">(</span><span class="n">headerBucketName</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="mi">3600</span><span class="o">,</span> <span class="n">policy</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"uploadToken"</span><span class="o">,</span> <span class="n">uploadToken</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"/site/setting"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>页面根据得到的token和filename，异步的使用post命令，将文件上传到云服务器</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#uploadForm</span><span class="dl">"</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="nx">upload</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">upload</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://upload-z2.qiniup.com</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">post</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">processData</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">contentType</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#uploadForm</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 更新头像访问路径</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
                    <span class="nx">CONTEXT_PATH</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/user/header/url</span><span class="dl">"</span><span class="p">,</span>
                    <span class="p">{</span><span class="dl">"</span><span class="s2">fileName</span><span class="dl">"</span><span class="p">:</span><span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[name='key']</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">()},</span>
                    <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">上传失败!</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>由上面js代码可以，如果上传成功，则访问更改用户头像的路径来更改header_url。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//User表中的headerUrl需要更新</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/header/url"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">updateHeaderUrl</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">fileName</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"文件名不能为空"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">headerBucketUrl</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="n">userService</span><span class="o">.</span><span class="na">updataHeader</span><span class="o">(</span><span class="n">hostHolder</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">url</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="从服务器分享到云服务器">从服务器分享到云服务器</h3>

<p>生成七牛云的服务器路径，返回给浏览器</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/share"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">share</span><span class="o">(</span><span class="nc">String</span> <span class="n">htmlUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//文件名随机</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">generateUUID</span><span class="o">();</span>
        <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="no">TOPIC_SHARE</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"htmlUrl"</span><span class="o">,</span> <span class="n">htmlUrl</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"suffix"</span><span class="o">,</span> <span class="s">".png"</span><span class="o">);</span>
        <span class="n">eventProducer</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
        <span class="c1">//返回访问路径</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"shareUrl"</span><span class="o">,</span> <span class="n">shareBucketUrl</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>处理分享（上传）事件</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="o">{</span><span class="no">TOPIC_SHARE</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShareMessage</span><span class="o">(</span><span class="nc">ConsumerRecord</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息内容为空"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Event</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"消息格式错误"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">htmlUrl</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"htmlUrl"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"fileName"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">suffix</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"suffix"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">wkImageCommand</span> <span class="o">+</span> <span class="s">" --quality 75 "</span> <span class="o">+</span> <span class="n">htmlUrl</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">wkImageStorage</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//Runtime的线程执行时间可能很长。需要经常检查是否生成了图片。</span>
            <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"生成图片成功"</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"生成图片失败"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">+</span> <span class="s">"  "</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">//eventConsummer有天然的抢占机制，只会有一个服务器执行</span>
        <span class="nc">UploadTask</span> <span class="n">uploadTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UploadTask</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">suffix</span><span class="o">);</span>
        <span class="nc">Future</span> <span class="n">future</span> <span class="o">=</span> <span class="n">taskScheduler</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="n">uploadTask</span><span class="o">,</span> <span class="mi">500</span><span class="o">);</span>
        <span class="n">uploadTask</span><span class="o">.</span><span class="na">setFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">UploadTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="c1">//文件名称</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">;</span>
        <span class="c1">//文件后缀</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">suffix</span><span class="o">;</span>
        <span class="c1">//开始时间</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">startTime</span><span class="o">;</span>
        <span class="c1">//上传次数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">uploadTimes</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFuture</span><span class="o">(</span><span class="nc">Future</span> <span class="n">future</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">future</span> <span class="o">=</span> <span class="n">future</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//启动任务的返回值</span>
        <span class="kd">private</span> <span class="nc">Future</span> <span class="n">future</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">UploadTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">suffix</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">//图片生成失败</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span> <span class="o">&gt;</span> <span class="mi">30000</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"执行时间过长 ："</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">);</span>
                <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//无法上传到七牛云</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">uploadTimes</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"无法上传到七牛云"</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">);</span>
                <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">wkImageStorage</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">;</span>
            <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"开始第%d次上传[%s]"</span><span class="o">,</span> <span class="o">++</span><span class="n">uploadTimes</span><span class="o">,</span> <span class="n">fileName</span><span class="o">));</span>
                <span class="c1">//设置响应信息</span>
                <span class="nc">StringMap</span> <span class="n">policy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringMap</span><span class="o">();</span>
                <span class="n">policy</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"returnBody"</span><span class="o">,</span> <span class="nc">CommunityUtil</span><span class="o">.</span><span class="na">getJSONString</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
                <span class="c1">//上传凭证</span>
                <span class="nc">Auth</span> <span class="n">auth</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">accessKey</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">uploadToken</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="na">uploadToken</span><span class="o">(</span><span class="n">shareBucketName</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="mi">3600</span><span class="o">,</span> <span class="n">policy</span><span class="o">);</span>
                <span class="c1">//指定机房</span>
                <span class="nc">UploadManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UploadManager</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">(</span><span class="nc">Zone</span><span class="o">.</span><span class="na">zone2</span><span class="o">()));</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">uploadToken</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"/image"</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                    <span class="c1">//处理响应结果</span>
                    <span class="nc">JSONObject</span> <span class="n">json</span> <span class="o">=</span> <span class="nc">JSONObject</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">bodyString</span><span class="o">());</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">json</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">json</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"code"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">json</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"code"</span><span class="o">).</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"0"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"第%d次上传失败[%s]"</span><span class="o">,</span> <span class="n">uploadTimes</span><span class="o">,</span> <span class="n">fileName</span><span class="o">));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"第%d次上传成功[%s]"</span><span class="o">,</span> <span class="n">uploadTimes</span><span class="o">,</span> <span class="n">fileName</span><span class="o">));</span>
                        <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">QiniuException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"第%d次上传失败[%s]"</span><span class="o">,</span> <span class="n">uploadTimes</span><span class="o">,</span> <span class="n">fileName</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"等待图片生成[%s]"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>

<h2 id="优化网站性能">优化网站性能</h2>

<p>加缓存，并使用压力测试工具，展示性能变化情况。</p>

<ul>
  <li>本地缓存
    <ul>
      <li>数据存到应用服务器上</li>
      <li>常用工具：Ehchche,Guava,Caffeine</li>
    </ul>
  </li>
  <li>分布式缓存
    <ul>
      <li>缓存数据存到NoSQL服务器上（有一些数据必须放在分布式服务器上）</li>
      <li>比本地缓存差（有网络开销）</li>
      <li>Redistribution，MenCache</li>
    </ul>
  </li>
  <li>多级缓存
    <ul>
      <li>一级缓存：本地，二级缓存：分布式</li>
      <li>总之尽力避免缓存雪崩，尽力避免访问database</li>
    </ul>
  </li>
</ul>

<p>目标：优化热门帖子列表（对它缓存）（按时间帖子列表经常变，所以要经常更新缓存，性能下降）</p>

<p>本地缓存：Caffeine（可以用Spring整合，但是不建议，因为Spring只用一个缓存管理器来管理所有缓存，所以缓存的大小/过期时间都是一样的，不便于自定义）</p>

<h3 id="使用caffeine">使用Caffeine</h3>

<h4 id="导入包后配置caffeine">导入包后，配置Caffeine</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#Caffeine
caffeine.posts.max-size=15
caffeine.posts.expire-seconds=180
</code></pre></div></div>

<h4 id="通常优化service">通常优化Service</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${caffeine.posts.max-size}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${caffeine.posts.expire-seconds}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">;</span>

    <span class="c1">//Caffeine核心接口：Cache, LoadingCache, AsyncLoadingCache(支持并发）</span>
    <span class="c1">//声明两个缓存：帖子列表</span>
    <span class="c1">//按照key缓存value</span>
    <span class="kd">private</span> <span class="nc">LoadingCache</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;&gt;</span> <span class="n">postListCache</span><span class="o">;</span>
    <span class="c1">//缓存帖子总数</span>
    <span class="kd">private</span> <span class="nc">LoadingCache</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">postRowsCache</span><span class="o">;</span>

    <span class="c1">//初始化的时候缓存</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//初始化帖子列表</span>
        <span class="n">postListCache</span> <span class="o">=</span> <span class="nc">Caffeine</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">maxSize</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expireAfterWrite</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">CacheLoader</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Nullable</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="nf">load</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="c1">//缓存中没有数据时，调用一下代码来查数据</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数错误"</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="nc">String</span><span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">params</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">params</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"参数错误"</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                        <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>

                        <span class="c1">//可以加二级缓存</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"load list from DB"</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="c1">//初始化帖子总数</span>
        <span class="n">postRowsCache</span> <span class="o">=</span> <span class="nc">Caffeine</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">maxSize</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expireAfterWrite</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="nc">CacheLoader</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Nullable</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">load</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Integer</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"load post rows from DB"</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPostRows</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DiscussPost</span><span class="o">&gt;</span> <span class="nf">findDiscussPosts</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span> <span class="kt">int</span> <span class="n">orderMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//只缓存首页数据，并且每次只缓存一页，并且只缓存热门帖子</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">orderMode</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">postListCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">limit</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"load list from DB"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPosts</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="n">orderMode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findDiscussPostsRows</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">postRowsCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"load post rows from DB"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">discussPostMapper</span><span class="o">.</span><span class="na">selectDiscussPostRows</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>插入30W条数据，用于压力测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initDataForTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">300000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">DiscussPost</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiscussPost</span><span class="o">();</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">111</span><span class="o">);</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"互联网求职暖春计划"</span><span class="o">);</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&amp;19届，拯救0 offer！"</span><span class="o">);</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="n">post</span><span class="o">.</span><span class="na">setScore</span><span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">2000</span><span class="o">);</span>
            <span class="n">postService</span><span class="o">.</span><span class="na">addDiscussPost</span><span class="o">(</span><span class="n">post</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCache</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">postService</span><span class="o">.</span><span class="na">findDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">postService</span><span class="o">.</span><span class="na">findDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">postService</span><span class="o">.</span><span class="na">findDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">postService</span><span class="o">.</span><span class="na">findDiscussPosts</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="使用jmeter进行压力测试">使用Jmeter进行压力测试</h4>

<p>优化前和优化后，吞吐量对比：速度大概增加了10倍</p>

<p>优化前：</p>

<p><a href="https://imgchr.com/i/yhTA5d"><img src="https://s3.ax1x.com/2021/02/19/yhTA5d.png" alt="yhTA5d.png" /></a></p>

<p>优化后：</p>

<p><a href="https://imgchr.com/i/yhTVPA"><img src="https://s3.ax1x.com/2021/02/19/yhTVPA.png" alt="yhTVPA.png" /></a></p>

</article>
      </div>
    </main>

    
  </body>
</html>